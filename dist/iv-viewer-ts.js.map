{"version":3,"file":"iv-viewer-ts.js","sources":["../src/util.ts","../src/ZoomAnimation.ts","../src/DimensionCalculator.ts","../src/MomentumCalculator.ts","../src/SliderCoordinator.ts","../src/ViewerHTMLTemplates.ts","../src/ImageLoader.ts","../src/EventManager.ts","../src/ImageViewerDOM.ts","../src/InteractionManager.ts","../src/Slider.ts","../src/ImageViewer.ts","../src/FullScreen.ts"],"sourcesContent":["// Constants for zoom behavior\n/** Zoom speed multiplier for mouse wheel interactions - higher values = faster zoom */\nexport const ZOOM_CONSTANT = 15;\n/** Maximum accumulated mouse wheel deltas before allowing default scroll behavior */\nexport const MOUSE_WHEEL_COUNT = 5;\n\nexport const noop = (() => {}) as () => void;\n\n/**\n * Easing function for smooth deceleration animations (ease-out quartic)\n * Creates a smooth slow-down effect, starting fast and ending slowly\n * Formula: -c * ((t/d - 1)^4 - 1) + b\n * @param currentTime - Current animation step/time\n * @param startValue - Initial value at start of animation\n * @param changedValue - Total change in value (target - start)\n * @param duration - Total duration in steps/time units\n * @returns Interpolated value at current time\n * @example\n * ```typescript\n * // Animate from 0 to 100 over 60 frames\n * for (let step = 0; step <= 60; step++) {\n *   const value = easeOutQuart(step, 0, 100, 60);\n *   console.log(value); // Smooth deceleration from 0 to 100\n * }\n * ```\n */\nexport function easeOutQuart(\n  currentTime: number,\n  startValue: number,\n  changedValue: number,\n  duration: number,\n): number {\n  currentTime /= duration;\n  currentTime -= 1;\n  return -changedValue * (currentTime * currentTime * currentTime * currentTime - 1) + startValue;\n}\n\n/**\n * Validates image URL to prevent XSS attacks via malicious protocols\n * Only allows http:, https:, and blob: protocols\n * @param url - URL to validate\n * @returns true if URL is safe to use, false otherwise\n * @security Prevents javascript:, data:text/html, and other XSS vectors\n * @example\n * ```typescript\n * isValidImageUrl('https://example.com/image.jpg') // true\n * isValidImageUrl('javascript:alert(1)') // false\n * isValidImageUrl('data:text/html,<script>alert(1)</script>') // false\n * ```\n */\nexport function isValidImageUrl(url: string | null | undefined): boolean {\n  if (!url) return false;\n\n  try {\n    const parsed = new URL(url, window.location.href);\n    const allowedProtocols = ['http:', 'https:', 'blob:'];\n    return allowedProtocols.includes(parsed.protocol);\n  } catch {\n    return false;\n  }\n}\n\ninterface CreateElementOptions {\n  tagName: string;\n  id?: string;\n  html?: string;\n  /** Set to true only for static, trusted markup defined in source code */\n  trustedHTML?: boolean;\n  className?: string;\n  src?: string;\n  style?: Record<string, string>; // REFACTOR: Changed from string to object for consistency (Issue C3.8)\n  child?: Node;\n  parent: Node;\n  insertBefore?: Node;\n}\n\n/**\n * Creates a DOM element with specified properties and inserts it into the DOM\n * @param options - Configuration object for element creation\n * @param options.tagName - HTML tag name (e.g., 'div', 'img')\n * @param options.id - Optional element ID\n * @param options.html - Optional inner HTML content (SECURITY: Only use with trusted static content!)\n * @param options.className - Optional CSS class names\n * @param options.src - Optional src attribute (for img elements, must be valid http/https/blob URL)\n * @param options.style - Optional inline CSS styles as object (e.g., { display: 'block', color: 'red' })\n * @param options.child - Optional child node to append\n * @param options.parent - Parent node to insert element into\n * @param options.insertBefore - Optional sibling node to insert before\n * @returns The created DOM element\n * @throws Error if image src URL has invalid protocol\n * @security innerHTML is used without sanitization - only pass trusted static HTML\n * @security Image URLs are validated to prevent XSS via javascript: or data: protocols\n */\nexport function createElement(options: CreateElementOptions) {\n  const elem = document.createElement(options.tagName);\n  if (options.id) elem.id = options.id;\n\n  // SECURITY: Only allow innerHTML when explicitly marked as trusted static markup\n  if (options.html) {\n    if (!options.trustedHTML) {\n      throw new Error('innerHTML requires trustedHTML=true to avoid XSS risks');\n    }\n    elem.innerHTML = options.html;\n  }\n\n  if (options.className) elem.className = options.className;\n\n  // SECURITY FIX: Validate image URLs to prevent XSS\n  if (options.src && elem instanceof HTMLImageElement) {\n    if (!isValidImageUrl(options.src)) {\n      throw new Error(`Invalid or unsafe image URL protocol: ${options.src}`);\n    }\n    elem.setAttribute('src', options.src);\n  }\n\n  // REFACTOR: Use setStyle() for consistent style handling (Issues C3.8, A1.10)\n  if (options.style) setStyle(elem, options.style);\n  if (options.child) elem.appendChild(options.child);\n\n  // Insert before\n  if (options.insertBefore) {\n    options.parent.insertBefore(elem, options.insertBefore);\n\n    // Standard append\n  } else {\n    options.parent.appendChild(elem);\n  }\n\n  return elem;\n}\n\n// method to add class\nexport function addClass(el: HTMLElement, className: string): void {\n  const classNameAry = className.split(' ');\n\n  if (classNameAry.length > 1) {\n    classNameAry.forEach((classItem) => addClass(el, classItem));\n  } else if (el.classList) {\n    el.classList.add(className);\n  } else {\n    el.className += ` ${className}`;\n  }\n}\n\n// method to remove class\nexport function removeClass(el: HTMLElement, className: string): void {\n  const classNameAry = className.split(' ');\n\n  if (classNameAry.length > 1) {\n    classNameAry.forEach((classItem) => removeClass(el, classItem));\n  } else if (el.classList) {\n    el.classList.remove(className);\n  } else {\n    // P3-2 FIX: Simplified regex - className is always a single class at this point\n    el.className = el.className.replace(new RegExp(`(^|\\\\s)${className}(\\\\s|$)`, 'g'), ' ').trim();\n  }\n}\n\n// function to check if image is loaded\nexport function imageLoaded(img: HTMLImageElement): boolean {\n  return img.complete && (typeof img.naturalWidth === 'undefined' || img.naturalWidth !== 0);\n}\n\nexport function toArray(\n  list: Node | NodeList | HTMLCollectionOf<HTMLElement>,\n): (HTMLCollectionOf<Element> | Element)[] {\n  if (list instanceof HTMLElement) {\n    return [list];\n  } else if (list instanceof NodeList || list instanceof HTMLCollection) {\n    return Array.prototype.slice.call(list);\n  } else {\n    return [];\n  }\n}\n\ntype ObjectWithStringKeys = Record<string, string | number | boolean | object | null | undefined>;\nexport function assign(\n  target: ObjectWithStringKeys,\n  ...rest: ObjectWithStringKeys[]\n): ObjectWithStringKeys {\n  rest.forEach((obj) => {\n    Object.keys(obj).forEach((key) => {\n      target[key] = obj[key];\n    });\n  });\n  return target;\n}\n\n/**\n * Gets the computed style value of a CSS property from an element\n * REFACTOR: Extracted from css() for single responsibility (Issue A1.10)\n * @param element - Element to get style from\n * @param property - CSS property name (kebab-case or camelCase)\n * @returns The computed style value, or empty string if not found\n * @example\n * ```typescript\n * const width = getStyle(element, 'width'); // \"100px\"\n * const bgColor = getStyle(element, 'background-color'); // \"rgb(255, 0, 0)\"\n * ```\n */\nexport function getStyle(element: Element, property: string): string {\n  const styles = window.getComputedStyle(element);\n  // Try kebab-case first (e.g., 'border-radius')\n  const value = styles.getPropertyValue(property);\n  if (value) return value;\n  // Fallback: access as property directly (e.g., 'width', 'height')\n  type StyleKey = keyof CSSStyleDeclaration;\n  if (property in styles) {\n    const propValue = styles[property as StyleKey];\n    return typeof propValue === 'string' ? propValue : String(propValue);\n  }\n  return '';\n}\n\n/**\n * Parses a CSS style property value as a float number\n * REFACTOR: Consistent parseFloat helper with fallback (Issue A1.13)\n * @param element - Element to read style from\n * @param property - CSS property name\n * @param defaultValue - Value to return if parsing fails (default: 0)\n * @returns Parsed float value or default value\n * @example\n * ```typescript\n * const left = parseStyleFloat(element, 'left'); // 100 (from \"100px\")\n * const top = parseStyleFloat(element, 'top', 50); // 50 if not set\n * ```\n */\nexport function parseStyleFloat(element: HTMLElement, property: string, defaultValue = 0): number {\n  const value = getStyle(element, property);\n  const parsed = parseFloat(value);\n  return isNaN(parsed) ? defaultValue : parsed;\n}\n\n/**\n * Sets CSS styles on one or more HTML elements\n * REFACTOR: Extracted from css() for single responsibility (Issue A1.10)\n * @param elements - Single element, NodeList, or HTMLCollection to style\n * @param properties - CSS properties as key-value pairs\n * @security Sanitizes CSS values to prevent CSS injection attacks\n * @example\n * ```typescript\n * setStyle(element, { width: '100px', display: 'block' });\n * setStyle(document.querySelectorAll('.item'), { color: 'red' });\n * ```\n */\nexport function setStyle(\n  elements: Node | NodeList | HTMLCollectionOf<HTMLElement>,\n  properties: Record<string, string>,\n): void {\n  const elmArray = toArray(elements);\n\n  elmArray.forEach((element) => {\n    if (element instanceof HTMLElement) {\n      Object.keys(properties).forEach((key: string) => {\n        const value = properties[key];\n        const stringValue = String(value);\n\n        // SECURITY: Block obvious scriptable CSS payloads\n        const lower = stringValue.toLowerCase();\n        if (lower.includes('javascript:') || lower.includes('expression(')) {\n          throw new Error('Blocked unsafe CSS value');\n        }\n\n        // Basic sanitization to strip angle/quote characters from inline CSS values\n        const sanitizedValue = stringValue.replace(/[<>'\"]/g, '');\n\n        element.style.setProperty(key, sanitizedValue);\n      });\n    }\n  });\n}\n\n//Node | NodeList | HTMLCollectionOf<HTMLElement>\n/**\n * @deprecated Use getStyle() or setStyle() instead for better type safety and clarity\n * Legacy function that handles both getting and setting CSS properties\n * REFACTOR: Kept for backward compatibility, delegates to getStyle/setStyle (Issue A1.10)\n */\nexport function css(\n  elements: Node | NodeList | HTMLCollectionOf<HTMLElement>,\n  properties: string | Record<string, string>,\n): string | undefined {\n  if (typeof properties === 'string') {\n    // GET operation - delegate to getStyle\n    const elmArray = toArray(elements);\n    const element = elmArray[0];\n    if (element instanceof Element) {\n      return getStyle(element, properties);\n    }\n    return undefined;\n  }\n\n  // SET operation - delegate to setStyle\n  setStyle(elements, properties);\n  return undefined;\n}\n\nexport function removeCss(element: HTMLElement, property: string): void {\n  element.style.removeProperty(property);\n}\n\n/**\n * Wraps an element with a new parent element\n * Replaces the element in the DOM tree with a wrapper containing the element\n * @param element - Element to wrap\n * @param options - Wrapper configuration\n * @param options.tag - HTML tag for wrapper (default: 'div')\n * @param options.className - Optional CSS class for wrapper\n * @param options.id - Optional ID for wrapper\n * @param options.style - Optional inline styles for wrapper\n * @returns The wrapper element\n * @throws Error if element has no parent node\n */\nexport function wrap(\n  element: HTMLElement,\n  {\n    tag = 'div',\n    className,\n    id,\n    style,\n  }: {\n    tag?: string;\n    className?: string;\n    id?: string;\n    style?: { display?: string; overflow?: string };\n  },\n): HTMLElement {\n  const wrapper = document.createElement(tag);\n  if (className) wrapper.className = className;\n  if (id) wrapper.id = id;\n  if (style) {\n    if (style.display) wrapper.style.display = style.display;\n    if (style.overflow) wrapper.style.overflow = style.overflow;\n  }\n\n  const parentNode = element.parentNode;\n  if (!parentNode) {\n    throw new Error('element does not have a parent node');\n  }\n  parentNode.insertBefore(wrapper, element);\n  parentNode.removeChild(element);\n  wrapper.appendChild(element);\n  return wrapper;\n}\n\nexport function unwrap(element: HTMLElement) {\n  const parent = element.parentNode as HTMLElement;\n\n  if (parent && parent !== document.body) {\n    parent.parentNode?.insertBefore(element, parent);\n    parent.parentNode?.removeChild(parent);\n  }\n}\n\nexport function remove(elements: NodeListOf<Element> | Element | HTMLElement): void {\n  const elmArray = toArray(elements);\n  elmArray.forEach((element: Element | HTMLCollectionOf<Element>) => {\n    if (element instanceof Element && element.parentNode) {\n      element.parentNode.removeChild(element);\n    }\n  });\n}\n\nexport function clamp(num: number, min: number, max: number): number {\n  return Math.min(Math.max(num, min), max);\n}\n\n/**\n * Attaches event listener(s) to an element and returns a cleanup function\n * Supports attaching multiple event types with a single handler\n * @param element - DOM element to attach events to (can be Window, Document, or HTMLElement)\n * @param events - Event name or array of event names (e.g., 'click' or ['touchstart', 'mousedown'])\n * @param handler - Event handler function\n * @returns Cleanup function that removes all attached event listeners\n * @example\n * ```typescript\n * const removeListener = assignEvent(button, ['click', 'touchend'], handleClick);\n * // Later: removeListener(); // Removes both event listeners\n * ```\n */\nexport function assignEvent<K extends keyof HTMLElementEventMap>(\n  element: EventTarget,\n  events: K | K[],\n  handler: (event: HTMLElementEventMap[K]) => void,\n): () => void;\nexport function assignEvent(\n  element: EventTarget,\n  events: string | string[],\n  handler: EventListener,\n): () => void;\nexport function assignEvent(\n  element: EventTarget,\n  events: string | string[],\n  handler: EventListener,\n): () => void {\n  const eventList = Array.isArray(events) ? events : [events];\n  eventList.forEach((event) => element.addEventListener(event, handler));\n\n  return () => {\n    eventList.forEach((event) => element.removeEventListener(event, handler));\n  };\n}\n\n/**\n * Calculates Euclidean distance between two touch points\n * Used for pinch-to-zoom gesture detection\n * @param touches - TouchList containing at least 2 touch points\n * @returns Distance in pixels between first two touch points\n * @example\n * ```typescript\n * element.addEventListener('touchmove', (e) => {\n *   if (e.touches.length === 2) {\n *     const distance = getTouchPointsDistance(e.touches);\n *     console.log('Pinch distance:', distance);\n *   }\n * });\n * ```\n */\nexport function getTouchPointsDistance(touches: TouchList): number {\n  const touch0 = touches[0];\n  const touch1 = touches[1];\n  return Math.sqrt(\n    Math.pow(touch1.pageX - touch0.pageX, 2) + Math.pow(touch1.pageY - touch0.pageY, 2),\n  );\n}\n","import { easeOutQuart } from './util';\n\n/**\n * Zoom animation frame result\n * Contains calculated zoom level and position for a single animation frame\n */\nexport interface ZoomFrame {\n  /** Current zoom percentage for this frame */\n  zoom: number;\n  /** Image width in pixels at current zoom */\n  width: number;\n  /** Image height in pixels at current zoom */\n  height: number;\n  /** Left position constrained to bounds */\n  left: number;\n  /** Top position constrained to bounds */\n  top: number;\n}\n\n/**\n * Bounding box constraints for zoom positioning\n */\nexport interface ZoomBounds {\n  /** Base left position (centered at 100% zoom) */\n  baseLeft: number;\n  /** Base top position (centered at 100% zoom) */\n  baseTop: number;\n  /** Right boundary (container width - baseLeft) */\n  baseRight: number;\n  /** Bottom boundary (container height - baseTop) */\n  baseBottom: number;\n}\n\n/**\n * Encapsulates zoom animation calculation logic\n * REFACTOR: Extracted from ImageViewer.zoom() for better separation (Issue A1.2/C3.3)\n *\n * Handles:\n * - Eased interpolation between zoom levels\n * - Position calculation to keep zoom point fixed\n * - Boundary constraint to prevent showing empty space\n *\n * @example\n * ```typescript\n * const animation = new ZoomAnimation({\n *   currentZoom: 100,\n *   targetZoom: 200,\n *   currentLeft: 50,\n *   currentTop: 50,\n *   zoomPoint: { x: 400, y: 300 },\n *   imageDim: { w: 800, h: 600 },\n *   bounds: { baseLeft: 100, baseTop: 50, baseRight: 900, baseBottom: 650 },\n *   totalFrames: 16\n * });\n *\n * // Get frame data for each animation step\n * const frame = animation.getFrame(5);\n * // frame = { zoom: 150, width: 1200, height: 900, left: 25, top: 25 }\n * ```\n */\nexport class ZoomAnimation {\n  private readonly currentZoom: number;\n  private readonly targetZoom: number;\n  private readonly currentLeft: number;\n  private readonly currentTop: number;\n  private readonly zoomPoint: { x: number; y: number };\n  private readonly imageDim: { w: number; h: number };\n  private readonly bounds: ZoomBounds;\n  private readonly totalFrames: number;\n\n  constructor(config: {\n    currentZoom: number;\n    targetZoom: number;\n    currentLeft: number;\n    currentTop: number;\n    zoomPoint: { x: number; y: number };\n    imageDim: { w: number; h: number };\n    bounds: ZoomBounds;\n    totalFrames: number;\n  }) {\n    this.currentZoom = config.currentZoom;\n    this.targetZoom = config.targetZoom;\n    this.currentLeft = config.currentLeft;\n    this.currentTop = config.currentTop;\n    this.zoomPoint = config.zoomPoint;\n    this.imageDim = config.imageDim;\n    this.bounds = config.bounds;\n    this.totalFrames = config.totalFrames;\n  }\n\n  /**\n   * Calculates zoom frame data for a specific animation step\n   * Uses easeOutQuart easing for smooth deceleration\n   * @param step - Current animation step (0 to totalFrames)\n   * @returns Frame data with zoom level and constrained position\n   */\n  getFrame(step: number): ZoomFrame {\n    // Calculate interpolated zoom using easing function\n    const tickZoom = easeOutQuart(\n      step,\n      this.currentZoom,\n      this.targetZoom - this.currentZoom,\n      this.totalFrames,\n    );\n\n    // Calculate new dimensions at target zoom\n    const width = (this.imageDim.w * tickZoom) / 100;\n    const height = (this.imageDim.h * tickZoom) / 100;\n\n    // Calculate position to keep zoom point fixed\n    const position = this.calculatePosition(tickZoom);\n\n    // Constrain position to prevent showing empty space\n    const constrainedPosition = this.constrainToBounds(position, width, height);\n\n    return {\n      zoom: tickZoom,\n      width,\n      height,\n      left: constrainedPosition.left,\n      top: constrainedPosition.top,\n    };\n  }\n\n  /**\n   * Calculates new image position to keep zoom point fixed during zoom\n   * Uses ratio-based calculation: newPos = -((point - currentPos) * ratio - point)\n   * @param tickZoom - Current zoom level for this frame\n   * @returns Unconstrained position\n   */\n  private calculatePosition(tickZoom: number): { left: number; top: number } {\n    const ratio = tickZoom / this.currentZoom;\n\n    const left = -((this.zoomPoint.x - this.currentLeft) * ratio - this.zoomPoint.x);\n    const top = -((this.zoomPoint.y - this.currentTop) * ratio - this.zoomPoint.y);\n\n    return { left, top };\n  }\n\n  /**\n   * Constrains position to prevent showing empty space around image\n   * Ensures image covers container when zoomed in\n   * @param position - Unconstrained position from calculatePosition\n   * @param width - Image width at current zoom\n   * @param height - Image height at current zoom\n   * @returns Constrained position\n   */\n  private constrainToBounds(\n    position: { left: number; top: number },\n    width: number,\n    height: number,\n  ): { left: number; top: number } {\n    let { left, top } = position;\n    const { baseLeft, baseTop, baseRight, baseBottom } = this.bounds;\n\n    // Constrain left and top (prevent image from moving too far right/down)\n    left = Math.min(left, baseLeft);\n    top = Math.min(top, baseTop);\n\n    // Constrain right edge (prevent showing empty space on right)\n    if (left + width < baseRight) {\n      left = baseRight - width;\n    }\n\n    // Constrain bottom edge (prevent showing empty space on bottom)\n    if (top + height < baseBottom) {\n      top = baseBottom - height;\n    }\n\n    return { left, top };\n  }\n}\n","/**\n * DimensionCalculator\n * Handles all dimension calculations for the image viewer\n * Extracted from ImageViewer to improve Single Responsibility Principle (Issue C3.1)\n */\n\nimport { Dimensions } from './types';\n\nexport interface DimensionCalculationParams {\n  /** Container dimensions */\n  containerDim: Dimensions;\n  /** Natural width of the image */\n  naturalWidth: number;\n  /** Natural height of the image */\n  naturalHeight: number;\n  /** Snap view dimensions */\n  snapViewDim: Dimensions;\n}\n\nexport interface CalculatedDimensions {\n  /** Fitted image dimensions */\n  imageDim: Dimensions;\n  /** Snap image dimensions */\n  snapImageDim: Dimensions;\n}\n\n/**\n * DimensionCalculator class\n * Responsible for calculating fitted image and snap image dimensions\n */\nexport class DimensionCalculator {\n  /**\n   * Calculate fitted image dimensions that fit within container while maintaining aspect ratio\n   * @param containerDim - Container dimensions\n   * @param naturalWidth - Natural width of the image\n   * @param naturalHeight - Natural height of the image\n   * @returns Calculated image dimensions that fit within container\n   */\n  static calculateFittedImageDimensions(\n    containerDim: Dimensions,\n    naturalWidth: number,\n    naturalHeight: number,\n  ): Dimensions {\n    const ratio = naturalWidth / naturalHeight;\n\n    // Determine optimal width based on container orientation and aspect ratio\n    const imgWidth =\n      (naturalWidth > naturalHeight && containerDim.h >= containerDim.w) ||\n      ratio * containerDim.h > containerDim.w\n        ? containerDim.w\n        : ratio * containerDim.h;\n\n    return {\n      w: imgWidth,\n      h: imgWidth / ratio,\n    };\n  }\n\n  /**\n   * Calculate snap image dimensions that fit within snap view while maintaining aspect ratio\n   * @param imageDim - Full image dimensions\n   * @param snapViewDim - Snap view container dimensions\n   * @returns Calculated snap image dimensions\n   */\n  static calculateSnapImageDimensions(imageDim: Dimensions, snapViewDim: Dimensions): Dimensions {\n    // Scale image to fit snap view based on orientation\n    const snapWidth =\n      imageDim.w > imageDim.h ? snapViewDim.w : (imageDim.w * snapViewDim.h) / imageDim.h;\n\n    const snapHeight =\n      imageDim.h > imageDim.w ? snapViewDim.h : (imageDim.h * snapViewDim.w) / imageDim.w;\n\n    return {\n      w: snapWidth,\n      h: snapHeight,\n    };\n  }\n\n  /**\n   * Calculate all dimensions needed for the image viewer\n   * @param params - Calculation parameters\n   * @returns Calculated dimensions for image and snap image\n   */\n  static calculateAllDimensions(params: DimensionCalculationParams): CalculatedDimensions {\n    const { containerDim, naturalWidth, naturalHeight, snapViewDim } = params;\n\n    // Calculate fitted image dimensions\n    const imageDim = this.calculateFittedImageDimensions(containerDim, naturalWidth, naturalHeight);\n\n    // Calculate snap image dimensions\n    const snapImageDim = this.calculateSnapImageDimensions(imageDim, snapViewDim);\n\n    return {\n      imageDim,\n      snapImageDim,\n    };\n  }\n\n  /**\n   * Calculate snap handle dimensions based on container and image dimensions\n   * @param containerDim - Container dimensions\n   * @param imageDim - Current image dimensions (may be zoomed)\n   * @param snapImageDim - Snap image dimensions\n   * @returns Snap handle dimensions\n   */\n  static calculateSnapHandleDimensions(\n    containerDim: Dimensions,\n    imageDim: Dimensions,\n    snapImageDim: Dimensions,\n  ): Dimensions {\n    // Snap handle represents the visible viewport area relative to the full image\n    const handleWidth =\n      imageDim.w !== 0 ? (snapImageDim.w * containerDim.w) / imageDim.w : containerDim.w;\n    const handleHeight =\n      imageDim.h !== 0 ? (snapImageDim.h * containerDim.h) / imageDim.h : containerDim.h;\n\n    return {\n      w: handleWidth,\n      h: handleHeight,\n    };\n  }\n}\n","/**\n * MomentumCalculator\n * Handles momentum calculation and threshold detection for slider animations\n * Extracted from ImageViewer to improve Single Responsibility Principle (Issue C3.1/A1.3)\n */\n\nimport { easeOutQuart } from './util';\n\nexport interface MomentumConfig {\n  /** Threshold in pixels for momentum to be applied */\n  thresholdPx: number;\n  /** Velocity multiplication factor for momentum */\n  velocityFactor: number;\n  /** Number of animation frames for momentum */\n  animationFrames: number;\n}\n\nexport interface MomentumDelta {\n  xDiff: number;\n  yDiff: number;\n}\n\nexport interface MomentumFrame {\n  /** Calculated X position for this frame */\n  positionX: number;\n  /** Calculated Y position for this frame */\n  positionY: number;\n  /** Whether animation should continue */\n  shouldContinue: boolean;\n}\n\n/**\n * MomentumCalculator class\n * Provides momentum calculation utilities for smooth pan animations\n */\nexport class MomentumCalculator {\n  /**\n   * Calculate momentum delta from position samples\n   * @param positions - Array of position samples [oldest, newest]\n   * @returns Delta between positions\n   */\n  static calculateDelta(positions: Array<{ x: number; y: number }>): MomentumDelta {\n    if (positions.length < 2) {\n      return { xDiff: 0, yDiff: 0 };\n    }\n\n    return {\n      xDiff: positions[1].x - positions[0].x,\n      yDiff: positions[1].y - positions[0].y,\n    };\n  }\n\n  /**\n   * Check if momentum threshold is exceeded\n   * @param xDiff - X axis movement delta\n   * @param yDiff - Y axis movement delta\n   * @param thresholdPx - Threshold in pixels\n   * @returns True if momentum should be applied\n   */\n  static shouldApplyMomentum(xDiff: number, yDiff: number, thresholdPx: number): boolean {\n    return Math.abs(xDiff) > thresholdPx || Math.abs(yDiff) > thresholdPx;\n  }\n\n  /**\n   * Calculate position for a momentum animation frame\n   * @param step - Current animation step (1-based)\n   * @param startPos - Starting position {dx, dy}\n   * @param delta - Momentum delta {xDiff, yDiff}\n   * @param config - Momentum configuration\n   * @returns Calculated frame data\n   */\n  static calculateMomentumFrame(\n    step: number,\n    startPos: { dx: number; dy: number },\n    delta: MomentumDelta,\n    config: MomentumConfig,\n  ): MomentumFrame {\n    const { xDiff, yDiff } = delta;\n    const { velocityFactor, animationFrames } = config;\n\n    // Calculate position using easing function\n    const xOffset = easeOutQuart(\n      step,\n      xDiff * velocityFactor,\n      -xDiff * velocityFactor,\n      animationFrames,\n    );\n\n    const yOffset = easeOutQuart(\n      step,\n      yDiff * velocityFactor,\n      -yDiff * velocityFactor,\n      animationFrames,\n    );\n\n    return {\n      positionX: startPos.dx + xOffset,\n      positionY: startPos.dy + yOffset,\n      shouldContinue: step < animationFrames,\n    };\n  }\n\n  /**\n   * Convert image position to snap slider coordinates\n   * @param position - Image position {x, y}\n   * @param imageDim - Image dimensions\n   * @param snapImageDim - Snap image dimensions\n   * @returns Snap slider coordinates\n   */\n  static convertToSnapCoordinates(\n    position: { x: number; y: number },\n    imageDim: { w: number; h: number },\n    snapImageDim: { w: number; h: number },\n  ): { dx: number; dy: number } {\n    // Prevent division by zero\n    const dx = imageDim.w !== 0 ? -(position.x * snapImageDim.w) / imageDim.w : 0;\n    const dy = imageDim.h !== 0 ? -(position.y * snapImageDim.h) / imageDim.h : 0;\n\n    return { dx, dy };\n  }\n}\n","import type Slider from './Slider';\n\n/**\n * Coordinates synchronization between image slider and snap slider\n * REFACTOR: Extracted to decouple sliders from directly calling each other (Issue C3.5)\n *\n * The image slider moves the main image, and the snap slider (minimap) needs to stay in sync.\n * Previously, the image slider directly called snap slider methods, creating tight coupling.\n * This coordinator acts as a mediator, handling the synchronization logic.\n *\n * @example\n * ```typescript\n * const coordinator = new SliderCoordinator(snapSlider, {\n *   getImageDim: () => this._getImageCurrentDim(),\n *   getSnapImageDim: () => this._state.snapImageDim\n * });\n *\n * // In image slider onMove callback\n * coordinator.syncSnapSliderPosition(position);\n * ```\n */\nexport class SliderCoordinator {\n  private snapSlider: Slider;\n  private getImageDim: () => { w: number; h: number };\n  private getSnapImageDim: () => { w: number; h: number };\n\n  constructor(\n    snapSlider: Slider,\n    config: {\n      getImageDim: () => { w: number; h: number };\n      getSnapImageDim: () => { w: number; h: number };\n    },\n  ) {\n    this.snapSlider = snapSlider;\n    this.getImageDim = config.getImageDim;\n    this.getSnapImageDim = config.getSnapImageDim;\n  }\n\n  /**\n   * Notifies snap slider that image panning has started\n   * Triggers snap slider's onStart callback to initialize state\n   * @param event - Event that triggered the image pan start\n   */\n  notifyPanStart(event: Event): void {\n    // Notify snap slider with dummy position (just to trigger initialization)\n    this.snapSlider.onStart(event, { x: 0, y: 0 });\n  }\n\n  /**\n   * Synchronizes snap slider position when image is moved\n   * Converts image delta to snap slider delta using dimension ratios\n   * REFACTOR: Uses updatePosition instead of creating dummy events (Issue A1.12)\n   * @param imagePosition - Image movement delta and current position\n   */\n  syncSnapSliderPosition(imagePosition: { dx: number; dy: number; mx: number; my: number }): void {\n    const imageDim = this.getImageDim();\n    const snapImageDim = this.getSnapImageDim();\n\n    // Convert image delta to snap slider delta using dimension ratio\n    // Snap slider moves in opposite direction (when image moves right, snap moves left)\n    const dx = imageDim.w !== 0 ? (-imagePosition.dx * snapImageDim.w) / imageDim.w : 0;\n    const dy = imageDim.h !== 0 ? (-imagePosition.dy * snapImageDim.h) / imageDim.h : 0;\n\n    // Update snap slider with converted position (no dummy event needed)\n    this.snapSlider.updatePosition({\n      dx,\n      dy,\n      mx: 0, // Mouse position not relevant for sync\n      my: 0,\n    });\n  }\n\n  /**\n   * Gets reference to snap slider for momentum animation\n   * This is needed because momentum animation updates snap slider directly\n   * @returns The snap slider instance\n   */\n  getSnapSlider(): Slider {\n    return this.snapSlider;\n  }\n}\n","/**\n * ViewerHTMLTemplates - HTML template generation for ImageViewer\n * REFACTOR: Extract HTML template generation from ImageViewer (Issue C3.1)\n *\n * Centralizes all HTML template generation with static methods\n * Improves testability and maintainability of template strings\n *\n * @example\n * ```typescript\n * const html = ViewerHTMLTemplates.createViewerHTML(true);\n * const zoomIn = ViewerHTMLTemplates.createZoomInButton();\n * ```\n */\nexport class ViewerHTMLTemplates {\n  /**\n   * Creates the zoom-in button HTML\n   * Only generated if hasZoomButtons option is true\n   *\n   * @param hasZoomButtons - Whether to create the button\n   * @returns HTML string for zoom-in button or empty string\n   *\n   * @example\n   * ```typescript\n   * const btn = ViewerHTMLTemplates.createZoomInButton(true);\n   * // '<div class=\"iv-button-zoom--in\" role=\"button\"></div>'\n   * ```\n   */\n  static createZoomInButton(hasZoomButtons: boolean): string {\n    return hasZoomButtons ? `<div class=\"iv-button-zoom--in\" role=\"button\"></div>` : '';\n  }\n\n  /**\n   * Creates the zoom-out button HTML\n   * Only generated if hasZoomButtons option is true\n   *\n   * @param hasZoomButtons - Whether to create the button\n   * @returns HTML string for zoom-out button or empty string\n   *\n   * @example\n   * ```typescript\n   * const btn = ViewerHTMLTemplates.createZoomOutButton(true);\n   * // '<div class=\"iv-button-zoom--out\" role=\"button\"></div>'\n   * ```\n   */\n  static createZoomOutButton(hasZoomButtons: boolean): string {\n    return hasZoomButtons ? `<div class=\"iv-button-zoom--out\" role=\"button\"></div>` : '';\n  }\n\n  /**\n   * Creates the complete image viewer HTML structure\n   * Includes loader, snap view, zoom controls, and image container\n   *\n   * @param hasZoomButtons - Whether to include zoom in/out buttons\n   * @returns Complete HTML string for the viewer\n   *\n   * @example\n   * ```typescript\n   * const html = ViewerHTMLTemplates.createViewerHTML(true);\n   * container.innerHTML = html;\n   * ```\n   */\n  static createViewerHTML(hasZoomButtons: boolean): string {\n    const zoomInBtn = this.createZoomInButton(hasZoomButtons);\n    const zoomOutBtn = this.createZoomOutButton(hasZoomButtons);\n    const zoomActionsClass = hasZoomButtons ? 'iv-zoom-actions--has-buttons' : '';\n\n    return `\n  <div class=\"iv-loader\"></div>\n  <div class=\"iv-snap-view\">\n    <div class=\"iv-snap-image-wrap\">\n      <div class=\"iv-snap-handle\"></div>\n    </div>\n    <div class=\"iv-zoom-actions ${zoomActionsClass}\">\n      ${zoomInBtn}\n      <div class=\"iv-zoom-slider\">\n        <div class=\"iv-zoom-handle\"></div>\n      </div>\n      ${zoomOutBtn}\n    </div>\n  </div>\n  <div class=\"iv-image-view\" >\n    <div class=\"iv-image-wrap\" ></div>\n  </div>\n`;\n  }\n}\n","import { createElement, imageLoaded, setStyle, remove, assignEvent, isValidImageUrl } from './util';\nimport type { ViewerElements, EventRemover } from './types';\n\n/**\n * ImageLoader - Handles image loading operations for ImageViewer\n * REFACTOR: Extract image loading logic from ImageViewer (Issue C3.1)\n *\n * Manages:\n * - Loading main and high-resolution images\n * - Race condition prevention with load counter\n * - Loader UI visibility\n * - Image load success/error callbacks\n * - Image element creation\n *\n * @example\n * ```typescript\n * const loader = new ImageLoader(\n *   elements,\n *   listeners,\n *   (loadId) => this._handleImageLoadSuccess(loadId),\n *   (loadId, error) => this._handleImageLoadError(loadId, error)\n * );\n *\n * const loadId = loader.load('image.jpg', 'image-hires.jpg');\n * ```\n */\nexport class ImageLoader {\n  private loadCounter: number = 0;\n  private activeLoads: Map<string, EventRemover> = new Map();\n\n  constructor(\n    private elements: Partial<ViewerElements>,\n    private onLoadSuccess: (loadId: number) => void,\n    private onLoadError: (loadId: number, error: Event | ErrorEvent) => void,\n  ) {}\n\n  /**\n   * Loads an image with optional high-resolution version\n   * Returns a load ID for race condition tracking\n   *\n   * @param imageSrc - Main image source URL\n   * @param hiResImageSrc - Optional high-resolution image source\n   * @returns Load operation ID\n   *\n   * @example\n   * ```typescript\n   * const loadId = loader.load('thumb.jpg', 'full.jpg');\n   * ```\n   */\n  load(imageSrc: string, hiResImageSrc?: string): number {\n    const { container } = this.elements;\n    if (!container) {\n      throw new Error('Container element not found');\n    }\n\n    // Cancel previous load operations\n    this._cancelPreviousLoads();\n\n    // Increment load counter for race condition tracking\n    const loadId = ++this.loadCounter;\n\n    const ivLoader = container.querySelector('.iv-loader');\n    if (!ivLoader) {\n      throw new Error('Loader element not found');\n    }\n\n    // Remove old images\n    remove(container.querySelectorAll('.iv-snap-image, .iv-image'));\n\n    // Validate image URL\n    if (!isValidImageUrl(imageSrc)) {\n      throw new Error(`Invalid or unsafe image URL: ${imageSrc}`);\n    }\n\n    // Create image elements\n    const { snapImage, image } = this._createImageElements(imageSrc);\n\n    // Store image references\n    this.elements.image = image;\n    this.elements.snapImage = snapImage;\n\n    // Show loader\n    setStyle(ivLoader, { display: 'block' });\n\n    // Hide image until loaded\n    setStyle(image, { visibility: 'hidden' });\n\n    // Set up load handlers\n    const onImageLoad = () => {\n      this._handleLoadSuccess(loadId, hiResImageSrc);\n    };\n\n    const onImageError = (e: Event | ErrorEvent) => {\n      this._handleLoadError(loadId, e);\n    };\n\n    if (imageLoaded(image)) {\n      onImageLoad();\n    } else {\n      const imageLoadRemover = assignEvent(image, 'load', onImageLoad);\n      const imageErrorRemover = assignEvent(image, 'error', onImageError);\n\n      this.activeLoads.set('imageLoad', imageLoadRemover);\n      this.activeLoads.set('imageError', imageErrorRemover);\n    }\n\n    return loadId;\n  }\n\n  /**\n   * Loads a high-resolution version of the image\n   * Replaces the current image once loaded\n   *\n   * @param hiResImageSrc - High-resolution image URL\n   *\n   * @example\n   * ```typescript\n   * loader.loadHighRes('image-4k.jpg');\n   * ```\n   */\n  loadHighRes(hiResImageSrc: string): void {\n    const { imageWrap } = this.elements;\n    if (!imageWrap) {\n      throw new Error('Image wrap element not found');\n    }\n\n    const lowResImg = this.elements.image;\n    if (!lowResImg) {\n      throw new Error('Low-res image not found');\n    }\n\n    // Create high-res image\n    const hiResImage = createElement({\n      tagName: 'img',\n      className: 'iv-image iv-large-image',\n      src: hiResImageSrc,\n      parent: imageWrap,\n    });\n\n    // Copy styles from low-res to high-res image\n    const lowResStyles = window.getComputedStyle(lowResImg);\n    setStyle(hiResImage, {\n      width: lowResStyles.width,\n      height: lowResStyles.height,\n      left: lowResStyles.left,\n      top: lowResStyles.top,\n      maxWidth: lowResStyles.maxWidth,\n      maxHeight: lowResStyles.maxHeight,\n      visibility: lowResStyles.visibility,\n    });\n\n    const onHighResImageLoad = () => {\n      // Remove low-res image and replace with high-res\n      remove(lowResImg);\n      this.elements.image = hiResImage as HTMLImageElement;\n    };\n\n    if (imageLoaded(hiResImage as HTMLImageElement)) {\n      onHighResImageLoad();\n    } else {\n      const hiResLoadRemover = assignEvent(hiResImage, 'load', onHighResImageLoad);\n      this.activeLoads.set('hiResImageLoad', hiResLoadRemover);\n    }\n  }\n\n  /**\n   * Cancels all active load operations\n   * Used during cleanup or when loading new images\n   *\n   * @example\n   * ```typescript\n   * loader.destroy();\n   * ```\n   */\n  destroy(): void {\n    this._cancelPreviousLoads();\n  }\n\n  /**\n   * Creates snap and main image elements\n   * @private\n   */\n  private _createImageElements(imageSrc: string): {\n    snapImage: HTMLElement;\n    image: HTMLImageElement;\n  } {\n    // Defense in depth: validate again before assigning src to DOM elements\n    if (!isValidImageUrl(imageSrc)) {\n      throw new Error(`Invalid or unsafe image URL: ${imageSrc}`);\n    }\n\n    const { snapImageWrap, imageWrap } = this.elements;\n    if (!snapImageWrap || !imageWrap) {\n      throw new Error('Image wrap elements not found');\n    }\n\n    // Create snap view image\n    const firstChild = snapImageWrap.firstChild;\n    const snapImage = createElement({\n      tagName: 'img',\n      className: 'iv-snap-image',\n      ...(firstChild ? { insertBefore: firstChild } : {}),\n      parent: snapImageWrap,\n    });\n    (snapImage as HTMLImageElement).src = imageSrc;\n\n    // Create main image\n    const image = createElement({\n      tagName: 'img',\n      className: 'iv-image iv-small-image',\n      parent: imageWrap,\n    });\n    (image as HTMLImageElement).src = imageSrc;\n\n    return { snapImage, image: image as HTMLImageElement };\n  }\n\n  /**\n   * Handles successful image load\n   * @private\n   */\n  private _handleLoadSuccess(loadId: number, hiResImageSrc?: string): void {\n    // Ignore callbacks from superseded loads\n    if (loadId !== this.loadCounter) {\n      return;\n    }\n\n    const { container } = this.elements;\n    if (!container) return;\n\n    const ivLoader = container.querySelector('.iv-loader');\n    const image = this.elements.image;\n\n    // Hide loader and show image\n    if (ivLoader) {\n      setStyle(ivLoader, { display: 'none' });\n    }\n    if (image) {\n      setStyle(image, { visibility: 'visible' });\n    }\n\n    // Load high-res if provided\n    if (hiResImageSrc) {\n      this.loadHighRes(hiResImageSrc);\n    }\n\n    // Notify success\n    this.onLoadSuccess(loadId);\n  }\n\n  /**\n   * Handles image load error\n   * @private\n   */\n  private _handleLoadError(loadId: number, error: Event | ErrorEvent): void {\n    // Ignore callbacks from superseded loads\n    if (loadId !== this.loadCounter) {\n      return;\n    }\n\n    const { container } = this.elements;\n    if (!container) return;\n\n    const ivLoader = container.querySelector('.iv-loader');\n    if (ivLoader) {\n      setStyle(ivLoader, { display: 'none' });\n    }\n\n    // Notify error\n    this.onLoadError(loadId, error);\n  }\n\n  /**\n   * Cancels all previous load operations\n   * @private\n   */\n  private _cancelPreviousLoads(): void {\n    this.activeLoads.forEach((remover) => remover());\n    this.activeLoads.clear();\n  }\n}\n","import { assignEvent } from './util';\nimport type { EventRemover } from './types';\n\n/**\n * EventManager - Centralized event management\n * REFACTOR: Extract event management logic from ImageViewer (Issue MED-1, A1.5)\n *\n * Manages all event listeners with automatic cleanup and tracking\n * Prevents memory leaks by ensuring all events are properly removed\n *\n * @example\n * ```typescript\n * const eventManager = new EventManager();\n *\n * // Register an event\n * eventManager.on('windowResize', window, 'resize', () => this.refresh());\n *\n * // Remove a specific event\n * eventManager.off('windowResize');\n *\n * // Clean up all events\n * eventManager.destroy();\n * ```\n */\nexport class EventManager {\n  private listeners: Map<string, EventRemover> = new Map();\n\n  /**\n   * Registers an event listener with a name for later reference\n   * Automatically removes any existing listener with the same name\n   *\n   * @param name - Unique identifier for this event listener\n   * @param target - Element or window to attach event to\n   * @param eventType - Event type(s) to listen for\n   * @param handler - Event handler function\n   * @returns Cleanup function to remove the event listener\n   *\n   * @example\n   * ```typescript\n   * eventManager.on('resize', window, 'resize', () => console.log('resized'));\n   * eventManager.on('clicks', button, ['click', 'touchend'], handleClick);\n   * ```\n   */\n  on(\n    name: string,\n    target: EventTarget,\n    eventType: string | string[],\n    handler: EventListener,\n  ): EventRemover {\n    // Remove existing listener with same name if present\n    this.off(name);\n\n    const removeListener = assignEvent(target, eventType, handler);\n    this.listeners.set(name, removeListener);\n\n    return removeListener;\n  }\n\n  /**\n   * Removes a specific event listener by name\n   *\n   * @param name - Name of the event listener to remove\n   * @returns true if listener was found and removed, false otherwise\n   *\n   * @example\n   * ```typescript\n   * eventManager.off('windowResize');\n   * ```\n   */\n  off(name: string): boolean {\n    const listener = this.listeners.get(name);\n    if (listener) {\n      listener();\n      this.listeners.delete(name);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Removes all registered event listeners\n   * Should be called when destroying the component\n   *\n   * @example\n   * ```typescript\n   * eventManager.destroy();\n   * ```\n   */\n  destroy(): void {\n    this.listeners.forEach((listener) => listener());\n    this.listeners.clear();\n  }\n\n  /**\n   * Gets the number of active event listeners\n   *\n   * @returns Number of registered listeners\n   *\n   * @example\n   * ```typescript\n   * console.log(`Active listeners: ${eventManager.count()}`);\n   * ```\n   */\n  count(): number {\n    return this.listeners.size;\n  }\n\n  /**\n   * Checks if a specific event listener is registered\n   *\n   * @param name - Name of the event listener to check\n   * @returns true if listener exists, false otherwise\n   *\n   * @example\n   * ```typescript\n   * if (eventManager.has('windowResize')) {\n   *   console.log('Resize listener is active');\n   * }\n   * ```\n   */\n  has(name: string): boolean {\n    return this.listeners.has(name);\n  }\n\n  /**\n   * Gets all registered event listener names\n   *\n   * @returns Array of event listener names\n   *\n   * @example\n   * ```typescript\n   * const names = eventManager.getNames();\n   * console.log('Active events:', names);\n   * ```\n   */\n  getNames(): string[] {\n    return Array.from(this.listeners.keys());\n  }\n}\n","import {\n  createElement,\n  addClass,\n  wrap,\n  setStyle,\n  getStyle,\n  removeClass,\n  remove,\n  unwrap,\n} from './util';\nimport type { HTMLElementWithViewer } from './ImageViewer';\nimport type { ViewerElements } from './types';\n\n/**\n * ImageViewerDOM - DOM structure management for ImageViewer\n *\n * Handles all DOM-related operations:\n * - Container finding and creation\n * - HTML structure generation\n * - Element reference management\n * - DOM cleanup\n */\nexport class ImageViewerDOM {\n  private elements: Partial<ViewerElements> = {};\n\n  /**\n   * Initialize DOM from an element or selector\n   * @param element - CSS selector or HTMLElement\n   * @param imageViewHtml - HTML template for the viewer structure\n   * @param validateImageUrl - Function to validate image URLs\n   * @returns Initial setup data (container, domElement, image sources)\n   */\n  initialize(\n    element: string | HTMLElement,\n    imageViewHtml: string,\n    validateImageUrl: (url: string | null | undefined, context: string) => string | null,\n  ): {\n    container: HTMLElement;\n    domElement: HTMLElement;\n    imageSrc?: string;\n    hiResImageSrc?: string;\n    elements: Partial<ViewerElements>;\n  } {\n    // Resolve element\n    const domElement = this._resolveElement(element);\n\n    // Check if viewer already initialized\n    if ((domElement as HTMLElementWithViewer)._imageViewer) {\n      throw new Error('An image viewer is already being initiated on the element.');\n    }\n\n    let container: HTMLElement;\n    let imageSrc: string | undefined;\n    let hiResImageSrc: string | undefined;\n\n    // Handle IMG element vs container element\n    if (domElement.tagName === 'IMG') {\n      const result = this._processImgElement(domElement as HTMLImageElement, validateImageUrl);\n      container = result.container;\n      imageSrc = result.imageSrc;\n      hiResImageSrc = result.hiResImageSrc;\n    } else {\n      container = domElement;\n      const sources = this._extractImageSourcesFromContainer(domElement, validateImageUrl);\n      imageSrc = sources.imageSrc;\n      hiResImageSrc = sources.hiResImageSrc;\n    }\n\n    // Store initial elements\n    this.elements = { container, domElement };\n\n    // Create DOM structure\n    this._createStructure(container, imageViewHtml);\n\n    return {\n      container,\n      domElement,\n      imageSrc,\n      hiResImageSrc,\n      elements: this.elements,\n    };\n  }\n\n  /**\n   * Get all current element references\n   */\n  getElements(): Partial<ViewerElements> {\n    return this.elements;\n  }\n\n  /**\n   * Get a specific element\n   */\n  getElement<K extends keyof ViewerElements>(key: K): ViewerElements[K] | undefined {\n    return this.elements[key] as ViewerElements[K] | undefined;\n  }\n\n  /**\n   * Set a specific element\n   */\n  setElement<K extends keyof ViewerElements>(key: K, element: ViewerElements[K] | undefined): void {\n    this.elements[key] = element;\n  }\n\n  /**\n   * Cleanup DOM when destroying viewer\n   */\n  destroy(domElement: HTMLElement, container: HTMLElement): void {\n    // Remove viewer HTML structure\n    const ivWrap = container.querySelector('.iv-wrap');\n    if (ivWrap) {\n      remove(ivWrap);\n    }\n\n    // Remove container class\n    removeClass(container, 'iv-container');\n\n    // Unwrap if container was created from IMG element\n    if (domElement !== container) {\n      unwrap(domElement);\n    }\n  }\n\n  /**\n   * Resolve element from string selector or HTMLElement\n   */\n  private _resolveElement(element: string | HTMLElement): HTMLElement {\n    if (typeof element === 'string') {\n      const foundElement = document.querySelector(element);\n      if (!foundElement) {\n        throw new Error(`Element not found: ${element}`);\n      }\n      return foundElement as HTMLElement;\n    }\n    return element;\n  }\n\n  /**\n   * Process IMG element - extract sources and create container\n   */\n  private _processImgElement(\n    imgElement: HTMLImageElement,\n    validateImageUrl: (url: string | null | undefined, context: string) => string | null,\n  ): {\n    container: HTMLElement;\n    imageSrc: string | undefined;\n    hiResImageSrc: string | undefined;\n  } {\n    const rawSrc = imgElement.src;\n    const rawHiResSrc =\n      imgElement.getAttribute('high-res-src') || imgElement.getAttribute('data-high-res-src');\n\n    // Validate image URLs\n    const imageSrc = validateImageUrl(rawSrc, 'main');\n    const hiResImageSrc = validateImageUrl(rawHiResSrc, 'hiRes');\n\n    if (!imageSrc) {\n      throw new Error('Invalid or unsafe image URL protocol');\n    }\n\n    // Wrap the image with container\n    const container = wrap(imgElement, {\n      className: 'iv-container iv-image-mode',\n      style: { display: 'inline-block', overflow: 'hidden' },\n    });\n\n    // Hide original image\n    setStyle(imgElement, {\n      opacity: '0',\n      position: 'relative',\n      'z-index': '-1',\n    });\n\n    return { container, imageSrc, hiResImageSrc };\n  }\n\n  /**\n   * Extract image sources from container element attributes\n   */\n  private _extractImageSourcesFromContainer(\n    containerElement: HTMLElement,\n    validateImageUrl: (url: string | null | undefined, context: string) => string | null,\n  ): {\n    imageSrc: string | undefined;\n    hiResImageSrc: string | undefined;\n  } {\n    const rawSrc =\n      containerElement.getAttribute('src') || containerElement.getAttribute('data-src');\n    const rawHiResSrc =\n      containerElement.getAttribute('high-res-src') ||\n      containerElement.getAttribute('data-high-res-src');\n\n    // Validate image URLs\n    const imageSrc = validateImageUrl(rawSrc, 'main');\n    const hiResImageSrc = validateImageUrl(rawHiResSrc, 'hiRes');\n\n    return { imageSrc, hiResImageSrc };\n  }\n\n  /**\n   * Create viewer DOM structure\n   */\n  private _createStructure(container: HTMLElement, imageViewHtml: string): void {\n    // Add viewer layout\n    createElement({\n      tagName: 'div',\n      className: 'iv-wrap',\n      html: imageViewHtml,\n      trustedHTML: true,\n      parent: container,\n    });\n\n    // Add container class\n    addClass(container, 'iv-container');\n\n    // Position container relatively if static\n    if (getStyle(container, 'position') === 'static') {\n      setStyle(container, { position: 'relative' });\n    }\n\n    // Query and store element references\n    const snapView = container.querySelector('.iv-snap-view') as HTMLElement;\n    const snapImageWrap = container.querySelector('.iv-snap-image-wrap') as HTMLElement;\n    const imageWrap = container.querySelector('.iv-image-wrap') as HTMLElement;\n    const snapHandle = container.querySelector('.iv-snap-handle') as HTMLElement;\n    const zoomHandle = container.querySelector('.iv-zoom-handle') as HTMLElement;\n    const zoomIn = container.querySelector('.iv-button-zoom--in') as HTMLElement | null;\n    const zoomOut = container.querySelector('.iv-button-zoom--out') as HTMLElement | null;\n\n    if (!snapView || !snapImageWrap || !imageWrap || !snapHandle || !zoomHandle) {\n      throw new Error('Required viewer elements not found in container');\n    }\n\n    // Store element references\n    this.elements = {\n      ...this.elements,\n      snapView,\n      snapImageWrap,\n      imageWrap,\n      snapHandle,\n      zoomHandle,\n      zoomIn: zoomIn || undefined,\n      zoomOut: zoomOut || undefined,\n    };\n  }\n}\n","import { getTouchPointsDistance, ZOOM_CONSTANT, MOUSE_WHEEL_COUNT } from './util';\nimport type { EventManager } from './EventManager';\nimport type Slider from './Slider';\n\n/**\n * InteractionManager - User interaction handling for ImageViewer\n * Manages pinch zoom, wheel zoom, and double-tap zoom gestures\n *\n * Phase 7: Extracted from ImageViewer to separate interaction logic\n */\n\ninterface InteractionElements {\n  imageWrap: HTMLElement;\n  container: HTMLElement;\n}\n\ninterface InteractionOptions {\n  zoomOnMouseWheel: boolean;\n  zoomValue: number;\n  maxZoom: number;\n}\n\ninterface InteractionCallbacks {\n  getState: () => { loaded: boolean; zoomValue: number; zooming: boolean };\n  setZooming: (zooming: boolean) => void;\n  clearFrames: () => void;\n  zoom: (value: number, point?: { x: number; y: number }) => void;\n  resetZoom: () => void;\n  showSnapView: () => void;\n  getSlider: (key: string) => Slider | undefined;\n  getScrollPosition: () => { x: number; y: number };\n}\n\nexport class InteractionManager {\n  // REFACTOR: Extract magic constants for better maintainability\n  private static readonly DOUBLE_TAP_INTERVAL_MS = 500;\n  private static readonly DOUBLE_TAP_DISTANCE_PX = 50;\n  private static readonly DOUBLE_TAP_ZOOM_LEVEL = 200;\n\n  constructor(\n    private elements: InteractionElements,\n    private eventManager: EventManager,\n    private options: InteractionOptions,\n    private callbacks: InteractionCallbacks,\n  ) {}\n\n  /**\n   * Set up all interaction handlers\n   */\n  setupInteractions(): void {\n    this.setupPinchZoom();\n    this.setupWheelZoom();\n    this.setupDoubleTap();\n  }\n\n  /**\n   * Enables pinch-to-zoom gesture on touch devices\n   * Calculates zoom based on distance between two touch points\n   */\n  setupPinchZoom(): void {\n    const { imageWrap, container } = this.elements;\n\n    const onPinchStart = (eStart: TouchEvent) => {\n      const { loaded, zoomValue: startZoomValue } = this.callbacks.getState();\n\n      if (!loaded) return;\n\n      const touch0 = eStart.touches[0];\n      const touch1 = eStart.touches[1];\n\n      if (!(touch0 && touch1)) {\n        return;\n      }\n\n      this.callbacks.setZooming(true);\n\n      const contOffset = container.getBoundingClientRect();\n\n      // find distance between two touch points\n      const startDist = getTouchPointsDistance(eStart.touches);\n\n      const scroll = this.callbacks.getScrollPosition();\n\n      // Calculate the center point for zoom\n      const center = this.calculatePinchCenter(touch0, touch1, contOffset, scroll);\n\n      const moveListener = (eMove: TouchEvent) => {\n        const newDist = getTouchPointsDistance(eMove.touches);\n\n        // Calculate new zoom value based on distance change\n        const zoomValue = this.calculatePinchZoom(startZoomValue, startDist, newDist);\n\n        this.callbacks.zoom(zoomValue, center);\n      };\n\n      const endListener = (eEnd: TouchEvent) => {\n        this.eventManager.off('pinchMove');\n        this.eventManager.off('pinchEnd');\n        this.callbacks.setZooming(false);\n        // properly resume move event if one finger remains\n        if (eEnd.touches.length === 1) {\n          this.callbacks.getSlider('imageSlider')?.startHandler(eEnd);\n        }\n      };\n\n      // Remove old pinch events if already assigned\n      this.eventManager.off('pinchMove');\n      this.eventManager.off('pinchEnd');\n\n      // Register dynamic pinch events\n      this.eventManager.on('pinchMove', document, 'touchmove', moveListener as EventListener);\n      this.eventManager.on('pinchEnd', document, 'touchend', endListener as EventListener);\n    };\n\n    this.eventManager.on('pinchStart', imageWrap, 'touchstart', onPinchStart as EventListener);\n  }\n\n  /**\n   * Enables mouse wheel zoom functionality\n   * Uses ZOOM_CONSTANT (15) for zoom speed and MOUSE_WHEEL_COUNT (5) to prevent excessive zooming\n   */\n  setupWheelZoom(): void {\n    const { container, imageWrap } = this.elements;\n\n    let changedDelta = 0;\n\n    const onMouseWheel = (e: WheelEvent) => {\n      const { loaded, zoomValue } = this.callbacks.getState();\n\n      if (!this.options.zoomOnMouseWheel || !loaded) return;\n\n      // clear all animation frame and interval\n      this.callbacks.clearFrames();\n\n      // Get normalized wheel delta\n      const delta = this.normalizeWheelDelta(e);\n\n      const newZoomValue = (zoomValue * (100 + delta * ZOOM_CONSTANT)) / 100;\n\n      if (!(newZoomValue >= 100 && newZoomValue <= this.options.maxZoom)) {\n        changedDelta += Math.abs(delta);\n      } else {\n        changedDelta = 0;\n      }\n\n      e.preventDefault();\n\n      if (changedDelta > MOUSE_WHEEL_COUNT) return;\n\n      const contOffset = container.getBoundingClientRect();\n\n      // Calculate mouse position relative to container\n      const position = this.getMousePositionRelativeToContainer(e, contOffset);\n\n      this.callbacks.zoom(newZoomValue, position);\n\n      // show the snap viewer\n      this.callbacks.showSnapView();\n    };\n\n    this.eventManager.on('wheelZoom', imageWrap, 'wheel', onMouseWheel as EventListener);\n  }\n\n  /**\n   * Enables double-click/tap to zoom functionality\n   * Detects double clicks within 500ms and 50px distance threshold\n   * Toggles between base zoom and 200% zoom\n   */\n  setupDoubleTap(): void {\n    const { imageWrap } = this.elements;\n\n    let touchTime = 0;\n    let point: { x: number; y: number };\n\n    const onDoubleTap = (e: MouseEvent) => {\n      const { zoomValue } = this.callbacks.getState();\n\n      if (touchTime === 0) {\n        touchTime = Date.now();\n        point = {\n          x: e.pageX,\n          y: e.pageY,\n        };\n      } else if (\n        Date.now() - touchTime < InteractionManager.DOUBLE_TAP_INTERVAL_MS &&\n        Math.abs(e.pageX - point.x) < InteractionManager.DOUBLE_TAP_DISTANCE_PX &&\n        Math.abs(e.pageY - point.y) < InteractionManager.DOUBLE_TAP_DISTANCE_PX\n      ) {\n        if (zoomValue === this.options.zoomValue) {\n          this.callbacks.zoom(InteractionManager.DOUBLE_TAP_ZOOM_LEVEL);\n        } else {\n          this.callbacks.resetZoom();\n        }\n        touchTime = 0;\n      } else {\n        touchTime = 0;\n      }\n    };\n\n    this.eventManager.on('doubleTapClick', imageWrap, 'click', onDoubleTap as EventListener);\n  }\n\n  /**\n   * Cleanup all interaction handlers\n   * Note: EventManager.destroy() will handle event cleanup\n   */\n  destroy(): void {\n    // Events are managed by EventManager and will be cleaned up when it's destroyed\n    // No additional cleanup needed here\n  }\n\n  // Private helper methods\n\n  /**\n   * Calculate the center point between two touch points\n   */\n  private calculatePinchCenter(\n    touch0: Touch,\n    touch1: Touch,\n    containerOffset: DOMRect,\n    scroll: { x: number; y: number },\n  ): { x: number; y: number } {\n    return {\n      x: (touch1.pageX + touch0.pageX) / 2 - (containerOffset.left + scroll.x),\n      y: (touch1.pageY + touch0.pageY) / 2 - (containerOffset.top + scroll.y),\n    };\n  }\n\n  /**\n   * Calculate zoom value based on pinch distance change\n   */\n  private calculatePinchZoom(\n    startZoomValue: number,\n    startDist: number,\n    currentDist: number,\n  ): number {\n    return startZoomValue + (currentDist - startDist) / 2;\n  }\n\n  /**\n   * Normalize wheel delta across browsers\n   */\n  private normalizeWheelDelta(e: WheelEvent): number {\n    // P2-2 FIX: Type-safe cross-browser wheel delta\n    // Legacy browsers used wheelDelta (IE) and detail (Firefox, deprecated)\n    const legacyEvent = e as WheelEvent & { wheelDelta?: number };\n    return Math.max(-1, Math.min(1, legacyEvent.wheelDelta || -e.detail || -e.deltaY));\n  }\n\n  /**\n   * Calculate mouse position relative to container\n   */\n  private getMousePositionRelativeToContainer(\n    e: { pageX: number; pageY: number },\n    containerOffset: DOMRect,\n  ): { x: number; y: number } {\n    const scroll = this.callbacks.getScrollPosition();\n    return {\n      x: e.pageX - (containerOffset.left + scroll.x),\n      y: e.pageY - (containerOffset.top + scroll.y),\n    };\n  }\n}\n","// REFACTOR: Removed noop import as callbacks are now required (Issue E2.7)\n\nclass Slider {\n  private _onStart: (event: Event, position: { x: number; y: number }) => void;\n  private _onMove: (\n    event: Event,\n    position: { dx: number; dy: number; mx: number; my: number },\n  ) => void;\n  private _onEnd: () => void;\n  private isSliderEnabled: () => boolean;\n  private container: HTMLElement;\n  private touchMoveEvent: string | undefined;\n  private touchEndEvent: string | undefined;\n  // REFACTOR: Explicit initialization instead of definite assignment assertion (Issue E2.8)\n  private sx: number = 0;\n  private sy: number = 0;\n  /**\n   * Creates a slider instance for handling mouse and touch drag interactions\n   * Supports both mouse events and touch events with unified API\n   * REFACTOR: Made callbacks required for better type safety (Issue E2.7)\n   * @param container - DOM element to attach slider events to\n   * @param callbacks - Configuration object with event callbacks\n   * @param callbacks.onStart - REQUIRED callback when drag starts with initial position\n   * @param callbacks.onMove - REQUIRED callback during drag with delta and current position\n   * @param callbacks.onEnd - REQUIRED callback when drag ends\n   * @param callbacks.isSliderEnabled - Optional function that returns whether slider is currently enabled\n   */\n  constructor(\n    container: HTMLElement,\n    {\n      onStart,\n      onMove,\n      onEnd,\n      isSliderEnabled,\n    }: {\n      onStart: (event: Event, position: { x: number; y: number }) => void;\n      onMove: (event: Event, position: { dx: number; dy: number; mx: number; my: number }) => void;\n      onEnd: () => void;\n      isSliderEnabled?: () => boolean;\n    },\n  ) {\n    // REFACTOR: Runtime validation for required callbacks (Issue E2.7)\n    if (typeof onStart !== 'function') {\n      throw new Error('Slider: onStart callback is required and must be a function');\n    }\n    if (typeof onMove !== 'function') {\n      throw new Error('Slider: onMove callback is required and must be a function');\n    }\n    if (typeof onEnd !== 'function') {\n      throw new Error('Slider: onEnd callback is required and must be a function');\n    }\n\n    this.container = container;\n    this.isSliderEnabled = isSliderEnabled || (() => true);\n    this._onStart = onStart;\n    this._onMove = onMove;\n    this._onEnd = onEnd;\n  }\n\n  /**\n   * Public method to trigger start handler\n   * Used by ImageViewer for manual slider control\n   * REFACTOR: Made parameters required for better type safety (Issue C3.7)\n   * @param event - Event that triggered the start\n   * @param position - Initial position { x, y }\n   */\n  public onStart(event: Event, position: { x: number; y: number }) {\n    return this._onStart(event, position);\n  }\n\n  /**\n   * Public method to trigger move handler\n   * Used by ImageViewer for manual slider control\n   * REFACTOR: Made parameters required for better type safety (Issue C3.7)\n   * @param event - Event that triggered the move\n   * @param position - Position with deltas and current coordinates { dx, dy, mx, my }\n   */\n  public onMove(event: Event, position: { dx: number; dy: number; mx: number; my: number }) {\n    return this._onMove(event, position);\n  }\n\n  /**\n   * Programmatic position update without requiring an event\n   * REFACTOR: Avoid dummy event creation (Issue A1.12)\n   * Useful for synchronizing slider positions or updating from external sources\n   *\n   * @param position - Position with deltas and current coordinates { dx, dy, mx, my }\n   *\n   * @example\n   * ```typescript\n   * // Sync slider position without creating dummy events\n   * slider.updatePosition({ dx: 10, dy: 5, mx: 100, my: 50 });\n   * ```\n   */\n  public updatePosition(position: { dx: number; dy: number; mx: number; my: number }): void {\n    // Create a minimal synthetic event for the callback\n    // The event parameter is rarely used by callbacks, so this is safe\n    const syntheticEvent = new Event('programmatic-update');\n    this._onMove(syntheticEvent, position);\n  }\n\n  /**\n   * REFACTOR: Extract event type detection logic (Issue A1.8)\n   * Determines if an event is a touch event based on event type\n   * @param event - Event to check\n   * @returns True if event is a touch event\n   */\n  private isTouchEvent(event: Event): boolean {\n    return event.type === 'touchstart' || event.type === 'touchmove' || event.type === 'touchend';\n  }\n\n  /**\n   * Handles drag start event for both mouse and touch\n   * Detects event type and extracts starting coordinates\n   * Sets up move and end event listeners\n   */\n  startHandler = (eStart: Event) => {\n    if (!this.isSliderEnabled()) return;\n\n    this.removeListeners();\n\n    // P2-5 FIX: Only prevent default if event is cancelable\n    if (eStart.cancelable) {\n      eStart.preventDefault();\n    }\n\n    const { moveHandler, endHandler, _onStart: onStart } = this;\n\n    // REFACTOR: Use helper method for event type detection (Issue A1.8)\n    const isTouch = this.isTouchEvent(eStart);\n\n    let sx: number;\n    let sy: number;\n    if (isTouch) {\n      const touchEvent = eStart as TouchEvent; // Cast to TouchEvent type\n      this.touchMoveEvent = 'touchmove';\n      this.touchEndEvent = 'touchend';\n      sx = touchEvent.touches[0].clientX;\n      sy = touchEvent.touches[0].clientY;\n    } else {\n      const mouseEvent = eStart as MouseEvent; // Cast to MouseEvent type\n      this.touchMoveEvent = 'mousemove';\n      this.touchEndEvent = 'mouseup';\n      sx = mouseEvent.clientX;\n      sy = mouseEvent.clientY;\n    }\n    this.sx = sx;\n    this.sy = sy;\n\n    onStart(eStart, {\n      x: this.sx,\n      y: this.sy,\n    });\n\n    // add listeners\n    document.addEventListener(this.touchMoveEvent, moveHandler);\n    document.addEventListener(this.touchEndEvent, endHandler);\n    /*\n      add end handler in context menu as well.\n      As mouseup event is not trigger on context menu open\n      https://bugs.chromium.org/p/chromium/issues/detail?id=506801\n    */\n    document.addEventListener('contextmenu', endHandler);\n  };\n\n  /**\n   * Handles drag move event for both mouse and touch\n   * Calculates delta from start position and current position\n   * Passes dx, dy (deltas) and mx, my (current position) to onMove callback\n   */\n  moveHandler = (eMove: Event) => {\n    if (!this.isSliderEnabled()) return;\n\n    // P2-5 FIX: Only prevent default if event is cancelable\n    if (eMove.cancelable) {\n      eMove.preventDefault();\n    }\n    const { sx, sy, _onMove: onMove } = this;\n\n    // REFACTOR: Use helper method for event type detection (Issue A1.8)\n    const isTouch = this.isTouchEvent(eMove);\n\n    // get the coordinates\n    let mx: number;\n    let my: number;\n    if (isTouch) {\n      const touchEvent = eMove as TouchEvent; // Cast to TouchEvent type\n      mx = touchEvent.touches[0].clientX;\n      my = touchEvent.touches[0].clientY;\n    } else {\n      const mouseEvent = eMove as MouseEvent; // Cast to MouseEvent type\n      mx = mouseEvent.clientX;\n      my = mouseEvent.clientY;\n    }\n\n    onMove(eMove, {\n      dx: mx - sx,\n      dy: my - sy,\n      mx,\n      my,\n    });\n  };\n\n  endHandler = () => {\n    if (!this.isSliderEnabled()) return;\n    this.removeListeners();\n    this._onEnd();\n  };\n\n  /**\n   * Removes active event listeners\n   * Handles edge case where mouse/touch leaves document during drag\n   */\n  removeListeners() {\n    if (this.touchMoveEvent) document.removeEventListener(this.touchMoveEvent, this.moveHandler);\n    if (this.touchEndEvent) document.removeEventListener(this.touchEndEvent, this.endHandler);\n    document.removeEventListener('contextmenu', this.endHandler);\n  }\n\n  /**\n   * Initializes the slider by attaching start event listeners\n   * Listens for both touchstart and mousedown events\n   */\n  init() {\n    ['touchstart', 'mousedown'].forEach((evt) => {\n      this.container.addEventListener(evt, this.startHandler);\n    });\n  }\n\n  /**\n   * Destroys the slider by removing all event listeners\n   * Cleans up both start and active drag listeners\n   */\n  destroy() {\n    ['touchstart', 'mousedown'].forEach((evt) => {\n      this.container.removeEventListener(evt, this.startHandler);\n    });\n    this.removeListeners();\n  }\n}\n\nexport default Slider;\n","import { getStyle, setStyle, parseStyleFloat, isValidImageUrl, clamp } from './util';\n\nimport { ZoomAnimation, type ZoomBounds } from './ZoomAnimation';\nimport { DimensionCalculator } from './DimensionCalculator';\nimport { MomentumCalculator } from './MomentumCalculator';\nimport { SliderCoordinator } from './SliderCoordinator';\nimport { ViewerHTMLTemplates } from './ViewerHTMLTemplates';\nimport { ImageLoader } from './ImageLoader';\nimport { EventManager } from './EventManager';\nimport { ImageViewerDOM } from './ImageViewerDOM';\nimport { InteractionManager } from './InteractionManager';\n\nimport type {\n  ImageViewerOptions,\n  ViewerElements,\n  ViewerState,\n  ImageViewerListeners,\n  AnimationFrames,\n  Dimensions,\n} from './types';\n\nimport Slider from './Slider';\nimport FullScreenViewer from './FullScreen';\n\n// Extend HTMLElement interface to include custom _imageViewer property\nexport interface HTMLElementWithViewer extends HTMLElement {\n  _imageViewer?: ImageViewer | null;\n}\n\nclass ImageViewer {\n  static defaults: ImageViewerOptions;\n  static FullScreenViewer: typeof FullScreenViewer;\n\n  // REFACTOR: Extract magic constants for better maintainability\n  private static readonly MOMENTUM_SAMPLE_INTERVAL_MS = 50;\n  private static readonly MOMENTUM_ANIMATION_FRAMES = 60;\n  private static readonly MOMENTUM_THRESHOLD_PX = 30;\n  private static readonly MOMENTUM_VELOCITY_FACTOR = 1 / 3;\n  private static readonly ZOOM_ANIMATION_FRAMES = 16;\n  private static readonly SNAP_VIEW_TIMEOUT_MS = 1500;\n\n  private _elements: ViewerElements; // REFACTOR: Changed from protected to private (Issue E2.1)\n  private _options: Required<ImageViewerOptions>;\n  private _listeners: ImageViewerListeners;\n  private _state: ViewerState;\n  private _sliders: {\n    snapSlider?: Slider;\n    imageSlider?: Slider;\n    zoomSlider?: Slider;\n  };\n  private _frames: Partial<AnimationFrames>;\n  private _images: { hiResImageSrc?: string; imageSrc?: string };\n  private imageLoader: ImageLoader; // REFACTOR: Extract image loading logic (Issue C3.1)\n  protected eventManager: EventManager; // REFACTOR: Centralized event management (Issue A1.5, Phase 6.1)\n  private dom: ImageViewerDOM; // REFACTOR: Extract DOM management logic (Issue C3.1, Phase 8)\n  private interactionManager: InteractionManager; // REFACTOR: Extract interaction logic (Phase 7)\n\n  /**\n   * Creates a new ImageViewer instance\n   * @param element - DOM element, CSS selector, or IMG element to initialize the viewer on\n   * @param options - Configuration options (zoomValue, maxZoom, snapView, etc.)\n   * @example\n   * ```typescript\n   * // Initialize on an image element\n   * const viewer = new ImageViewer('#myImage', { maxZoom: 800 });\n   *\n   * // Initialize on a container with data attributes\n   * const viewer = new ImageViewer(document.querySelector('.container'), {\n   *   snapView: true,\n   *   zoomOnMouseWheel: true\n   * });\n   * ```\n   */\n  constructor(element: string | HTMLElement, options = {}) {\n    this._options = { ...ImageViewer.defaults, ...options } as Required<ImageViewerOptions>;\n\n    // REFACTOR: Use ImageViewerDOM for DOM initialization (Phase 8)\n    this.dom = new ImageViewerDOM();\n    const { domElement, imageSrc, hiResImageSrc, elements } = this.dom.initialize(\n      element,\n      ViewerHTMLTemplates.createViewerHTML(this._options.hasZoomButtons),\n      (url, context) => this._validateImageUrl(url, context as 'main' | 'hiRes'),\n    );\n\n    // Store element references\n    this._elements = elements as ViewerElements;\n\n    // P3-5 FIX: Explicit null checking pattern for optional properties\n    this._listeners =\n      this._options.listeners !== undefined && this._options.listeners !== null\n        ? this._options.listeners\n        : {};\n\n    // container for all timeout and frames\n    this._frames = {};\n\n    // container for all sliders\n    this._sliders = {};\n\n    // maintain current state\n    this._state = {\n      zoomValue: this._options.zoomValue,\n      loaded: false,\n      imageDim: { w: 0, h: 0 },\n      containerDim: { w: 0, h: 0 },\n      snapImageDim: { w: 0, h: 0 },\n      zooming: false,\n      snapViewVisible: false,\n      zoomSliderLength: 0,\n      snapHandleDim: { w: 0, h: 0 },\n    };\n\n    this._images = {\n      imageSrc,\n      hiResImageSrc,\n    };\n\n    // REFACTOR: Initialize ImageLoader for handling image loading operations (Issue C3.1)\n    this.imageLoader = new ImageLoader(\n      this._elements,\n      (loadId) => this._handleImageLoadSuccess(loadId),\n      (loadId, error) => this._handleImageLoadError(loadId, error),\n    );\n\n    // REFACTOR: Initialize EventManager for centralized event management (Issue A1.5)\n    this.eventManager = new EventManager();\n\n    // REFACTOR: Initialize InteractionManager for gesture handling (Phase 7)\n    this.interactionManager = new InteractionManager(\n      {\n        imageWrap: this._elements.imageWrap!,\n        container: this._elements.container!,\n      },\n      this.eventManager,\n      {\n        zoomOnMouseWheel: this._options.zoomOnMouseWheel,\n        zoomValue: this._options.zoomValue,\n        maxZoom: this._options.maxZoom,\n      },\n      {\n        getState: () => ({\n          loaded: this._state.loaded ?? false,\n          zoomValue: this._state.zoomValue ?? 100,\n          zooming: this._state.zooming ?? false,\n        }),\n        setZooming: (zooming) => this._setZooming(zooming),\n        clearFrames: () => this._clearFrames(),\n        zoom: (value, point) => this.zoom(value, point),\n        resetZoom: () => this.resetZoom(),\n        showSnapView: () => this.showSnapView(),\n        getSlider: (key) => this._getSlider(key as 'imageSlider' | 'snapSlider' | 'zoomSlider'),\n        getScrollPosition: () => this._getScrollPosition(),\n      },\n    );\n\n    this._init();\n\n    if (imageSrc) {\n      this._loadImages();\n    }\n\n    // store reference of imageViewer in domElement\n    (domElement as HTMLElementWithViewer)._imageViewer = this;\n  }\n\n  // REFACTOR: HTML generation moved to ViewerHTMLTemplates (Issue C3.1)\n  get imageViewHtml() {\n    return ViewerHTMLTemplates.createViewerHTML(this._options.hasZoomButtons);\n  }\n\n  /**\n   * Returns callback data object passed to event listeners\n   * Includes container, snapView, zoom values, and instance reference\n   */\n  get _callbackData(): {\n    container: HTMLElement;\n    snapView: HTMLElement;\n    zoomValue: number;\n    reachedMin: boolean;\n    reachedMax: boolean;\n    instance: ImageViewer;\n  } {\n    // P3-1 FIX: Add null checking for elements that might not be initialized\n    if (!this._elements.container || !this._elements.snapView) {\n      throw new Error('ImageViewer elements not initialized. Cannot get callback data.');\n    }\n\n    return {\n      container: this._elements.container,\n      snapView: this._elements.snapView,\n      zoomValue: this._state.zoomValue,\n      reachedMin: Math.round(this._state.zoomValue) === this._options.zoomValue,\n      reachedMax: Math.round(this._state.zoomValue) === this._options.maxZoom,\n      instance: this,\n    };\n  }\n\n  // REFACTOR: State setter methods for better encapsulation (Issue E2.4)\n  // These methods centralize state modifications for easier tracking and validation\n\n  protected _setZoomValue(value: number): void {\n    this._state.zoomValue = value;\n  }\n\n  protected _setLoaded(loaded: boolean): void {\n    this._state.loaded = loaded;\n  }\n\n  protected _setZooming(zooming: boolean): void {\n    this._state.zooming = zooming;\n  }\n\n  protected _setSnapViewVisible(visible: boolean): void {\n    this._state.snapViewVisible = visible;\n  }\n\n  protected _setContainerDim(dim: Dimensions): void {\n    this._state.containerDim = dim;\n  }\n\n  protected _setImageDim(dim: Dimensions): void {\n    this._state.imageDim = dim;\n  }\n\n  protected _setSnapImageDim(dim: Dimensions): void {\n    this._state.snapImageDim = dim;\n  }\n\n  protected _setSnapHandleDim(dim: Dimensions): void {\n    this._state.snapHandleDim = dim;\n  }\n\n  protected _setZoomSliderLength(length: number): void {\n    this._state.zoomSliderLength = length;\n  }\n\n  // REFACTOR: Element and event accessor methods for better encapsulation (Issues E2.1, E2.2)\n  // These methods provide controlled access to internal elements and events for subclasses\n\n  protected _getElement<K extends keyof ViewerElements>(key: K): ViewerElements[K] | undefined {\n    return this._elements[key] as ViewerElements[K] | undefined;\n  }\n\n  protected _setElement<K extends keyof ViewerElements>(\n    key: K,\n    element: ViewerElements[K] | undefined,\n  ): void {\n    this._elements[key] = element;\n  }\n\n  // REFACTOR: Slider accessor methods for better encapsulation (Issue E2.5)\n  // These methods provide controlled access to slider instances\n\n  private _getSlider<K extends keyof typeof this._sliders>(key: K): (typeof this._sliders)[K] {\n    return this._sliders[key];\n  }\n\n  private _setSlider<K extends keyof typeof this._sliders>(\n    key: K,\n    slider: (typeof this._sliders)[K],\n  ): void {\n    this._sliders[key] = slider;\n  }\n\n  private _destroySlider(key: 'imageSlider' | 'snapSlider' | 'zoomSlider'): void {\n    const slider = this._sliders[key];\n    if (slider) {\n      slider.destroy();\n      this._sliders[key] = undefined;\n    }\n  }\n\n  // REFACTOR: Extract duplicated URL validation logic (Issue A1.4)\n  private _validateImageUrl(\n    url: string | null | undefined,\n    urlType: 'main' | 'hiRes' = 'main',\n  ): string | null {\n    if (!url) return null;\n\n    if (!isValidImageUrl(url)) {\n      const typeLabel = urlType === 'hiRes' ? 'high-res ' : '';\n      throw new Error(`Invalid or unsafe ${typeLabel}image URL: ${url}`);\n    }\n\n    return url;\n  }\n\n  // REFACTOR: Images object structure validation (Issue E2.10)\n  private _setImageSources(sources: {\n    imageSrc?: string | null;\n    hiResImageSrc?: string | null;\n  }): void {\n    // Validate image sources before setting\n    const validatedImageSrc = this._validateImageUrl(sources.imageSrc ?? null, 'main');\n    const validatedHiResImageSrc = this._validateImageUrl(sources.hiResImageSrc ?? null, 'hiRes');\n\n    this._images = {\n      imageSrc: validatedImageSrc ?? undefined,\n      hiResImageSrc: validatedHiResImageSrc ?? undefined,\n    };\n  }\n\n  // REFACTOR: Extract duplicated scroll position logic (Issue A1.6)\n  private _getScrollPosition(): { x: number; y: number } {\n    return {\n      x: window.pageXOffset || window.scrollX || 0,\n      y: window.pageYOffset || window.scrollY || 0,\n    };\n  }\n\n  // REFACTOR: Extract duplicated zoom step retrieval (Issue A1.7)\n  private _getZoomStep(): number {\n    return this._options.zoomStep !== undefined && this._options.zoomStep !== null\n      ? this._options.zoomStep\n      : 50;\n  }\n\n  // REFACTOR: Extract momentum calculation logic (Issue A1.3)\n  // These methods centralize momentum tracking and animation for better testability\n\n  // REFACTOR: Momentum calculation methods moved to MomentumCalculator (Issue C3.1/A1.3)\n  private _calculateMomentumDelta(positions: Array<{ x: number; y: number }>): {\n    xDiff: number;\n    yDiff: number;\n  } {\n    return MomentumCalculator.calculateDelta(positions);\n  }\n\n  private _shouldApplyMomentum(xDiff: number, yDiff: number): boolean {\n    return MomentumCalculator.shouldApplyMomentum(xDiff, yDiff, ImageViewer.MOMENTUM_THRESHOLD_PX);\n  }\n\n  // REFACTOR: Momentum animation using MomentumCalculator (Issue C3.1/A1.3)\n  private _applyMomentumAnimation(\n    xDiff: number,\n    yDiff: number,\n    currentPos: { dx: number; dy: number },\n    imageCurrentDim: { w: number; h: number },\n    snapImageDim: { w: number; h: number },\n    snapSlider: Slider,\n  ): void {\n    let step = 1;\n    let cumulativeX = 0;\n    let cumulativeY = 0;\n\n    const config = {\n      thresholdPx: ImageViewer.MOMENTUM_THRESHOLD_PX,\n      velocityFactor: ImageViewer.MOMENTUM_VELOCITY_FACTOR,\n      animationFrames: ImageViewer.MOMENTUM_ANIMATION_FRAMES,\n    };\n\n    const momentum = () => {\n      // Calculate frame position using MomentumCalculator\n      const frame = MomentumCalculator.calculateMomentumFrame(\n        step,\n        { dx: cumulativeX, dy: cumulativeY },\n        { xDiff, yDiff },\n        config,\n      );\n\n      if (frame.shouldContinue) {\n        this._frames.sliderMomentumFrame = requestAnimationFrame(momentum);\n      }\n\n      // Update cumulative positions\n      cumulativeX = frame.positionX;\n      cumulativeY = frame.positionY;\n\n      const finalPosX = currentPos.dx + cumulativeX;\n      const finalPosY = currentPos.dy + cumulativeY;\n\n      // Convert to snap coordinates using MomentumCalculator\n      const snapCoords = MomentumCalculator.convertToSnapCoordinates(\n        { x: finalPosX, y: finalPosY },\n        imageCurrentDim,\n        snapImageDim,\n      );\n\n      // REFACTOR: Use updatePosition instead of dummy event (Issue A1.12)\n      snapSlider.updatePosition({\n        dx: snapCoords.dx,\n        dy: snapCoords.dy,\n        mx: 0,\n        my: 0,\n      });\n\n      step++;\n    };\n\n    momentum();\n  }\n\n  _init() {\n    // REFACTOR: DOM initialization now handled by ImageViewerDOM (Phase 8)\n\n    // initialize slider\n    this._initImageSlider();\n    this._initSnapSlider();\n    this._initZoomSlider();\n\n    // REFACTOR: Setup interactions using InteractionManager (Phase 7)\n    this.interactionManager.setupInteractions();\n\n    // initialize events\n    this._initEvents();\n\n    // Trigger onInit callback\n    if (this._listeners.onInit) {\n      this._listeners.onInit(this._callbackData);\n    }\n  }\n\n  /**\n   * Initializes the main image slider with pan and momentum scrolling\n   * REFACTOR: Uses SliderCoordinator to decouple sliders (Issue C3.5)\n   * Tracks position history for momentum calculation and syncs with snap view\n   */\n  _initImageSlider() {\n    const { _elements } = this;\n\n    const { imageWrap } = _elements;\n\n    let positions: { x: number; y: number }[];\n    let currentPos: { dx: number; dy: number; mx: number; my: number } | undefined;\n\n    // REFACTOR: Create coordinator to handle image/snap slider synchronization (Issue C3.5)\n    const sliderCoordinator = new SliderCoordinator(this._getSlider('snapSlider'), {\n      getImageDim: () => this._getImageCurrentDim(),\n      getSnapImageDim: () => this._state.snapImageDim,\n    });\n\n    /* Add slide interaction to image */\n    const imageSlider = new Slider(imageWrap, {\n      isSliderEnabled: () => {\n        const { loaded, zooming, zoomValue } = this._state;\n        return loaded && !zooming && zoomValue > 100;\n      },\n      onStart: (event, position) => {\n        // clear all animation frame and interval\n        this._clearFrames();\n\n        // REFACTOR: Use coordinator instead of direct snap slider access (Issue C3.5)\n        sliderCoordinator.notifyPanStart(event);\n\n        // reset positions\n        positions = [position, position];\n        currentPos = undefined;\n\n        // P2-4 FIX: Use requestAnimationFrame instead of setInterval for better performance\n        // Track position for momentum calculation\n        let lastSampleTime = performance.now();\n        const sampleInterval = ImageViewer.MOMENTUM_SAMPLE_INTERVAL_MS;\n\n        const trackPosition = (currentTime: number) => {\n          if (currentTime - lastSampleTime >= sampleInterval) {\n            if (currentPos) {\n              positions.shift();\n              positions.push({\n                x: currentPos.mx,\n                y: currentPos.my,\n              });\n            }\n            lastSampleTime = currentTime;\n          }\n          this._frames.slideMomentumCheck = requestAnimationFrame(trackPosition);\n        };\n\n        this._frames.slideMomentumCheck = requestAnimationFrame(trackPosition);\n      },\n      onMove: (_e, position) => {\n        currentPos = position;\n\n        // REFACTOR: Use coordinator to sync snap slider (Issue C3.5)\n        sliderCoordinator.syncSnapSliderPosition(position);\n      },\n      onEnd: () => {\n        const { snapImageDim } = this._state;\n        const imageCurrentDim = this._getImageCurrentDim();\n\n        // clear all animation frame and interval\n        this._clearFrames();\n\n        // Calculate momentum delta (use helper - Issue A1.3)\n        const { xDiff, yDiff } = this._calculateMomentumDelta(positions);\n\n        // Apply momentum animation if threshold exceeded (use helper - Issue A1.3)\n        if (this._shouldApplyMomentum(xDiff, yDiff)) {\n          // REFACTOR: Get snap slider through coordinator (Issue C3.5)\n          const snapSlider = sliderCoordinator.getSnapSlider();\n          this._applyMomentumAnimation(\n            xDiff,\n            yDiff,\n            currentPos,\n            imageCurrentDim,\n            snapImageDim,\n            snapSlider,\n          );\n        }\n      },\n    });\n\n    imageSlider.init();\n\n    this._setSlider('imageSlider', imageSlider);\n  }\n\n  /**\n   * Initializes the snap view slider for dragging the snap handle\n   * Handles boundary constraints and syncs with main image position\n   */\n  /**\n   * REFACTOR: Calculate snap handle position bounds\n   * @param startLeft - Starting left position\n   * @param startTop - Starting top position\n   * @param delta - Position delta from drag\n   * @param snapHandleDim - Snap handle dimensions\n   * @param snapImageDim - Snap image dimensions\n   * @returns Clamped handle position\n   */\n  private _calculateSnapHandlePosition(\n    startLeft: number,\n    startTop: number,\n    delta: { dx: number; dy: number },\n    snapHandleDim: { w: number; h: number },\n    snapImageDim: { w: number; h: number },\n  ): { left: number; top: number } {\n    // BUG-1 FIX: Correct boundary logic for snap handle positioning\n    // Handle can move within the snap image bounds\n    const maxLeft = snapImageDim.w - snapHandleDim.w;\n    const maxTop = snapImageDim.h - snapHandleDim.h;\n    const minLeft = 0;\n    const minTop = 0;\n\n    const left = clamp(startLeft + delta.dx, minLeft, maxLeft);\n    const top = clamp(startTop + delta.dy, minTop, maxTop);\n\n    return { left, top };\n  }\n\n  /**\n   * REFACTOR: Convert snap handle position to main image position\n   * @param snapPosition - Snap handle position\n   * @param imageCurrentDim - Current image dimensions\n   * @param snapImageDim - Snap image dimensions\n   * @returns Main image position\n   */\n  private _convertSnapToImagePosition(\n    snapPosition: { left: number; top: number },\n    imageCurrentDim: { w: number; h: number },\n    snapImageDim: { w: number; h: number },\n  ): { left: number; top: number } {\n    // P2-6 FIX: Prevent division by zero\n    const left =\n      snapImageDim.w !== 0 ? (-snapPosition.left * imageCurrentDim.w) / snapImageDim.w : 0;\n    const top = snapImageDim.h !== 0 ? (-snapPosition.top * imageCurrentDim.h) / snapImageDim.h : 0;\n\n    return { left, top };\n  }\n\n  _initSnapSlider() {\n    const { snapHandle } = this._elements;\n\n    let startHandleTop: number;\n    let startHandleLeft: number;\n\n    const snapSlider = new Slider(snapHandle, {\n      isSliderEnabled: () => {\n        return this._state.loaded;\n      },\n      onStart: () => {\n        const { slideMomentumCheck, sliderMomentumFrame } = this._frames;\n\n        // P2-7 FIX: Add fallback for parseFloat to prevent NaN (use getStyle - Issue A1.10)\n        startHandleTop = parseStyleFloat(snapHandle, 'top');\n        startHandleLeft = parseStyleFloat(snapHandle, 'left');\n\n        // stop momentum on image\n        if (slideMomentumCheck) clearInterval(slideMomentumCheck);\n        if (typeof sliderMomentumFrame === 'number') {\n          cancelAnimationFrame(sliderMomentumFrame);\n        }\n      },\n      onMove: (_, position) => {\n        const { snapHandleDim, snapImageDim } = this._state;\n        const { image } = this._elements;\n\n        const imageCurrentDim = this._getImageCurrentDim();\n\n        if (!snapHandleDim) return;\n\n        // Calculate snap handle position with boundary constraints (use helper)\n        const handlePos = this._calculateSnapHandlePosition(\n          startHandleLeft,\n          startHandleTop,\n          position,\n          snapHandleDim,\n          snapImageDim,\n        );\n\n        // Convert snap position to main image position (use helper)\n        const imagePos = this._convertSnapToImagePosition(handlePos, imageCurrentDim, snapImageDim);\n\n        // Update snap handle position\n        setStyle(snapHandle, {\n          left: `${handlePos.left}px`,\n          top: `${handlePos.top}px`,\n        });\n\n        // Update main image position\n        setStyle(image, {\n          left: `${imagePos.left}px`,\n          top: `${imagePos.top}px`,\n        });\n      },\n      // REFACTOR: onEnd callback is now required (Issue E2.7)\n      onEnd: () => {\n        // No action needed on drag end for snap slider\n      },\n    });\n\n    snapSlider.init();\n\n    this._setSlider('snapSlider', snapSlider);\n  }\n\n  /**\n   * Initializes the zoom slider control in the snap view\n   * Maps slider position to zoom level between 100% and maxZoom\n   */\n  _initZoomSlider() {\n    const { snapView, zoomHandle } = this._elements;\n\n    // zoom in zoom out using zoom handle\n    const sliderElm = snapView.querySelector('.iv-zoom-slider') as HTMLElement;\n    if (!sliderElm) {\n      throw new Error('Zoom slider element not found');\n    }\n\n    let leftOffset: number, handleWidth: number;\n\n    // on zoom slider we have to follow the mouse and set the handle to its position.\n    const zoomSlider = new Slider(sliderElm, {\n      isSliderEnabled: () => {\n        return this._state.loaded;\n      },\n      onStart: (eStart, position) => {\n        const { zoomSlider: slider } = this._sliders;\n\n        // P2-1 FIX: Use modern scroll position API (use helper - Issue A1.6)\n        const scroll = this._getScrollPosition();\n        leftOffset = sliderElm.getBoundingClientRect().left + scroll.x;\n        handleWidth = parseInt(getStyle(zoomHandle, 'width'), 10);\n\n        // REFACTOR: Pass required position parameter to slider.onMove (Issue C3.7)\n        // Move handle to current mouse position with zero delta (just started)\n        slider.onMove(eStart, { dx: 0, dy: 0, mx: position.x, my: position.y });\n      },\n      onMove: (e) => {\n        const { maxZoom } = this._options;\n        const { zoomSliderLength } = this._state;\n\n        let pageX: number;\n        if (e instanceof MouseEvent) {\n          pageX = e.pageX;\n        } else if (e instanceof TouchEvent) {\n          pageX = e.touches[0].pageX;\n        } else {\n          return;\n        }\n\n        if (!zoomSliderLength) return;\n        const newLeft = clamp(pageX - leftOffset - handleWidth / 2, 0, zoomSliderLength);\n        const zoomValue = 100 + ((maxZoom - 100) * newLeft) / zoomSliderLength;\n\n        this.zoom(zoomValue);\n      },\n      // REFACTOR: onEnd callback is now required (Issue E2.7)\n      onEnd: () => {\n        // No action needed on drag end for zoom slider\n      },\n    });\n\n    zoomSlider.init();\n    this._setSlider('zoomSlider', zoomSlider);\n  }\n\n  _initEvents() {\n    this._snapViewEvents();\n\n    // REFACTOR: Use EventManager for window resize event (Issue A1.5)\n    if (this._options.refreshOnResize) {\n      this.eventManager.on('windowResize', window, 'resize', () => this.refresh());\n    }\n  }\n\n  _snapViewEvents() {\n    const { imageWrap, snapView } = this._elements;\n\n    // REFACTOR: Use EventManager for snap view mouse move event (Issue A1.5)\n    this.eventManager.on('snapViewOnMouseMove', imageWrap, ['touchmove', 'mousemove'], () => {\n      this.showSnapView();\n    });\n\n    // REFACTOR: Use EventManager for snap view mouse enter event (Issue A1.5)\n    this.eventManager.on('mouseEnterSnapView', snapView, ['mouseenter', 'touchstart'], () => {\n      this._setSnapViewVisible(false);\n      this.showSnapView(true);\n    });\n\n    // REFACTOR: Use EventManager for snap view mouse leave event (Issue A1.5)\n    this.eventManager.on('mouseLeaveSnapView', snapView, ['mouseleave', 'touchend'], () => {\n      this._setSnapViewVisible(false);\n      this.showSnapView();\n    });\n\n    if (!this._options.hasZoomButtons) {\n      return;\n    }\n    const { zoomOut, zoomIn } = this._elements;\n\n    // REFACTOR: Use EventManager for zoom button events (Issue A1.5)\n    this.eventManager.on('zoomInClick', zoomIn, ['click'], () => {\n      // P3-5 FIX: Explicit null checking with numeric default (use helper - Issue A1.7)\n      const zoomStep = this._getZoomStep();\n      this.zoom(this._state.zoomValue + zoomStep);\n    });\n\n    this.eventManager.on('zoomOutClick', zoomOut, ['click'], () => {\n      // P3-5 FIX: Explicit null checking with numeric default (use helper - Issue A1.7)\n      const zoomStep = this._getZoomStep();\n      this.zoom(this._state.zoomValue - zoomStep);\n    });\n  }\n\n  _getImageCurrentDim() {\n    const { zoomValue, imageDim } = this._state;\n    return {\n      w: imageDim.w * (zoomValue / 100),\n      h: imageDim.h * (zoomValue / 100),\n    };\n  }\n\n  /**\n   * Loads the main image and optional high-resolution image\n   * Shows loader, handles image load/error events, and triggers dimension calculation\n   */\n  /**\n   * REFACTOR: Handle successful image load - called by ImageLoader (Issue C3.1)\n   * Race condition checking is handled by ImageLoader, so this is only called for valid loads\n   * @param _loadId - The load operation ID (unused, kept for interface compatibility)\n   */\n  private _handleImageLoadSuccess(_loadId: number): void {\n    const { hiResImageSrc } = this._images;\n\n    // Load high resolution image if provided\n    if (hiResImageSrc) {\n      this.imageLoader.loadHighRes(hiResImageSrc);\n    }\n\n    // Set loaded flag and calculate dimensions\n    this._setLoaded(true);\n    this._calculateDimensions();\n\n    // Dispatch image load event\n    if (this._listeners.onImageLoaded) {\n      this._listeners.onImageLoaded(this._callbackData);\n    }\n\n    // Reset the zoom\n    this.resetZoom();\n  }\n\n  /**\n   * REFACTOR: Handle image load error - called by ImageLoader (Issue C3.1)\n   * Race condition checking is handled by ImageLoader, so this is only called for valid loads\n   * @param _loadId - The load operation ID (unused, kept for interface compatibility)\n   * @param error - The error event\n   */\n  private _handleImageLoadError(_loadId: number, error: Event | ErrorEvent): void {\n    if (this._listeners.onImageError) {\n      this._listeners.onImageError(error);\n    }\n  }\n\n  /**\n   * REFACTOR: Simplified image loading using ImageLoader (Issue C3.1)\n   * ImageLoader handles: URL validation, element creation, event setup, race conditions\n   * ImageViewer handles: state updates, snap view hiding\n   */\n  _loadImages() {\n    const { imageSrc, hiResImageSrc } = this._images;\n\n    if (!imageSrc) {\n      throw new Error('No image source provided');\n    }\n\n    // Reset state\n    this._setLoaded(false);\n    this.hideSnapView();\n\n    // REFACTOR: Delegate image loading to ImageLoader (Issue C3.1)\n    // ImageLoader handles all loading logic including race conditions, validation, and UI\n    this.imageLoader.load(imageSrc, hiResImageSrc);\n  }\n\n  /**\n   * Calculates and stores dimensions for container, image, snap view, and zoom slider\n   * Ensures image fits container while maintaining aspect ratio\n   * Called after image load and on refresh\n   * REFACTOR: Uses DimensionCalculator for dimension calculations (Issue C3.1/C3.4)\n   */\n\n  /**\n   * REFACTOR: Main dimension calculation orchestrator (Issue C3.4/C3.1)\n   * Coordinates calculation and application of all viewer dimensions\n   * Now uses DimensionCalculator for cleaner separation of concerns\n   */\n  _calculateDimensions() {\n    const { image, container, snapView, snapImage, zoomHandle } = this._elements;\n\n    // Get current element dimensions\n    const imageWidth = parseInt(getStyle(image, 'width'), 10);\n    const imageHeight = parseInt(getStyle(image, 'height'), 10);\n    const contWidth = parseInt(getStyle(container, 'width'), 10);\n    const contHeight = parseInt(getStyle(container, 'height'), 10);\n\n    // Update container dimensions in state\n    this._setContainerDim({ w: contWidth, h: contHeight });\n\n    // Get natural image dimensions\n    const imgOriginWidth = (image as HTMLImageElement).naturalWidth || imageWidth;\n    const imgOriginHeight = (image as HTMLImageElement).naturalHeight || imageHeight;\n\n    // Calculate fitted image dimensions (use DimensionCalculator - Issue C3.1/C3.4)\n    const imageDim = DimensionCalculator.calculateFittedImageDimensions(\n      { w: contWidth, h: contHeight },\n      imgOriginWidth,\n      imgOriginHeight,\n    );\n    this._setImageDim(imageDim);\n\n    // Apply image dimensions and center it\n    setStyle(image, {\n      width: `${imageDim.w}px`,\n      height: `${imageDim.h}px`,\n      left: `${(contWidth - imageDim.w) / 2}px`,\n      top: `${(contHeight - imageDim.h) / 2}px`,\n      maxWidth: 'none',\n      maxHeight: 'none',\n    });\n\n    // Calculate snap view dimensions (use DimensionCalculator - Issue C3.1/C3.4)\n    const snapViewDim = {\n      w: snapView.clientWidth,\n      h: snapView.clientHeight,\n    };\n    const snapDim = DimensionCalculator.calculateSnapImageDimensions(imageDim, snapViewDim);\n    this._setSnapImageDim(snapDim);\n\n    // Apply snap image dimensions\n    setStyle(snapImage, {\n      width: `${snapDim.w}px`,\n      height: `${snapDim.h}px`,\n    });\n\n    // Calculate zoom slider length\n    const zoomSliderElem = snapView.querySelector('.iv-zoom-slider');\n    if (!zoomSliderElem) {\n      throw new Error('Zoom slider element not found');\n    }\n    const zoomSlider = zoomSliderElem.clientWidth;\n    this._setZoomSliderLength(zoomSlider - zoomHandle.offsetWidth);\n  }\n\n  /**\n   * Resets zoom to the initial zoomValue and centers the image\n   * @param animate - Whether to animate the zoom transition (default: true)\n   * @example\n   * ```typescript\n   * viewer.resetZoom(); // Animated reset\n   * viewer.resetZoom(false); // Instant reset\n   * ```\n   */\n  resetZoom(animate = true) {\n    const { zoomValue } = this._options;\n\n    if (!animate) {\n      this._setZoomValue(zoomValue);\n    }\n\n    this.zoom(zoomValue);\n  }\n\n  /**\n   * Zooms the image to a specific percentage\n   * REFACTOR: Simplified using ZoomAnimation helper (Issue A1.2/C3.3)\n   * Animates over 16 frames using easeOutQuart easing\n   * Automatically constrains image position to prevent showing empty space\n   * @param perc - Zoom percentage (clamped between 100 and maxZoom)\n   * @param point - Optional zoom center point {x, y} relative to container (defaults to center)\n   * @example\n   * ```typescript\n   * viewer.zoom(200); // Zoom to 200% centered\n   * viewer.zoom(300, { x: 100, y: 100 }); // Zoom to 300% at specific point\n   * ```\n   */\n  zoom(perc: number, point?: { x: number; y: number }): void {\n    const { _options, _elements, _state } = this;\n    const { zoomValue: curPerc, imageDim, containerDim, zoomSliderLength } = _state;\n    const { image, zoomHandle } = _elements;\n    const { maxZoom } = _options;\n\n    // Normalize parameters\n    perc = Math.round(Math.max(100, perc));\n    perc = Math.min(maxZoom, perc);\n\n    // P3-5 FIX: Explicit null checking for optional parameter\n    const zoomPoint =\n      point !== undefined && point !== null\n        ? point\n        : {\n            x: containerDim.w / 2,\n            y: containerDim.h / 2,\n          };\n\n    // P2-7 FIX: Add fallback for parseFloat to prevent NaN (use getStyle - Issue A1.10)\n    const curLeft = parseStyleFloat(image, 'left');\n    const curTop = parseStyleFloat(image, 'top');\n\n    // Clear any panning frames\n    this._clearFrames();\n\n    // Calculate bounds for position constraints\n    const bounds: ZoomBounds = {\n      baseLeft: (containerDim.w - imageDim.w) / 2,\n      baseTop: (containerDim.h - imageDim.h) / 2,\n      baseRight: containerDim.w - (containerDim.w - imageDim.w) / 2,\n      baseBottom: containerDim.h - (containerDim.h - imageDim.h) / 2,\n    };\n\n    // Create animation helper (Issue A1.2/C3.3)\n    const animation = new ZoomAnimation({\n      currentZoom: curPerc,\n      targetZoom: perc,\n      currentLeft: curLeft,\n      currentTop: curTop,\n      zoomPoint,\n      imageDim,\n      bounds,\n      totalFrames: ImageViewer.ZOOM_ANIMATION_FRAMES,\n    });\n\n    // Animate zoom for smooth transition\n    let step = 0;\n    const animateFrame = () => {\n      step++;\n\n      if (step < ImageViewer.ZOOM_ANIMATION_FRAMES) {\n        this._frames.zoomFrame = requestAnimationFrame(animateFrame);\n      }\n\n      // Get calculated frame data from animation helper\n      const frame = animation.getFrame(step);\n\n      // Update image styles\n      setStyle(image, {\n        width: `${frame.width}px`,\n        height: `${frame.height}px`,\n        left: `${frame.left}px`,\n        top: `${frame.top}px`,\n      });\n\n      // Update state\n      this._setZoomValue(frame.zoom);\n\n      // Update snap handle to match new image size/position\n      this._resizeSnapHandle(frame.width, frame.height, frame.left, frame.top);\n\n      // Update zoom slider handle position\n      setStyle(zoomHandle, {\n        left: `${((frame.zoom - 100) * (zoomSliderLength || 0)) / (maxZoom - 100)}px`,\n      });\n\n      // Dispatch zoom changed event\n      if (this._listeners.onZoomChange) {\n        this._listeners.onZoomChange(this._callbackData);\n      }\n    };\n\n    animateFrame();\n  }\n\n  /**\n   * Clears all active animation frames and intervals\n   * Prevents multiple animations from running simultaneously\n   */\n  _clearFrames(): void {\n    const { slideMomentumCheck, sliderMomentumFrame, zoomFrame, snapViewTimeout } = this._frames;\n\n    // P2-4 FIX: slideMomentumCheck now uses requestAnimationFrame\n    if (typeof slideMomentumCheck === 'number') {\n      cancelAnimationFrame(slideMomentumCheck);\n    }\n    if (typeof sliderMomentumFrame === 'number') {\n      cancelAnimationFrame(sliderMomentumFrame);\n    }\n    if (typeof zoomFrame === 'number') {\n      cancelAnimationFrame(zoomFrame);\n    }\n    // MEMORY LEAK FIX: Clear snapView timeout to prevent callbacks after destroy\n    if (typeof snapViewTimeout === 'number') {\n      clearTimeout(snapViewTimeout);\n    }\n  }\n\n  /**\n   * Updates snap handle size and position based on current image dimensions\n   * The snap handle represents the visible viewport area within the snap view\n   * @param imgWidth - Current image width (optional, calculated if not provided)\n   * @param imgHeight - Current image height (optional, calculated if not provided)\n   * @param imgLeft - Current image left position (optional, calculated if not provided)\n   * @param imgTop - Current image top position (optional, calculated if not provided)\n   */\n  _resizeSnapHandle(imgWidth: number, imgHeight: number, imgLeft: number, imgTop: number): void {\n    const { _elements, _state } = this;\n    const { snapHandle, image } = _elements;\n    const { imageDim, containerDim, zoomValue, snapImageDim } = _state;\n\n    const imageWidth = imgWidth || (imageDim.w * zoomValue) / 100;\n    const imageHeight = imgHeight || (imageDim.h * zoomValue) / 100;\n    // P2-7 FIX: Add fallback for parseFloat to prevent NaN (use getStyle - Issue A1.10)\n    const imageLeft = imgLeft || parseStyleFloat(image, 'left');\n    const imageTop = imgTop || parseStyleFloat(image, 'top');\n\n    // P2-6 FIX: Prevent division by zero\n    const left = imageWidth !== 0 ? (-imageLeft * snapImageDim.w) / imageWidth : 0;\n    const top = imageHeight !== 0 ? (-imageTop * snapImageDim.h) / imageHeight : 0;\n\n    const handleWidth = imageWidth !== 0 ? (containerDim.w * snapImageDim.w) / imageWidth : 0;\n    const handleHeight = imageHeight !== 0 ? (containerDim.h * snapImageDim.h) / imageHeight : 0;\n\n    setStyle(snapHandle, {\n      top: `${top}px`,\n      left: `${left}px`,\n      width: `${handleWidth}px`,\n      height: `${handleHeight}px`,\n    });\n\n    this._setSnapHandleDim({\n      w: handleWidth,\n      h: handleHeight,\n    });\n  }\n\n  /**\n   * Shows the snap view (minimap) when zoomed in\n   * Auto-hides after 1500ms unless noTimeout is true\n   * @param noTimeout - If true, keeps snap view visible without auto-hide\n   * @example\n   * ```typescript\n   * viewer.showSnapView(); // Shows for 1500ms\n   * viewer.showSnapView(true); // Shows until manually hidden\n   * ```\n   */\n  showSnapView(noTimeout?: boolean): void {\n    const { snapViewVisible, zoomValue, loaded } = this._state;\n    const { snapView } = this._elements;\n\n    if (!this._options.snapView) return;\n\n    if (snapViewVisible || zoomValue <= 100 || !loaded) return;\n\n    clearTimeout(this._frames.snapViewTimeout);\n\n    this._setSnapViewVisible(true);\n\n    setStyle(snapView, { opacity: '1', 'pointer-events': 'inherit' });\n\n    if (!noTimeout) {\n      // Auto-hide snap view after timeout\n      this._frames.snapViewTimeout = setTimeout(\n        () => this.hideSnapView(),\n        ImageViewer.SNAP_VIEW_TIMEOUT_MS,\n      );\n    }\n  }\n\n  /**\n   * Hides the snap view (minimap)\n   * @example\n   * ```typescript\n   * viewer.hideSnapView();\n   * ```\n   */\n  hideSnapView(): void {\n    const { snapView } = this._elements;\n    setStyle(snapView, { opacity: '0', 'pointer-events': 'none' });\n    this._setSnapViewVisible(false);\n  }\n\n  /**\n   * Recalculates dimensions and resets zoom\n   * Useful after container resize or orientation change\n   * @example\n   * ```typescript\n   * window.addEventListener('resize', () => viewer.refresh());\n   * ```\n   */\n  refresh(): void {\n    this._calculateDimensions();\n    this.resetZoom();\n  }\n\n  /**\n   * Loads a new image into the viewer\n   * @param imageSrc - URL of the image to load\n   * @param hiResImageSrc - Optional URL of high-resolution version\n   * @example\n   * ```typescript\n   * viewer.load('path/to/image.jpg');\n   * viewer.load('thumb.jpg', 'fullsize.jpg');\n   * ```\n   */\n  load(imageSrc: string, hiResImageSrc: string) {\n    // P3-4 FIX: Add error handling for image loading\n    try {\n      // REFACTOR: Use _setImageSources for validation and assignment (Issue E2.10)\n      this._setImageSources({ imageSrc, hiResImageSrc });\n\n      this._loadImages();\n    } catch (error) {\n      console.error('ImageViewer: Failed to load image', error);\n      if (this._listeners.onImageError) {\n        // Create an ErrorEvent for the callback\n        const errorEvent = new ErrorEvent('error', {\n          error: error instanceof Error ? error : new Error(String(error)),\n          message: error instanceof Error ? error.message : String(error),\n        });\n        this._listeners.onImageError(errorEvent);\n      }\n      throw error; // Re-throw to let callers handle it\n    }\n  }\n\n  /**\n   * Destroys the viewer instance and cleans up all resources\n   * Removes event listeners, sliders, frames, and DOM elements\n   * Restores the original element state if it was an IMG tag\n   * @example\n   * ```typescript\n   * viewer.destroy();\n   * ```\n   */\n  destroy() {\n    // P3-4 FIX: Add error handling for cleanup operations\n    try {\n      const { container, domElement } = this._elements;\n\n      // destroy all the sliders (use helper - Issue E2.5)\n      this._destroySlider('imageSlider');\n      this._destroySlider('snapSlider');\n      this._destroySlider('zoomSlider');\n\n      // REFACTOR: Destroy ImageLoader to cancel any pending loads (Issue C3.1)\n      this.imageLoader.destroy();\n\n      // REFACTOR: Destroy InteractionManager (Phase 7)\n      this.interactionManager.destroy();\n\n      // REFACTOR: Destroy EventManager to remove all managed events (Issue A1.5, Phase 6)\n      // All events now managed by EventManager (including FullScreen and InteractionManager)\n      this.eventManager.destroy();\n\n      // clear all the frames\n      this._clearFrames();\n\n      // REFACTOR: Use ImageViewerDOM for DOM cleanup (Phase 8)\n      this.dom.destroy(domElement, container);\n\n      // remove imageViewer reference from dom element\n      (domElement as HTMLElementWithViewer)._imageViewer = null;\n\n      if (this._listeners.onDestroy) {\n        this._listeners.onDestroy();\n      }\n    } catch (error) {\n      console.error('ImageViewer: Error during destroy', error);\n      // Don't re-throw - we want destroy to always complete\n    }\n  }\n}\n\nImageViewer.defaults = {\n  zoomValue: 100,\n  snapView: true,\n  maxZoom: 500,\n  refreshOnResize: true,\n  zoomOnMouseWheel: true,\n  hasZoomButtons: false,\n  zoomStep: 50,\n  listeners: {\n    onInit: undefined,\n    onDestroy: undefined,\n    onImageLoaded: undefined,\n    onZoomChange: undefined,\n    onImageError: undefined,\n  },\n};\n\nexport default ImageViewer;\n","import { createElement, setStyle, remove, removeCss } from './util';\nimport ImageViewer from './ImageViewer';\n\n// REFACTOR: Extract hardcoded CSS selectors to constants (Issue A1.9)\nconst FULLSCREEN_SELECTORS = {\n  FULLSCREEN: 'iv-fullscreen',\n  CONTAINER: 'iv-fullscreen-container',\n  CLOSE_BTN: 'iv-fullscreen-close',\n} as const;\n\nconst fullScreenHtml = `\n  <div class=\"${FULLSCREEN_SELECTORS.CONTAINER}\"></div>\n  <div class=\"${FULLSCREEN_SELECTORS.CLOSE_BTN}\"></div>\n`;\n\nclass FullScreenViewer extends ImageViewer {\n  /**\n   * Creates a fullscreen image viewer instance\n   * Extends ImageViewer with fullscreen-specific functionality and close button\n   * @param options - Configuration options passed to ImageViewer constructor\n   * @example\n   * ```typescript\n   * const viewer = new FullScreenViewer({ maxZoom: 800 });\n   * viewer.show('path/to/image.jpg');\n   * ```\n   */\n  constructor(options = {}) {\n    const fullScreenElem = createElement({\n      tagName: 'div',\n      className: FULLSCREEN_SELECTORS.FULLSCREEN,\n      html: fullScreenHtml,\n      trustedHTML: true,\n      parent: document.body,\n    });\n\n    const container = fullScreenElem.querySelector(\n      `.${FULLSCREEN_SELECTORS.CONTAINER}`,\n    ) as HTMLElement;\n    if (!container) {\n      throw new Error('Fullscreen container element not found');\n    }\n\n    // call the ImageViewer constructor\n    super(container, { ...options, refreshOnResize: false });\n\n    // add fullScreenElem on element list (use accessor method - Issue E2.1)\n    this._setElement('fullScreen', fullScreenElem);\n\n    this._initFullScreenEvents();\n  }\n  _initFullScreenEvents() {\n    const fullScreen = this._getElement('fullScreen');\n    if (!fullScreen) {\n      throw new Error('Fullscreen element not initialized');\n    }\n    const closeBtn = fullScreen.querySelector(`.${FULLSCREEN_SELECTORS.CLOSE_BTN}`) as HTMLElement;\n    if (!closeBtn) {\n      throw new Error('Fullscreen close button not found');\n    }\n\n    // REFACTOR: Use EventManager for close button event (Phase 6.1)\n    this.eventManager.on('onCloseBtnClick', closeBtn, 'click', this.hide as EventListener);\n  }\n  /**\n   * Shows the fullscreen viewer with an image\n   * Disables page scrolling and adds window resize handler\n   * @param imageSrc - URL of the image to display\n   * @param hiResImageSrc - Optional URL of high-resolution version\n   * @example\n   * ```typescript\n   * viewer.show('image.jpg', 'image-hd.jpg');\n   * ```\n   */\n  show(imageSrc: string, hiResImageSrc: string) {\n    // show the element (use accessor method - Issue E2.1, use setStyle - Issue A1.10)\n    const fullScreen = this._getElement('fullScreen');\n    if (fullScreen) {\n      setStyle(fullScreen, { display: 'block' });\n    }\n\n    // if image source is provide load image source\n    if (imageSrc) {\n      this.load(imageSrc, hiResImageSrc);\n    }\n\n    // REFACTOR: Use EventManager for window resize event (Phase 6.1)\n    // Note: This replaces any existing onWindowResize from ImageViewer\n    this.eventManager.on('onWindowResize', window, 'resize', () => this.refresh());\n\n    // disable scroll on html (use setStyle - Issue A1.10)\n    const htmlElem = document.querySelector('html');\n    if (htmlElem) {\n      setStyle(htmlElem as HTMLElement, { overflow: 'hidden' });\n    }\n  }\n  /**\n   * Hides the fullscreen viewer\n   * Re-enables page scrolling and removes window resize handler\n   * @example\n   * ```typescript\n   * viewer.hide();\n   * ```\n   */\n  hide = () => {\n    // hide the fullscreen (use accessor method - Issue E2.1, use setStyle - Issue A1.10)\n    const fullScreen = this._getElement('fullScreen');\n    if (fullScreen) {\n      setStyle(fullScreen, { display: 'none' });\n    }\n\n    // enable scroll\n    const htmlElem = document.querySelector('html');\n    if (htmlElem) {\n      removeCss(htmlElem as HTMLElement, 'overflow');\n    }\n\n    // REFACTOR: Use EventManager to remove window resize event (Phase 6.1)\n    this.eventManager.off('onWindowResize');\n  };\n  /**\n   * Destroys the fullscreen viewer and removes it from the DOM\n   * Calls parent ImageViewer destroy method first\n   * @example\n   * ```typescript\n   * viewer.destroy();\n   * ```\n   */\n  destroy() {\n    // get fullScreen element (use accessor method - Issue E2.1)\n    const fullScreen = this._getElement('fullScreen');\n\n    // destroy image viewer\n    super.destroy();\n\n    // remove the element\n    if (fullScreen) {\n      remove(fullScreen);\n    }\n  }\n}\n\nexport default FullScreenViewer;\n"],"names":["easeOutQuart","currentTime","startValue","changedValue","duration","isValidImageUrl","url","parsed","URL","window","location","href","includes","protocol","e","createElement","options","elem","document","tagName","id","html","trustedHTML","Error","innerHTML","className","src","HTMLImageElement","setAttribute","style","setStyle","child","appendChild","insertBefore","parent","addClass","el","classNameAry","split","length","forEach","classItem","classList","add","removeClass","remove","replace","RegExp","trim","imageLoaded","img","complete","naturalWidth","toArray","list","HTMLElement","NodeList","HTMLCollection","Array","prototype","slice","call","getStyle","element","property","styles","getComputedStyle","value","getPropertyValue","propValue","String","parseStyleFloat","defaultValue","parseFloat","isNaN","elements","properties","Object","keys","key","stringValue","lower","toLowerCase","sanitizedValue","setProperty","Element","parentNode","removeChild","clamp","num","min","max","Math","assignEvent","events","handler","eventList","isArray","event","addEventListener","removeEventListener","getTouchPointsDistance","touches","touch0","touch1","sqrt","pow","pageX","pageY","ZoomAnimation","constructor","config","__publicField","this","currentZoom","targetZoom","currentLeft","currentTop","zoomPoint","imageDim","bounds","totalFrames","getFrame","step","tickZoom","width","w","height","h","position","calculatePosition","constrainedPosition","constrainToBounds","zoom","left","top","ratio","x","y","baseLeft","baseTop","baseRight","baseBottom","DimensionCalculator","calculateFittedImageDimensions","containerDim","naturalHeight","imgWidth","calculateSnapImageDimensions","snapViewDim","calculateAllDimensions","params","snapImageDim","calculateSnapHandleDimensions","MomentumCalculator","calculateDelta","positions","xDiff","yDiff","shouldApplyMomentum","thresholdPx","abs","calculateMomentumFrame","startPos","delta","velocityFactor","animationFrames","xOffset","yOffset","positionX","dx","positionY","dy","shouldContinue","convertToSnapCoordinates","SliderCoordinator","snapSlider","getImageDim","getSnapImageDim","notifyPanStart","onStart","syncSnapSliderPosition","imagePosition","updatePosition","mx","my","getSnapSlider","ViewerHTMLTemplates","createZoomInButton","hasZoomButtons","createZoomOutButton","createViewerHTML","ImageLoader","onLoadSuccess","onLoadError","Map","load","imageSrc","hiResImageSrc","container","_cancelPreviousLoads","loadId","loadCounter","ivLoader","querySelector","querySelectorAll","snapImage","image","_createImageElements","display","visibility","onImageLoad","_handleLoadSuccess","onImageError","_handleLoadError","imageLoadRemover","imageErrorRemover","activeLoads","set","loadHighRes","imageWrap","lowResImg","hiResImage","lowResStyles","maxWidth","maxHeight","onHighResImageLoad","hiResLoadRemover","destroy","snapImageWrap","firstChild","__spreadProps","__spreadValues","error","remover","clear","EventManager","on","name","target","eventType","off","removeListener","listeners","listener","get","delete","count","size","has","getNames","from","ImageViewerDOM","initialize","imageViewHtml","validateImageUrl","domElement","_resolveElement","_imageViewer","result","_processImgElement","sources","_extractImageSourcesFromContainer","_createStructure","getElements","getElement","setElement","ivWrap","body","_a","_b","unwrap","foundElement","imgElement","rawSrc","rawHiResSrc","getAttribute","tag","wrapper","overflow","wrap","opacity","containerElement","snapView","snapHandle","zoomHandle","zoomIn","zoomOut","_InteractionManager","eventManager","callbacks","setupInteractions","setupPinchZoom","setupWheelZoom","setupDoubleTap","eStart","loaded","zoomValue","startZoomValue","getState","setZooming","contOffset","getBoundingClientRect","startDist","scroll","getScrollPosition","center","calculatePinchCenter","eMove","newDist","calculatePinchZoom","eEnd","getSlider","startHandler","changedDelta","zoomOnMouseWheel","clearFrames","normalizeWheelDelta","newZoomValue","maxZoom","preventDefault","getMousePositionRelativeToContainer","showSnapView","point","touchTime","Date","now","DOUBLE_TAP_INTERVAL_MS","DOUBLE_TAP_DISTANCE_PX","DOUBLE_TAP_ZOOM_LEVEL","resetZoom","containerOffset","currentDist","legacyEvent","wheelDelta","detail","deltaY","InteractionManager","Slider","onMove","onEnd","isSliderEnabled","removeListeners","cancelable","moveHandler","endHandler","_onStart","sx","sy","isTouchEvent","touchEvent","touchMoveEvent","touchEndEvent","clientX","clientY","mouseEvent","_onMove","_onEnd","syntheticEvent","Event","type","init","evt","_ImageViewer","_options","defaults","dom","context","_validateImageUrl","_elements","_listeners","_frames","_sliders","_state","zooming","snapViewVisible","zoomSliderLength","snapHandleDim","_images","imageLoader","_handleImageLoadSuccess","_handleImageLoadError","interactionManager","_c","_setZooming","_clearFrames","_getSlider","_getScrollPosition","_init","_loadImages","_callbackData","reachedMin","round","reachedMax","instance","_setZoomValue","_setLoaded","_setSnapViewVisible","visible","_setContainerDim","dim","_setImageDim","_setSnapImageDim","_setSnapHandleDim","_setZoomSliderLength","_getElement","_setElement","_setSlider","slider","_destroySlider","urlType","_setImageSources","validatedImageSrc","validatedHiResImageSrc","pageXOffset","scrollX","pageYOffset","scrollY","_getZoomStep","zoomStep","_calculateMomentumDelta","_shouldApplyMomentum","MOMENTUM_THRESHOLD_PX","_applyMomentumAnimation","currentPos","imageCurrentDim","cumulativeX","cumulativeY","MOMENTUM_VELOCITY_FACTOR","MOMENTUM_ANIMATION_FRAMES","momentum","frame","sliderMomentumFrame","requestAnimationFrame","finalPosX","finalPosY","snapCoords","_initImageSlider","_initSnapSlider","_initZoomSlider","_initEvents","onInit","sliderCoordinator","_getImageCurrentDim","imageSlider","lastSampleTime","performance","sampleInterval","MOMENTUM_SAMPLE_INTERVAL_MS","trackPosition","shift","push","slideMomentumCheck","_e","_calculateSnapHandlePosition","startLeft","startTop","maxLeft","maxTop","_convertSnapToImagePosition","snapPosition","startHandleTop","startHandleLeft","cancelAnimationFrame","_","handlePos","imagePos","sliderElm","leftOffset","handleWidth","zoomSlider","parseInt","MouseEvent","TouchEvent","_snapViewEvents","refreshOnResize","refresh","_loadId","_calculateDimensions","onImageLoaded","hideSnapView","imageWidth","imageHeight","contWidth","contHeight","imgOriginWidth","imgOriginHeight","clientWidth","clientHeight","snapDim","zoomSliderElem","offsetWidth","animate","perc","curPerc","curLeft","curTop","animation","ZOOM_ANIMATION_FRAMES","animateFrame","zoomFrame","_resizeSnapHandle","onZoomChange","snapViewTimeout","clearTimeout","imgHeight","imgLeft","imgTop","imageLeft","imageTop","handleHeight","noTimeout","setTimeout","SNAP_VIEW_TIMEOUT_MS","console","errorEvent","ErrorEvent","message","onDestroy","ImageViewer","FULLSCREEN_SELECTORS","fullScreenHtml","fullScreenElem","super","fullScreen","htmlElem","removeProperty","_initFullScreenEvents","closeBtn","hide","show"],"mappings":"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"}