!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ImageViewer={})}(this,function(e){"use strict";var t=Object.defineProperty,i=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,r=(e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s,l=(e,t)=>{for(var i in t||(t={}))o.call(t,i)&&r(e,i,t[i]);if(n)for(var i of n(t))a.call(t,i)&&r(e,i,t[i]);return e},h=(e,t)=>i(e,s(t)),c=(e,t,i)=>r(e,"symbol"!=typeof t?t+"":t,i);function m(e,t,i,s){return e/=s,-i*((e-=1)*e*e*e-1)+t}function d(e){if(!e)return!1;try{const t=new URL(e,window.location.href);return["http:","https:","blob:"].includes(t.protocol)}catch(t){return!1}}function u(e){const t=document.createElement(e.tagName);if(e.id&&(t.id=e.id),e.html){if(!e.trustedHTML)throw new Error("innerHTML requires trustedHTML=true to avoid XSS risks");t.innerHTML=e.html}if(e.className&&(t.className=e.className),e.src&&t instanceof HTMLImageElement){if(!d(e.src))throw new Error(`Invalid or unsafe image URL protocol: ${e.src}`);t.setAttribute("src",e.src)}return e.style&&S(t,e.style),e.child&&t.appendChild(e.child),e.insertBefore?e.parent.insertBefore(t,e.insertBefore):e.parent.appendChild(t),t}function g(e,t){const i=t.split(" ");i.length>1?i.forEach(t=>g(e,t)):e.classList?e.classList.add(t):e.className+=` ${t}`}function p(e,t){const i=t.split(" ");i.length>1?i.forEach(t=>p(e,t)):e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(`(^|\\s)${t}(\\s|$)`,"g")," ").trim()}function _(e){return e.complete&&(void 0===e.naturalWidth||0!==e.naturalWidth)}function f(e){return e instanceof HTMLElement?[e]:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e):[]}function v(e,t){const i=window.getComputedStyle(e),s=i.getPropertyValue(t);if(s)return s;if(t in i){const e=i[t];return"string"==typeof e?e:String(e)}return""}function w(e,t,i=0){const s=v(e,t),n=parseFloat(s);return isNaN(n)?i:n}function S(e,t){f(e).forEach(e=>{e instanceof HTMLElement&&Object.keys(t).forEach(i=>{const s=t[i],n=String(s),o=n.toLowerCase();if(o.includes("javascript:")||o.includes("expression("))throw new Error("Blocked unsafe CSS value");const a=n.replace(/[<>'"]/g,"");e.style[i]=a})})}function E(e){f(e).forEach(e=>{e instanceof Element&&e.parentNode&&e.parentNode.removeChild(e)})}function y(e,t,i){return Math.min(Math.max(e,t),i)}function M(e,t,i){const s=Array.isArray(t)?t:[t],n=s.some(e=>"wheel"===e)?{passive:!1}:void 0;return s.forEach(t=>e.addEventListener(t,i,n)),()=>{s.forEach(t=>e.removeEventListener(t,i))}}function I(e){const t=e[0],i=e[1];return Math.sqrt(Math.pow(i.pageX-t.pageX,2)+Math.pow(i.pageY-t.pageY,2))}class L{constructor(e){c(this,"currentZoom"),c(this,"targetZoom"),c(this,"currentLeft"),c(this,"currentTop"),c(this,"zoomPoint"),c(this,"imageDim"),c(this,"bounds"),c(this,"totalFrames"),this.currentZoom=e.currentZoom,this.targetZoom=e.targetZoom,this.currentLeft=e.currentLeft,this.currentTop=e.currentTop,this.zoomPoint=e.zoomPoint,this.imageDim=e.imageDim,this.bounds=e.bounds,this.totalFrames=e.totalFrames}getFrame(e){const t=m(e,this.currentZoom,this.targetZoom-this.currentZoom,this.totalFrames),i=this.imageDim.w*t/100,s=this.imageDim.h*t/100,n=this.calculatePosition(t),o=this.constrainToBounds(n,i,s);return{zoom:t,width:i,height:s,left:o.left,top:o.top}}calculatePosition(e){const t=e/this.currentZoom;return{left:-((this.zoomPoint.x-this.currentLeft)*t-this.zoomPoint.x),top:-((this.zoomPoint.y-this.currentTop)*t-this.zoomPoint.y)}}constrainToBounds(e,t,i){let{left:s,top:n}=e;const{baseLeft:o,baseTop:a,baseRight:r,baseBottom:l}=this.bounds;return s=Math.min(s,o),n=Math.min(n,a),s+t<r&&(s=r-t),n+i<l&&(n=l-i),{left:s,top:n}}}class b{static calculateFittedImageDimensions(e,t,i){const s=t/i,n=t>i&&e.h>=e.w||s*e.h>e.w?e.w:s*e.h;return{w:n,h:n/s}}static calculateSnapImageDimensions(e,t){return{w:e.w>e.h?t.w:e.w*t.h/e.h,h:e.h>e.w?t.h:e.h*t.w/e.w}}static calculateAllDimensions(e){const{containerDim:t,naturalWidth:i,naturalHeight:s,snapViewDim:n}=e,o=this.calculateFittedImageDimensions(t,i,s);return{imageDim:o,snapImageDim:this.calculateSnapImageDimensions(o,n)}}static calculateSnapHandleDimensions(e,t,i){return{w:0!==t.w?i.w*e.w/t.w:e.w,h:0!==t.h?i.h*e.h/t.h:e.h}}}class z{static calculateDelta(e){return e.length<2?{xDiff:0,yDiff:0}:{xDiff:e[1].x-e[0].x,yDiff:e[1].y-e[0].y}}static shouldApplyMomentum(e,t,i){return Math.abs(e)>i||Math.abs(t)>i}static calculateMomentumFrame(e,t,i,s){const{xDiff:n,yDiff:o}=i,{velocityFactor:a,animationFrames:r}=s,l=m(e,n*a,-n*a,r),h=m(e,o*a,-o*a,r);return{positionX:t.dx+l,positionY:t.dy+h,shouldContinue:e<r}}static convertToSnapCoordinates(e,t,i){return{dx:0!==t.w?-e.x*i.w/t.w:0,dy:0!==t.h?-e.y*i.h/t.h:0}}}class D{constructor(e,t){c(this,"snapSlider"),c(this,"getImageDim"),c(this,"getSnapImageDim"),this.snapSlider=e,this.getImageDim=t.getImageDim,this.getSnapImageDim=t.getSnapImageDim}notifyPanStart(e){this.snapSlider.onStart(e,{x:0,y:0})}syncSnapSliderPosition(e){const t=this.getImageDim(),i=this.getSnapImageDim(),s=0!==t.w?-e.dx*i.w/t.w:0,n=0!==t.h?-e.dy*i.h/t.h:0;this.snapSlider.updatePosition({dx:s,dy:n,mx:0,my:0})}getSnapSlider(){return this.snapSlider}}class V{static createZoomInButton(e){return e?'<div class="iv-button-zoom--in" role="button"></div>':""}static createZoomOutButton(e){return e?'<div class="iv-button-zoom--out" role="button"></div>':""}static createViewerHTML(e){return`\n  <div class="iv-loader"></div>\n  <div class="iv-snap-view">\n    <div class="iv-snap-image-wrap">\n      <div class="iv-snap-handle"></div>\n    </div>\n    <div class="iv-zoom-actions ${e?"iv-zoom-actions--has-buttons":""}">\n      ${this.createZoomInButton(e)}\n      <div class="iv-zoom-slider">\n        <div class="iv-zoom-handle"></div>\n      </div>\n      ${this.createZoomOutButton(e)}\n    </div>\n  </div>\n  <div class="iv-image-view" >\n    <div class="iv-image-wrap" ></div>\n  </div>\n`}}const x=class e{constructor(e,t,i,s){c(this,"loadCounter",0),c(this,"activeLoads",new Map),this.elements=e,this.onLoadSuccess=t,this.onLoadError=i,this.onHighResLoaded=s}load(e,t){const{container:i}=this.elements;if(!i)throw new Error("Container element not found");this._cancelPreviousLoads();const s=++this.loadCounter,n=i.querySelector(".iv-loader");if(!n)throw new Error("Loader element not found");E(i.querySelectorAll(".iv-snap-image, .iv-image"));const o=this.sanitizeImageSrc(e),{snapImage:a,image:r}=this._createImageElements(o);this.elements.image=r,this.elements.snapImage=a,S(n,{display:"block"}),S(r,{visibility:"hidden"});const l=()=>{this._handleLoadSuccess(s,t)},h=e=>{this._handleLoadError(s,e)};if(_(r))l();else{const e=M(r,"load",l),t=M(r,"error",h);this.activeLoads.set("imageLoad",e),this.activeLoads.set("imageError",t)}return s}loadHighRes(e){const{imageWrap:t}=this.elements;if(!t)throw new Error("Image wrap element not found");const i=this.sanitizeImageSrc(e),s=this.elements.image;if(!s)throw new Error("Low-res image not found");const n=this.activeLoads.get("hiResImageLoad");n&&(n(),this.activeLoads.delete("hiResImageLoad"));const o=u({tagName:"img",className:"iv-image iv-large-image",src:i,parent:t}),a=window.getComputedStyle(s);S(o,{width:a.width,height:a.height,left:a.left,top:a.top,maxWidth:a.maxWidth,maxHeight:a.maxHeight,visibility:a.visibility});const r=()=>{const e=this.activeLoads.get("hiResImageLoad");null==e||e(),this.activeLoads.delete("hiResImageLoad"),E(s),this.elements.image=o;t.querySelectorAll(".iv-image").forEach(e=>{e!==o&&E(e)}),this.onHighResLoaded&&this.onHighResLoaded()},l=M(o,"load",r);this.activeLoads.set("hiResImageLoad",l),_(o)&&r()}destroy(){this._cancelPreviousLoads()}_createImageElements(e){const t=this.sanitizeImageSrc(e),{snapImageWrap:i,imageWrap:s}=this.elements;if(!i||!s)throw new Error("Image wrap elements not found");const n=i.firstChild,o=u(h(l({tagName:"img",className:"iv-snap-image"},n?{insertBefore:n}:{}),{parent:i}));o.setAttribute("src",t);const a=u({tagName:"img",className:"iv-image iv-small-image",parent:s});return a.setAttribute("src",t),{snapImage:o,image:a}}sanitizeImageSrc(t){if(!d(t))throw new Error(`Invalid or unsafe image URL: ${t}`);const i=new URL(t,window.location.href);if(!e.ALLOWED_PROTOCOLS.includes(i.protocol))throw new Error(`Invalid or unsafe image URL protocol: ${t}`);return i.href}_handleLoadSuccess(e,t){if(e!==this.loadCounter)return;const{container:i}=this.elements;if(!i)return;const s=i.querySelector(".iv-loader"),n=this.elements.image;s&&S(s,{display:"none"}),n&&S(n,{visibility:"visible"}),t&&this.loadHighRes(t),this.onLoadSuccess(e)}_handleLoadError(e,t){if(e!==this.loadCounter)return;const{container:i}=this.elements;if(!i)return;const s=i.querySelector(".iv-loader");s&&S(s,{display:"none"}),this.onLoadError(e,t)}_cancelPreviousLoads(){this.activeLoads.forEach(e=>e()),this.activeLoads.clear()}};c(x,"ALLOWED_PROTOCOLS",["http:","https:","blob:"]);let T=x;class O{constructor(){c(this,"listeners",new Map)}on(e,t,i,s){this.off(e);const n=M(t,i,s);return this.listeners.set(e,n),n}off(e){const t=this.listeners.get(e);return!!t&&(t(),this.listeners.delete(e),!0)}destroy(){this.listeners.forEach(e=>e()),this.listeners.clear()}count(){return this.listeners.size}has(e){return this.listeners.has(e)}getNames(){return Array.from(this.listeners.keys())}}class A{constructor(){c(this,"elements",{})}initialize(e,t,i){const s=this._resolveElement(e);if(s._imageViewer)throw new Error("An image viewer is already being initiated on the element.");let n,o,a;if("IMG"===s.tagName){const e=this._processImgElement(s,i);n=e.container,o=e.imageSrc,a=e.hiResImageSrc}else{n=s;const e=this._extractImageSourcesFromContainer(s,i);o=e.imageSrc,a=e.hiResImageSrc}return this.elements={container:n,domElement:s},this._createStructure(n,t),{container:n,domElement:s,imageSrc:o,hiResImageSrc:a,elements:this.elements}}getElements(){return this.elements}getElement(e){return this.elements[e]}setElement(e,t){this.elements[e]=t}destroy(e,t){const i=t.querySelector(".iv-wrap");i&&E(i),p(t,"iv-container"),e!==t&&function(e){var t,i;const s=e.parentNode;s&&s!==document.body&&(null==(t=s.parentNode)||t.insertBefore(e,s),null==(i=s.parentNode)||i.removeChild(s))}(e)}_resolveElement(e){if("string"==typeof e){const t=document.querySelector(e);if(!t)throw new Error(`Element not found: ${e}`);return t}return e}_processImgElement(e,t){const i=e.src,s=e.getAttribute("high-res-src")||e.getAttribute("data-high-res-src"),n=t(i,"main"),o=t(s,"hiRes");if(!n)throw new Error("Invalid or unsafe image URL protocol");const a=function(e,{tag:t="div",className:i,id:s,style:n}){const o=document.createElement(t);o.className=i,s&&(o.id=s),n&&(n.display&&(o.style.display=n.display),n.overflow&&(o.style.overflow=n.overflow));const a=e.parentNode;if(!a)throw new Error("element does not have a parent node");return a.insertBefore(o,e),a.removeChild(e),o.appendChild(e),o}(e,{className:"iv-container iv-image-mode",style:{display:"inline-block",overflow:"hidden"}});return S(e,{opacity:"0",position:"relative","z-index":"-1"}),{container:a,imageSrc:n,hiResImageSrc:o}}_extractImageSourcesFromContainer(e,t){const i=e.getAttribute("src")||e.getAttribute("data-src"),s=e.getAttribute("high-res-src")||e.getAttribute("data-high-res-src");return{imageSrc:t(i,"main"),hiResImageSrc:t(s,"hiRes")}}_createStructure(e,t){u({tagName:"div",className:"iv-wrap",html:t,trustedHTML:!0,parent:e}),g(e,"iv-container"),"static"===v(e,"position")&&S(e,{position:"relative"});const i=e.querySelector(".iv-snap-view"),s=e.querySelector(".iv-snap-image-wrap"),n=e.querySelector(".iv-image-wrap"),o=e.querySelector(".iv-snap-handle"),a=e.querySelector(".iv-zoom-handle"),r=e.querySelector(".iv-button-zoom--in"),c=e.querySelector(".iv-button-zoom--out");if(!(i&&s&&n&&o&&a))throw new Error("Required viewer elements not found in container");this.elements=h(l({},this.elements),{snapView:i,snapImageWrap:s,imageWrap:n,snapHandle:o,zoomHandle:a,zoomIn:r||void 0,zoomOut:c||void 0})}}const R=class e{constructor(e,t,i,s){this.elements=e,this.eventManager=t,this.options=i,this.callbacks=s}setupInteractions(){this.setupPinchZoom(),this.setupWheelZoom(),this.setupDoubleTap()}setupPinchZoom(){const{imageWrap:e,container:t}=this.elements;this.eventManager.on("pinchStart",e,"touchstart",e=>{const{loaded:i,zoomValue:s}=this.callbacks.getState();if(!i)return;const n=e.touches[0],o=e.touches[1];if(!n||!o)return;this.callbacks.setZooming(!0);const a=t.getBoundingClientRect(),r=I(e.touches),l=this.callbacks.getScrollPosition(),h=this.calculatePinchCenter(n,o,a,l);this.eventManager.off("pinchMove"),this.eventManager.off("pinchEnd"),this.eventManager.on("pinchMove",document,"touchmove",e=>{const t=I(e.touches),i=this.calculatePinchZoom(s,r,t);this.callbacks.zoom(i,h)}),this.eventManager.on("pinchEnd",document,"touchend",e=>{var t;this.eventManager.off("pinchMove"),this.eventManager.off("pinchEnd"),this.callbacks.setZooming(!1),1===e.touches.length&&(null==(t=this.callbacks.getSlider("imageSlider"))||t.startHandler(e))})})}setupWheelZoom(){const{container:e,imageWrap:t}=this.elements;let i=0;this.eventManager.on("wheelZoom",t,"wheel",t=>{const{loaded:s,zoomValue:n}=this.callbacks.getState();if(!this.options.zoomOnMouseWheel||!s)return;this.callbacks.clearFrames();const o=this.normalizeWheelDelta(t),a=n*(100+15*o)/100;if(a>=100&&a<=this.options.maxZoom?i=0:i+=Math.abs(o),t.preventDefault(),i>5)return;const r=e.getBoundingClientRect(),l=this.getMousePositionRelativeToContainer(t,r);this.callbacks.zoom(a,l),this.callbacks.showSnapView()})}setupDoubleTap(){const{imageWrap:t}=this.elements;let i,s=0;this.eventManager.on("doubleTapClick",t,"click",t=>{const{zoomValue:n}=this.callbacks.getState();0===s?(s=Date.now(),i={x:t.pageX,y:t.pageY}):Date.now()-s<e.DOUBLE_TAP_INTERVAL_MS&&Math.abs(t.pageX-i.x)<e.DOUBLE_TAP_DISTANCE_PX&&Math.abs(t.pageY-i.y)<e.DOUBLE_TAP_DISTANCE_PX?(n===this.options.zoomValue?this.callbacks.zoom(e.DOUBLE_TAP_ZOOM_LEVEL):this.callbacks.resetZoom(),s=0):s=0})}destroy(){}calculatePinchCenter(e,t,i,s){return{x:(t.pageX+e.pageX)/2-(i.left+s.x),y:(t.pageY+e.pageY)/2-(i.top+s.y)}}calculatePinchZoom(e,t,i){return e+(i-t)/2}normalizeWheelDelta(e){const t=e;return Math.max(-1,Math.min(1,t.wheelDelta||-e.detail||-e.deltaY))}getMousePositionRelativeToContainer(e,t){const i=this.callbacks.getScrollPosition();return{x:e.pageX-(t.left+i.x),y:e.pageY-(t.top+i.y)}}};c(R,"DOUBLE_TAP_INTERVAL_MS",500),c(R,"DOUBLE_TAP_DISTANCE_PX",50),c(R,"DOUBLE_TAP_ZOOM_LEVEL",200);let P=R;class Z{constructor(e,{onStart:t,onMove:i,onEnd:s,isSliderEnabled:n}){if(c(this,"_onStart"),c(this,"_onMove"),c(this,"_onEnd"),c(this,"isSliderEnabled"),c(this,"container"),c(this,"touchMoveEvent"),c(this,"touchEndEvent"),c(this,"sx",0),c(this,"sy",0),c(this,"startHandler",e=>{if(!this.isSliderEnabled())return;this.removeListeners(),e.cancelable&&e.preventDefault();const{moveHandler:t,endHandler:i,_onStart:s}=this;let n,o;if(this.isTouchEvent(e)){const t=e;this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",n=t.touches[0].clientX,o=t.touches[0].clientY}else{const t=e;this.touchMoveEvent="mousemove",this.touchEndEvent="mouseup",n=t.clientX,o=t.clientY}this.sx=n,this.sy=o,s(e,{x:this.sx,y:this.sy}),document.addEventListener(this.touchMoveEvent,t),document.addEventListener(this.touchEndEvent,i),document.addEventListener("contextmenu",i)}),c(this,"moveHandler",e=>{if(!this.isSliderEnabled())return;e.cancelable&&e.preventDefault();const{sx:t,sy:i,_onMove:s}=this;let n,o;if(this.isTouchEvent(e)){const t=e;n=t.touches[0].clientX,o=t.touches[0].clientY}else{const t=e;n=t.clientX,o=t.clientY}s(e,{dx:n-t,dy:o-i,mx:n,my:o})}),c(this,"endHandler",()=>{this.isSliderEnabled()&&(this.removeListeners(),this._onEnd())}),"function"!=typeof t)throw new Error("Slider: onStart callback is required and must be a function");if("function"!=typeof i)throw new Error("Slider: onMove callback is required and must be a function");if("function"!=typeof s)throw new Error("Slider: onEnd callback is required and must be a function");this.container=e,this.isSliderEnabled=n||(()=>!0),this._onStart=t,this._onMove=i,this._onEnd=s}onStart(e,t){return this._onStart(e,t)}onMove(e,t){return this._onMove(e,t)}updatePosition(e){const t=new Event("programmatic-update");this._onMove(t,e)}isTouchEvent(e){return"touchstart"===e.type||"touchmove"===e.type||"touchend"===e.type}removeListeners(){this.touchMoveEvent&&document.removeEventListener(this.touchMoveEvent,this.moveHandler),this.touchEndEvent&&document.removeEventListener(this.touchEndEvent,this.endHandler),document.removeEventListener("contextmenu",this.endHandler)}init(){["touchstart","mousedown"].forEach(e=>{this.container.addEventListener(e,this.startHandler)})}destroy(){["touchstart","mousedown"].forEach(e=>{this.container.removeEventListener(e,this.startHandler)}),this.removeListeners()}}const H=class e{constructor(t,i={}){c(this,"_elements"),c(this,"_options"),c(this,"_listeners"),c(this,"_state"),c(this,"_sliders"),c(this,"_frames"),c(this,"_images"),c(this,"imageLoader"),c(this,"eventManager"),c(this,"dom"),c(this,"interactionManager"),this._options=l(l({},e.defaults),i),this.dom=new A;const{domElement:s,imageSrc:n,hiResImageSrc:o,elements:a}=this.dom.initialize(t,V.createViewerHTML(this._options.hasZoomButtons),(e,t)=>this._validateImageUrl(e,t));this._elements=a,this._listeners=void 0!==this._options.listeners&&null!==this._options.listeners?this._options.listeners:{},this._frames={},this._sliders={},this._state={zoomValue:this._options.zoomValue,loaded:!1,imageDim:{w:0,h:0},containerDim:{w:0,h:0},snapImageDim:{w:0,h:0},zooming:!1,snapViewVisible:!1,zoomSliderLength:0,snapHandleDim:{w:0,h:0}},this._images={imageSrc:n,hiResImageSrc:o},this.imageLoader=new T(this._elements,e=>this._handleImageLoadSuccess(e),(e,t)=>this._handleImageLoadError(e,t),()=>this._handleHighResLoaded()),this.eventManager=new O,this.interactionManager=new P({imageWrap:this._elements.imageWrap,container:this._elements.container},this.eventManager,{zoomOnMouseWheel:this._options.zoomOnMouseWheel,zoomValue:this._options.zoomValue,maxZoom:this._options.maxZoom},{getState:()=>{var e,t,i;return{loaded:null!=(e=this._state.loaded)&&e,zoomValue:null!=(t=this._state.zoomValue)?t:100,zooming:null!=(i=this._state.zooming)&&i}},setZooming:e=>this._setZooming(e),clearFrames:()=>this._clearFrames(),zoom:(e,t)=>this.zoom(e,t),resetZoom:()=>this.resetZoom(),showSnapView:()=>this.showSnapView(),getSlider:e=>this._getSlider(e),getScrollPosition:()=>this._getScrollPosition()}),this._init(),n&&this._loadImages(),s._imageViewer=this}get imageViewHtml(){return V.createViewerHTML(this._options.hasZoomButtons)}get _callbackData(){if(!this._elements.container||!this._elements.snapView)throw new Error("ImageViewer elements not initialized. Cannot get callback data.");return{container:this._elements.container,snapView:this._elements.snapView,zoomValue:this._state.zoomValue,reachedMin:Math.round(this._state.zoomValue)===this._options.zoomValue,reachedMax:Math.round(this._state.zoomValue)===this._options.maxZoom,instance:this}}_setZoomValue(e){this._state.zoomValue=e}_setLoaded(e){this._state.loaded=e}_setZooming(e){this._state.zooming=e}_setSnapViewVisible(e){this._state.snapViewVisible=e}_setContainerDim(e){this._state.containerDim=e}_setImageDim(e){this._state.imageDim=e}_setSnapImageDim(e){this._state.snapImageDim=e}_setSnapHandleDim(e){this._state.snapHandleDim=e}_setZoomSliderLength(e){this._state.zoomSliderLength=e}_getElement(e){return this._elements[e]}_setElement(e,t){this._elements[e]=t}_getSlider(e){return this._sliders[e]}_setSlider(e,t){this._sliders[e]=t}_destroySlider(e){const t=this._sliders[e];t&&(t.destroy(),this._sliders[e]=void 0)}_validateImageUrl(e,t="main"){if(!e)return null;if(!d(e)){throw new Error(`Invalid or unsafe ${"hiRes"===t?"high-res ":""}image URL: ${e}`)}return e}_setImageSources(e){var t,i;const s=this._validateImageUrl(null!=(t=e.imageSrc)?t:null,"main"),n=this._validateImageUrl(null!=(i=e.hiResImageSrc)?i:null,"hiRes");this._images={imageSrc:null!=s?s:void 0,hiResImageSrc:null!=n?n:void 0}}_getScrollPosition(){return{x:window.pageXOffset||window.scrollX||0,y:window.pageYOffset||window.scrollY||0}}_getZoomStep(){return void 0!==this._options.zoomStep&&null!==this._options.zoomStep?this._options.zoomStep:50}_calculateMomentumDelta(e){return z.calculateDelta(e)}_shouldApplyMomentum(t,i){return z.shouldApplyMomentum(t,i,e.MOMENTUM_THRESHOLD_PX)}_applyMomentumAnimation(t,i,s,n,o,a){let r=1,l=0,h=0;const c={thresholdPx:e.MOMENTUM_THRESHOLD_PX,velocityFactor:e.MOMENTUM_VELOCITY_FACTOR,animationFrames:e.MOMENTUM_ANIMATION_FRAMES},m=()=>{const e=z.calculateMomentumFrame(r,{dx:l,dy:h},{xDiff:t,yDiff:i},c);e.shouldContinue&&(this._frames.sliderMomentumFrame=requestAnimationFrame(m)),l=e.positionX,h=e.positionY;const d=s.dx+l,u=s.dy+h,g=z.convertToSnapCoordinates({x:d,y:u},n,o);a.updatePosition({dx:g.dx,dy:g.dy,mx:0,my:0}),r++};m()}_init(){this._initSnapSlider(),this._initImageSlider(),this._initZoomSlider(),this.interactionManager.setupInteractions(),this._initEvents(),this._listeners.onInit&&this._listeners.onInit(this._callbackData)}_initImageSlider(){const{_elements:t}=this,{imageWrap:i}=t;if(!i)throw new Error("imageWrap element not found");let s,n;const o=new D(this._getSlider("snapSlider"),{getImageDim:()=>this._getImageCurrentDim(),getSnapImageDim:()=>this._state.snapImageDim}),a=new Z(i,{isSliderEnabled:()=>{const{loaded:e,zooming:t,zoomValue:i}=this._state;return e&&!t&&i>100},onStart:(t,i)=>{this._clearFrames(),o.notifyPanStart(t),s=[i,i],n=void 0;let a=performance.now();const r=e.MOMENTUM_SAMPLE_INTERVAL_MS,l=e=>{e-a>=r&&(n&&(s.shift(),s.push({x:n.mx,y:n.my})),a=e),this._frames.slideMomentumCheck=requestAnimationFrame(l)};this._frames.slideMomentumCheck=requestAnimationFrame(l)},onMove:(e,t)=>{n=t,o.syncSnapSliderPosition(t)},onEnd:()=>{const{snapImageDim:e}=this._state,t=this._getImageCurrentDim();this._clearFrames();const{xDiff:i,yDiff:a}=this._calculateMomentumDelta(s);if(this._shouldApplyMomentum(i,a)){const s=o.getSnapSlider();this._applyMomentumAnimation(i,a,n,t,e,s)}}});a.init(),this._setSlider("imageSlider",a)}_calculateSnapHandlePosition(e,t,i,s,n){const o=n.w-s.w,a=n.h-s.h;return{left:y(e+i.dx,0,o),top:y(t+i.dy,0,a)}}_convertSnapToImagePosition(e,t,i){return{left:0!==i.w?-e.left*t.w/i.w:0,top:0!==i.h?-e.top*t.h/i.h:0}}_initSnapSlider(){const{snapHandle:e}=this._elements;let t,i;const s=new Z(e,{isSliderEnabled:()=>this._state.loaded,onStart:()=>{const{slideMomentumCheck:s,sliderMomentumFrame:n}=this._frames;t=w(e,"top"),i=w(e,"left"),s&&clearInterval(s),"number"==typeof n&&cancelAnimationFrame(n)},onMove:(s,n)=>{const{snapHandleDim:o,snapImageDim:a}=this._state,{image:r}=this._elements,l=this._getImageCurrentDim();if(!o)return;const h=this._calculateSnapHandlePosition(i,t,n,o,a),c=this._convertSnapToImagePosition(h,l,a);S(e,{left:`${h.left}px`,top:`${h.top}px`}),S(r,{left:`${c.left}px`,top:`${c.top}px`})},onEnd:()=>{}});s.init(),this._setSlider("snapSlider",s)}_initZoomSlider(){const{snapView:e,zoomHandle:t}=this._elements,i=e.querySelector(".iv-zoom-slider");if(!i)throw new Error("Zoom slider element not found");let s,n;const o=new Z(i,{isSliderEnabled:()=>this._state.loaded,onStart:(e,o)=>{const{zoomSlider:a}=this._sliders,r=this._getScrollPosition();s=i.getBoundingClientRect().left+r.x,n=parseInt(v(t,"width"),10),a.onMove(e,{dx:0,dy:0,mx:o.x,my:o.y})},onMove:e=>{const{maxZoom:t}=this._options,{zoomSliderLength:i}=this._state;let o;if(e instanceof MouseEvent)o=e.pageX;else{if(!(e instanceof TouchEvent))return;o=e.touches[0].pageX}if(!i)return;const a=100+(t-100)*y(o-s-n/2,0,i)/i;this.zoom(a)},onEnd:()=>{}});o.init(),this._setSlider("zoomSlider",o)}_initEvents(){this._snapViewEvents(),this._options.refreshOnResize&&this.eventManager.on("windowResize",window,"resize",()=>this.refresh())}_snapViewEvents(){const{imageWrap:e,snapView:t}=this._elements;if(this.eventManager.on("snapViewOnMouseMove",e,["touchmove","mousemove"],()=>{this.showSnapView()}),this.eventManager.on("mouseEnterSnapView",t,["mouseenter","touchstart"],()=>{this._setSnapViewVisible(!1),this.showSnapView(!0)}),this.eventManager.on("mouseLeaveSnapView",t,["mouseleave","touchend"],()=>{this._setSnapViewVisible(!1),this.showSnapView()}),!this._options.hasZoomButtons)return;const{zoomOut:i,zoomIn:s}=this._elements;this.eventManager.on("zoomInClick",s,["click"],()=>{const e=this._getZoomStep();this.zoom(this._state.zoomValue+e)}),this.eventManager.on("zoomOutClick",i,["click"],()=>{const e=this._getZoomStep();this.zoom(this._state.zoomValue-e)})}_getImageCurrentDim(){const{zoomValue:e,imageDim:t}=this._state;return{w:t.w*(e/100),h:t.h*(e/100)}}_handleImageLoadSuccess(e){const{hiResImageSrc:t}=this._images;t&&this.imageLoader.loadHighRes(t),this._setLoaded(!0),this._calculateDimensions(),this._listeners.onImageLoaded&&this._listeners.onImageLoaded(this._callbackData),this.resetZoom()}_handleImageLoadError(e,t){this._listeners.onImageError&&this._listeners.onImageError(t)}_handleHighResLoaded(){this._calculateDimensions(),this.resetZoom(!1)}_loadImages(){const{imageSrc:e,hiResImageSrc:t}=this._images;if(!e)throw new Error("No image source provided");this._setLoaded(!1),this.hideSnapView(),this.imageLoader.load(e,t)}_calculateDimensions(){const{image:e,container:t,snapView:i,snapImage:s,zoomHandle:n}=this._elements,o=parseInt(v(e,"width"),10),a=parseInt(v(e,"height"),10),r=parseInt(v(t,"width"),10),l=parseInt(v(t,"height"),10);this._setContainerDim({w:r,h:l});const h=e.naturalWidth||o,c=e.naturalHeight||a,m=b.calculateFittedImageDimensions({w:r,h:l},h,c);this._setImageDim(m),S(e,{width:`${m.w}px`,height:`${m.h}px`,left:(r-m.w)/2+"px",top:(l-m.h)/2+"px",maxWidth:"none",maxHeight:"none"});const d={w:i.clientWidth,h:i.clientHeight},u=b.calculateSnapImageDimensions(m,d);this._setSnapImageDim(u),S(s,{width:`${u.w}px`,height:`${u.h}px`});const g=i.querySelector(".iv-zoom-slider");if(!g)throw new Error("Zoom slider element not found");const p=g.clientWidth;this._setZoomSliderLength(p-n.offsetWidth)}resetZoom(e=!0){const{zoomValue:t}=this._options;e||this._setZoomValue(t),this.zoom(t)}zoom(t,i){const{_options:s,_elements:n,_state:o}=this,{zoomValue:a,imageDim:r,containerDim:l,zoomSliderLength:h}=o,{image:c,zoomHandle:m}=n,{maxZoom:d}=s;t=Math.round(Math.max(100,t)),t=Math.min(d,t);const u=null!=i?i:{x:l.w/2,y:l.h/2},g=w(c,"left"),p=w(c,"top");this._clearFrames();const _={baseLeft:(l.w-r.w)/2,baseTop:(l.h-r.h)/2,baseRight:l.w-(l.w-r.w)/2,baseBottom:l.h-(l.h-r.h)/2},f=new L({currentZoom:a,targetZoom:t,currentLeft:g,currentTop:p,zoomPoint:u,imageDim:r,bounds:_,totalFrames:e.ZOOM_ANIMATION_FRAMES});let v=0;const E=()=>{v++,v<e.ZOOM_ANIMATION_FRAMES&&(this._frames.zoomFrame=requestAnimationFrame(E));const t=f.getFrame(v);S(c,{width:`${t.width}px`,height:`${t.height}px`,left:`${t.left}px`,top:`${t.top}px`}),this._setZoomValue(t.zoom),this._resizeSnapHandle(t.width,t.height,t.left,t.top),S(m,{left:(t.zoom-100)*(h||0)/(d-100)+"px"}),this._listeners.onZoomChange&&this._listeners.onZoomChange(this._callbackData)};E()}_clearFrames(){const{slideMomentumCheck:e,sliderMomentumFrame:t,zoomFrame:i,snapViewTimeout:s}=this._frames;"number"==typeof e&&cancelAnimationFrame(e),"number"==typeof t&&cancelAnimationFrame(t),"number"==typeof i&&cancelAnimationFrame(i),"number"==typeof s&&clearTimeout(s)}_resizeSnapHandle(e,t,i,s){const{_elements:n,_state:o}=this,{snapHandle:a,image:r}=n,{imageDim:l,containerDim:h,zoomValue:c,snapImageDim:m}=o,d=e||l.w*c/100,u=t||l.h*c/100,g=i||w(r,"left"),p=s||w(r,"top"),_=0!==d?-g*m.w/d:0,f=0!==u?-p*m.h/u:0,v=0!==d?h.w*m.w/d:0,E=0!==u?h.h*m.h/u:0;S(a,{top:`${f}px`,left:`${_}px`,width:`${v}px`,height:`${E}px`}),this._setSnapHandleDim({w:v,h:E})}showSnapView(t){const{snapViewVisible:i,zoomValue:s,loaded:n}=this._state,{snapView:o}=this._elements;this._options.snapView&&(i||s<=100||!n||(clearTimeout(this._frames.snapViewTimeout),this._setSnapViewVisible(!0),S(o,{opacity:"1","pointer-events":"inherit"}),t||(this._frames.snapViewTimeout=setTimeout(()=>this.hideSnapView(),e.SNAP_VIEW_TIMEOUT_MS))))}hideSnapView(){const{snapView:e}=this._elements;S(e,{opacity:"0","pointer-events":"none"}),this._setSnapViewVisible(!1)}refresh(){this._calculateDimensions(),this.resetZoom()}load(e,t){try{this._setImageSources({imageSrc:e,hiResImageSrc:t}),this._loadImages()}catch(i){if(console.error("ImageViewer: Failed to load image",i),this._listeners.onImageError){const e=new ErrorEvent("error",{error:i instanceof Error?i:new Error(String(i)),message:i instanceof Error?i.message:String(i)});this._listeners.onImageError(e)}throw i}}destroy(){try{const{container:e,domElement:t}=this._elements;this._destroySlider("imageSlider"),this._destroySlider("snapSlider"),this._destroySlider("zoomSlider"),this.imageLoader.destroy(),this.interactionManager.destroy(),this.eventManager.destroy(),this._clearFrames(),this.dom.destroy(t,e),t._imageViewer=null,this._listeners.onDestroy&&this._listeners.onDestroy()}catch(e){console.error("ImageViewer: Error during destroy",e)}}};c(H,"defaults"),c(H,"FullScreenViewer"),c(H,"MOMENTUM_SAMPLE_INTERVAL_MS",50),c(H,"MOMENTUM_ANIMATION_FRAMES",60),c(H,"MOMENTUM_THRESHOLD_PX",30),c(H,"MOMENTUM_VELOCITY_FACTOR",1/3),c(H,"ZOOM_ANIMATION_FRAMES",16),c(H,"SNAP_VIEW_TIMEOUT_MS",1500);let N=H;N.defaults={zoomValue:100,snapView:!0,maxZoom:500,refreshOnResize:!0,zoomOnMouseWheel:!0,hasZoomButtons:!1,zoomStep:50,listeners:{onInit:void 0,onDestroy:void 0,onImageLoaded:void 0,onZoomChange:void 0,onImageError:void 0}};const C="iv-fullscreen",F="iv-fullscreen-container",k="iv-fullscreen-close",W=`\n  <div class="${F}"></div>\n  <div class="${k}"></div>\n`;e.FullScreenViewer=class extends N{constructor(e={}){const t=u({tagName:"div",className:C,html:W,trustedHTML:!0,parent:document.body}),i=t.querySelector(`.${F}`);if(!i)throw new Error("Fullscreen container element not found");super(i,h(l({},e),{refreshOnResize:!1})),c(this,"hide",()=>{const e=this._getElement("fullScreen");e&&S(e,{display:"none"});const t=document.querySelector("html");var i;t&&(i="overflow",t.style.removeProperty(i)),this.eventManager.off("onWindowResize")}),this._setElement("fullScreen",t),this._initFullScreenEvents()}_initFullScreenEvents(){const e=this._getElement("fullScreen");if(!e)throw new Error("Fullscreen element not initialized");const t=e.querySelector(`.${k}`);if(!t)throw new Error("Fullscreen close button not found");this.eventManager.on("onCloseBtnClick",t,"click",this.hide)}show(e,t){const i=this._getElement("fullScreen");i&&S(i,{display:"block"}),e&&this.load(e,t),this.eventManager.on("onWindowResize",window,"resize",()=>this.refresh());const s=document.querySelector("html");s&&S(s,{overflow:"hidden"})}destroy(){const e=this._getElement("fullScreen");super.destroy(),e&&E(e)}},e.ImageViewer=N,e.default=N,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=iv-viewer-ts.umd.js.map
