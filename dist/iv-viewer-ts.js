"use strict";var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s,r=(e,t)=>{for(var i in t||(t={}))o.call(t,i)&&a(e,i,t[i]);if(s)for(var i of s(t))n.call(t,i)&&a(e,i,t[i]);return e},l=(e,s)=>t(e,i(s)),h=(e,t,i)=>a(e,"symbol"!=typeof t?t+"":t,i);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});function m(e,t,i,s){return e/=s,-i*((e-=1)*e*e*e-1)+t}function c(e){if(!e)return!1;try{const t=new URL(e,window.location.href);return["http:","https:","blob:"].includes(t.protocol)}catch(t){return!1}}function d(e){const t=document.createElement(e.tagName);if(e.id&&(t.id=e.id),e.html){if(!e.trustedHTML)throw new Error("innerHTML requires trustedHTML=true to avoid XSS risks");t.innerHTML=e.html}if(e.className&&(t.className=e.className),e.src&&t instanceof HTMLImageElement){if(!c(e.src))throw new Error(`Invalid or unsafe image URL protocol: ${e.src}`);t.setAttribute("src",e.src)}return e.style&&w(t,e.style),e.child&&t.appendChild(e.child),e.insertBefore?e.parent.insertBefore(t,e.insertBefore):e.parent.appendChild(t),t}function u(e,t){const i=t.split(" ");i.length>1?i.forEach(t=>u(e,t)):e.classList?e.classList.add(t):e.className+=` ${t}`}function g(e,t){const i=t.split(" ");i.length>1?i.forEach(t=>g(e,t)):e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(`(^|\\s)${t}(\\s|$)`,"g")," ").trim()}function p(e){return e.complete&&(void 0===e.naturalWidth||0!==e.naturalWidth)}function _(e){return e instanceof HTMLElement?[e]:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e):[]}function v(e,t){const i=window.getComputedStyle(e),s=i.getPropertyValue(t);if(s)return s;if(t in i){const e=i[t];return"string"==typeof e?e:String(e)}return""}function f(e,t,i=0){const s=v(e,t),o=parseFloat(s);return isNaN(o)?i:o}function w(e,t){_(e).forEach(e=>{e instanceof HTMLElement&&Object.keys(t).forEach(i=>{const s=t[i],o=String(s),n=o.toLowerCase();if(n.includes("javascript:")||n.includes("expression("))throw new Error("Blocked unsafe CSS value");const a=o.replace(/[<>'"]/g,"");e.style[i]=a})})}function S(e){_(e).forEach(e=>{e instanceof Element&&e.parentNode&&e.parentNode.removeChild(e)})}function E(e,t,i){return Math.min(Math.max(e,t),i)}function M(e,t,i){const s=Array.isArray(t)?t:[t],o=s.some(e=>"wheel"===e)?{passive:!1}:void 0;return s.forEach(t=>e.addEventListener(t,i,o)),()=>{s.forEach(t=>e.removeEventListener(t,i))}}function y(e){const t=e[0],i=e[1];return Math.sqrt(Math.pow(i.pageX-t.pageX,2)+Math.pow(i.pageY-t.pageY,2))}class I{constructor(e){h(this,"currentZoom"),h(this,"targetZoom"),h(this,"currentLeft"),h(this,"currentTop"),h(this,"zoomPoint"),h(this,"imageDim"),h(this,"bounds"),h(this,"totalFrames"),this.currentZoom=e.currentZoom,this.targetZoom=e.targetZoom,this.currentLeft=e.currentLeft,this.currentTop=e.currentTop,this.zoomPoint=e.zoomPoint,this.imageDim=e.imageDim,this.bounds=e.bounds,this.totalFrames=e.totalFrames}getFrame(e){const t=m(e,this.currentZoom,this.targetZoom-this.currentZoom,this.totalFrames),i=this.imageDim.w*t/100,s=this.imageDim.h*t/100,o=this.calculatePosition(t),n=this.constrainToBounds(o,i,s);return{zoom:t,width:i,height:s,left:n.left,top:n.top}}calculatePosition(e){const t=e/this.currentZoom;return{left:-((this.zoomPoint.x-this.currentLeft)*t-this.zoomPoint.x),top:-((this.zoomPoint.y-this.currentTop)*t-this.zoomPoint.y)}}constrainToBounds(e,t,i){let{left:s,top:o}=e;const{baseLeft:n,baseTop:a,baseRight:r,baseBottom:l}=this.bounds;return s=Math.min(s,n),o=Math.min(o,a),s+t<r&&(s=r-t),o+i<l&&(o=l-i),{left:s,top:o}}}class L{static calculateFittedImageDimensions(e,t,i){const s=t/i,o=t>i&&e.h>=e.w||s*e.h>e.w?e.w:s*e.h;return{w:o,h:o/s}}static calculateSnapImageDimensions(e,t){return{w:e.w>e.h?t.w:e.w*t.h/e.h,h:e.h>e.w?t.h:e.h*t.w/e.w}}static calculateAllDimensions(e){const{containerDim:t,naturalWidth:i,naturalHeight:s,snapViewDim:o}=e,n=this.calculateFittedImageDimensions(t,i,s);return{imageDim:n,snapImageDim:this.calculateSnapImageDimensions(n,o)}}static calculateSnapHandleDimensions(e,t,i){return{w:0!==t.w?i.w*e.w/t.w:e.w,h:0!==t.h?i.h*e.h/t.h:e.h}}}class b{static calculateDelta(e){return e.length<2?{xDiff:0,yDiff:0}:{xDiff:e[1].x-e[0].x,yDiff:e[1].y-e[0].y}}static shouldApplyMomentum(e,t,i){return Math.abs(e)>i||Math.abs(t)>i}static calculateMomentumFrame(e,t,i,s){const{xDiff:o,yDiff:n}=i,{velocityFactor:a,animationFrames:r}=s,l=m(e,o*a,-o*a,r),h=m(e,n*a,-n*a,r);return{positionX:t.dx+l,positionY:t.dy+h,shouldContinue:e<r}}static convertToSnapCoordinates(e,t,i){return{dx:0!==t.w?-e.x*i.w/t.w:0,dy:0!==t.h?-e.y*i.h/t.h:0}}}class z{constructor(e,t){h(this,"snapSlider"),h(this,"getImageDim"),h(this,"getSnapImageDim"),this.snapSlider=e,this.getImageDim=t.getImageDim,this.getSnapImageDim=t.getSnapImageDim}notifyPanStart(e){this.snapSlider.onStart(e,{x:0,y:0})}syncSnapSliderPosition(e){const t=this.getImageDim(),i=this.getSnapImageDim(),s=0!==t.w?-e.dx*i.w/t.w:0,o=0!==t.h?-e.dy*i.h/t.h:0;this.snapSlider.updatePosition({dx:s,dy:o,mx:0,my:0})}getSnapSlider(){return this.snapSlider}}class D{static createZoomInButton(e){return e?'<div class="iv-button-zoom--in" role="button"></div>':""}static createZoomOutButton(e){return e?'<div class="iv-button-zoom--out" role="button"></div>':""}static createViewerHTML(e){return`\n  <div class="iv-loader"></div>\n  <div class="iv-snap-view">\n    <div class="iv-snap-image-wrap">\n      <div class="iv-snap-handle"></div>\n    </div>\n    <div class="iv-zoom-actions ${e?"iv-zoom-actions--has-buttons":""}">\n      ${this.createZoomInButton(e)}\n      <div class="iv-zoom-slider">\n        <div class="iv-zoom-handle"></div>\n      </div>\n      ${this.createZoomOutButton(e)}\n    </div>\n  </div>\n  <div class="iv-image-view" >\n    <div class="iv-image-wrap" ></div>\n  </div>\n`}}const V=class e{constructor(e,t,i,s){h(this,"loadCounter",0),h(this,"activeLoads",new Map),this.elements=e,this.onLoadSuccess=t,this.onLoadError=i,this.onHighResLoaded=s}load(e,t){const{container:i}=this.elements;if(!i)throw new Error("Container element not found");this._cancelPreviousLoads();const s=++this.loadCounter,o=i.querySelector(".iv-loader");if(!o)throw new Error("Loader element not found");S(i.querySelectorAll(".iv-snap-image, .iv-image"));const n=this.sanitizeImageSrc(e),{snapImage:a,image:r}=this._createImageElements(n);this.elements.image=r,this.elements.snapImage=a,w(o,{display:"block"}),w(r,{visibility:"hidden"});const l=()=>{this._handleLoadSuccess(s,t)},h=e=>{this._handleLoadError(s,e)};if(p(r))l();else{const e=M(r,"load",l),t=M(r,"error",h);this.activeLoads.set("imageLoad",e),this.activeLoads.set("imageError",t)}return s}loadHighRes(e){const{imageWrap:t}=this.elements;if(!t)throw new Error("Image wrap element not found");const i=this.sanitizeImageSrc(e),s=this.elements.image;if(!s)throw new Error("Low-res image not found");const o=this.activeLoads.get("hiResImageLoad");o&&(o(),this.activeLoads.delete("hiResImageLoad"));const n=d({tagName:"img",className:"iv-image iv-large-image",src:i,parent:t}),a=window.getComputedStyle(s);w(n,{width:a.width,height:a.height,left:a.left,top:a.top,maxWidth:a.maxWidth,maxHeight:a.maxHeight,visibility:a.visibility});const r=()=>{const e=this.activeLoads.get("hiResImageLoad");null==e||e(),this.activeLoads.delete("hiResImageLoad"),S(s),this.elements.image=n;t.querySelectorAll(".iv-image").forEach(e=>{e!==n&&S(e)}),this.onHighResLoaded&&this.onHighResLoaded()},l=M(n,"load",r);this.activeLoads.set("hiResImageLoad",l),p(n)&&r()}destroy(){this._cancelPreviousLoads()}_createImageElements(e){const t=this.sanitizeImageSrc(e),{snapImageWrap:i,imageWrap:s}=this.elements;if(!i||!s)throw new Error("Image wrap elements not found");const o=i.firstChild,n=d(l(r({tagName:"img",className:"iv-snap-image"},o?{insertBefore:o}:{}),{parent:i}));n.setAttribute("src",t);const a=d({tagName:"img",className:"iv-image iv-small-image",parent:s});return a.setAttribute("src",t),{snapImage:n,image:a}}sanitizeImageSrc(t){if(!c(t))throw new Error(`Invalid or unsafe image URL: ${t}`);const i=new URL(t,window.location.href);if(!e.ALLOWED_PROTOCOLS.includes(i.protocol))throw new Error(`Invalid or unsafe image URL protocol: ${t}`);return i.href}_handleLoadSuccess(e,t){if(e!==this.loadCounter)return;const{container:i}=this.elements;if(!i)return;const s=i.querySelector(".iv-loader"),o=this.elements.image;s&&w(s,{display:"none"}),o&&w(o,{visibility:"visible"}),t&&this.loadHighRes(t),this.onLoadSuccess(e)}_handleLoadError(e,t){if(e!==this.loadCounter)return;const{container:i}=this.elements;if(!i)return;const s=i.querySelector(".iv-loader");s&&w(s,{display:"none"}),this.onLoadError(e,t)}_cancelPreviousLoads(){this.activeLoads.forEach(e=>e()),this.activeLoads.clear()}};h(V,"ALLOWED_PROTOCOLS",["http:","https:","blob:"]);let x=V;class T{constructor(){h(this,"listeners",new Map)}on(e,t,i,s){this.off(e);const o=M(t,i,s);return this.listeners.set(e,o),o}off(e){const t=this.listeners.get(e);return!!t&&(t(),this.listeners.delete(e),!0)}destroy(){this.listeners.forEach(e=>e()),this.listeners.clear()}count(){return this.listeners.size}has(e){return this.listeners.has(e)}getNames(){return Array.from(this.listeners.keys())}}class O{constructor(){h(this,"elements",{})}initialize(e,t,i){const s=this._resolveElement(e);if(s._imageViewer)throw new Error("An image viewer is already being initiated on the element.");let o,n,a;if("IMG"===s.tagName){const e=this._processImgElement(s,i);o=e.container,n=e.imageSrc,a=e.hiResImageSrc}else{o=s;const e=this._extractImageSourcesFromContainer(s,i);n=e.imageSrc,a=e.hiResImageSrc}return this.elements={container:o,domElement:s},this._createStructure(o,t),{container:o,domElement:s,imageSrc:n,hiResImageSrc:a,elements:this.elements}}getElements(){return this.elements}getElement(e){return this.elements[e]}setElement(e,t){this.elements[e]=t}destroy(e,t){const i=t.querySelector(".iv-wrap");i&&S(i),g(t,"iv-container"),e!==t&&function(e){var t,i;const s=e.parentNode;s&&s!==document.body&&(null==(t=s.parentNode)||t.insertBefore(e,s),null==(i=s.parentNode)||i.removeChild(s))}(e)}_resolveElement(e){if("string"==typeof e){const t=document.querySelector(e);if(!t)throw new Error(`Element not found: ${e}`);return t}return e}_processImgElement(e,t){const i=e.src,s=e.getAttribute("high-res-src")||e.getAttribute("data-high-res-src"),o=t(i,"main"),n=t(s,"hiRes");if(!o)throw new Error("Invalid or unsafe image URL protocol");const a=function(e,{tag:t="div",className:i,id:s,style:o}){const n=document.createElement(t);n.className=i,s&&(n.id=s),o&&(o.display&&(n.style.display=o.display),o.overflow&&(n.style.overflow=o.overflow));const a=e.parentNode;if(!a)throw new Error("element does not have a parent node");return a.insertBefore(n,e),a.removeChild(e),n.appendChild(e),n}(e,{className:"iv-container iv-image-mode",style:{display:"inline-block",overflow:"hidden"}});return w(e,{opacity:"0",position:"relative","z-index":"-1"}),{container:a,imageSrc:o,hiResImageSrc:n}}_extractImageSourcesFromContainer(e,t){const i=e.getAttribute("src")||e.getAttribute("data-src"),s=e.getAttribute("high-res-src")||e.getAttribute("data-high-res-src");return{imageSrc:t(i,"main"),hiResImageSrc:t(s,"hiRes")}}_createStructure(e,t){d({tagName:"div",className:"iv-wrap",html:t,trustedHTML:!0,parent:e}),u(e,"iv-container"),"static"===v(e,"position")&&w(e,{position:"relative"});const i=e.querySelector(".iv-snap-view"),s=e.querySelector(".iv-snap-image-wrap"),o=e.querySelector(".iv-image-wrap"),n=e.querySelector(".iv-snap-handle"),a=e.querySelector(".iv-zoom-handle"),h=e.querySelector(".iv-button-zoom--in"),m=e.querySelector(".iv-button-zoom--out");if(!(i&&s&&o&&n&&a))throw new Error("Required viewer elements not found in container");this.elements=l(r({},this.elements),{snapView:i,snapImageWrap:s,imageWrap:o,snapHandle:n,zoomHandle:a,zoomIn:h||void 0,zoomOut:m||void 0})}}const A=class e{constructor(e,t,i,s){this.elements=e,this.eventManager=t,this.options=i,this.callbacks=s}setupInteractions(){this.setupPinchZoom(),this.setupWheelZoom(),this.setupDoubleTap()}setupPinchZoom(){const{imageWrap:e,container:t}=this.elements;this.eventManager.on("pinchStart",e,"touchstart",e=>{const{loaded:i,zoomValue:s}=this.callbacks.getState();if(!i)return;const o=e.touches[0],n=e.touches[1];if(!o||!n)return;this.callbacks.setZooming(!0);const a=t.getBoundingClientRect(),r=y(e.touches),l=this.callbacks.getScrollPosition(),h=this.calculatePinchCenter(o,n,a,l);this.eventManager.off("pinchMove"),this.eventManager.off("pinchEnd"),this.eventManager.on("pinchMove",document,"touchmove",e=>{const t=y(e.touches),i=this.calculatePinchZoom(s,r,t);this.callbacks.zoom(i,h)}),this.eventManager.on("pinchEnd",document,"touchend",e=>{var t;this.eventManager.off("pinchMove"),this.eventManager.off("pinchEnd"),this.callbacks.setZooming(!1),1===e.touches.length&&(null==(t=this.callbacks.getSlider("imageSlider"))||t.startHandler(e))})})}setupWheelZoom(){const{container:e,imageWrap:t}=this.elements;let i=0;this.eventManager.on("wheelZoom",t,"wheel",t=>{const{loaded:s,zoomValue:o}=this.callbacks.getState();if(!this.options.zoomOnMouseWheel||!s)return;this.callbacks.clearFrames();const n=this.normalizeWheelDelta(t),a=o*(100+15*n)/100;if(a>=100&&a<=this.options.maxZoom?i=0:i+=Math.abs(n),t.preventDefault(),i>5)return;const r=e.getBoundingClientRect(),l=this.getMousePositionRelativeToContainer(t,r);this.callbacks.zoom(a,l),this.callbacks.showSnapView()})}setupDoubleTap(){const{imageWrap:t}=this.elements;let i,s=0;this.eventManager.on("doubleTapClick",t,"click",t=>{const{zoomValue:o}=this.callbacks.getState();0===s?(s=Date.now(),i={x:t.pageX,y:t.pageY}):Date.now()-s<e.DOUBLE_TAP_INTERVAL_MS&&Math.abs(t.pageX-i.x)<e.DOUBLE_TAP_DISTANCE_PX&&Math.abs(t.pageY-i.y)<e.DOUBLE_TAP_DISTANCE_PX?(o===this.options.zoomValue?this.callbacks.zoom(e.DOUBLE_TAP_ZOOM_LEVEL):this.callbacks.resetZoom(),s=0):s=0})}destroy(){}calculatePinchCenter(e,t,i,s){return{x:(t.pageX+e.pageX)/2-(i.left+s.x),y:(t.pageY+e.pageY)/2-(i.top+s.y)}}calculatePinchZoom(e,t,i){return e+(i-t)/2}normalizeWheelDelta(e){const t=e;return Math.max(-1,Math.min(1,t.wheelDelta||-e.detail||-e.deltaY))}getMousePositionRelativeToContainer(e,t){const i=this.callbacks.getScrollPosition();return{x:e.pageX-(t.left+i.x),y:e.pageY-(t.top+i.y)}}};h(A,"DOUBLE_TAP_INTERVAL_MS",500),h(A,"DOUBLE_TAP_DISTANCE_PX",50),h(A,"DOUBLE_TAP_ZOOM_LEVEL",200);let R=A;class P{constructor(e,{onStart:t,onMove:i,onEnd:s,isSliderEnabled:o}){if(h(this,"_onStart"),h(this,"_onMove"),h(this,"_onEnd"),h(this,"isSliderEnabled"),h(this,"container"),h(this,"touchMoveEvent"),h(this,"touchEndEvent"),h(this,"sx",0),h(this,"sy",0),h(this,"startHandler",e=>{if(!this.isSliderEnabled())return;this.removeListeners(),e.cancelable&&e.preventDefault();const{moveHandler:t,endHandler:i,_onStart:s}=this;let o,n;if(this.isTouchEvent(e)){const t=e;this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",o=t.touches[0].clientX,n=t.touches[0].clientY}else{const t=e;this.touchMoveEvent="mousemove",this.touchEndEvent="mouseup",o=t.clientX,n=t.clientY}this.sx=o,this.sy=n,s(e,{x:this.sx,y:this.sy}),document.addEventListener(this.touchMoveEvent,t),document.addEventListener(this.touchEndEvent,i),document.addEventListener("contextmenu",i)}),h(this,"moveHandler",e=>{if(!this.isSliderEnabled())return;e.cancelable&&e.preventDefault();const{sx:t,sy:i,_onMove:s}=this;let o,n;if(this.isTouchEvent(e)){const t=e;o=t.touches[0].clientX,n=t.touches[0].clientY}else{const t=e;o=t.clientX,n=t.clientY}s(e,{dx:o-t,dy:n-i,mx:o,my:n})}),h(this,"endHandler",()=>{this.isSliderEnabled()&&(this.removeListeners(),this._onEnd())}),"function"!=typeof t)throw new Error("Slider: onStart callback is required and must be a function");if("function"!=typeof i)throw new Error("Slider: onMove callback is required and must be a function");if("function"!=typeof s)throw new Error("Slider: onEnd callback is required and must be a function");this.container=e,this.isSliderEnabled=o||(()=>!0),this._onStart=t,this._onMove=i,this._onEnd=s}onStart(e,t){return this._onStart(e,t)}onMove(e,t){return this._onMove(e,t)}updatePosition(e){const t=new Event("programmatic-update");this._onMove(t,e)}isTouchEvent(e){return"touchstart"===e.type||"touchmove"===e.type||"touchend"===e.type}removeListeners(){this.touchMoveEvent&&document.removeEventListener(this.touchMoveEvent,this.moveHandler),this.touchEndEvent&&document.removeEventListener(this.touchEndEvent,this.endHandler),document.removeEventListener("contextmenu",this.endHandler)}init(){["touchstart","mousedown"].forEach(e=>{this.container.addEventListener(e,this.startHandler)})}destroy(){["touchstart","mousedown"].forEach(e=>{this.container.removeEventListener(e,this.startHandler)}),this.removeListeners()}}const Z=class e{constructor(t,i={}){h(this,"_elements"),h(this,"_options"),h(this,"_listeners"),h(this,"_state"),h(this,"_sliders"),h(this,"_frames"),h(this,"_images"),h(this,"imageLoader"),h(this,"eventManager"),h(this,"dom"),h(this,"interactionManager"),this._options=r(r({},e.defaults),i),this.dom=new O;const{domElement:s,imageSrc:o,hiResImageSrc:n,elements:a}=this.dom.initialize(t,D.createViewerHTML(this._options.hasZoomButtons),(e,t)=>this._validateImageUrl(e,t));this._elements=a,this._listeners=void 0!==this._options.listeners&&null!==this._options.listeners?this._options.listeners:{},this._frames={},this._sliders={},this._state={zoomValue:this._options.zoomValue,loaded:!1,imageDim:{w:0,h:0},containerDim:{w:0,h:0},snapImageDim:{w:0,h:0},zooming:!1,snapViewVisible:!1,zoomSliderLength:0,snapHandleDim:{w:0,h:0}},this._images={imageSrc:o,hiResImageSrc:n},this.imageLoader=new x(this._elements,e=>this._handleImageLoadSuccess(e),(e,t)=>this._handleImageLoadError(e,t),()=>this._handleHighResLoaded()),this.eventManager=new T,this.interactionManager=new R({imageWrap:this._elements.imageWrap,container:this._elements.container},this.eventManager,{zoomOnMouseWheel:this._options.zoomOnMouseWheel,zoomValue:this._options.zoomValue,maxZoom:this._options.maxZoom},{getState:()=>{var e,t,i;return{loaded:null!=(e=this._state.loaded)&&e,zoomValue:null!=(t=this._state.zoomValue)?t:100,zooming:null!=(i=this._state.zooming)&&i}},setZooming:e=>this._setZooming(e),clearFrames:()=>this._clearFrames(),zoom:(e,t)=>this.zoom(e,t),resetZoom:()=>this.resetZoom(),showSnapView:()=>this.showSnapView(),getSlider:e=>this._getSlider(e),getScrollPosition:()=>this._getScrollPosition()}),this._init(),o&&this._loadImages(),s._imageViewer=this}get imageViewHtml(){return D.createViewerHTML(this._options.hasZoomButtons)}get _callbackData(){if(!this._elements.container||!this._elements.snapView)throw new Error("ImageViewer elements not initialized. Cannot get callback data.");return{container:this._elements.container,snapView:this._elements.snapView,zoomValue:this._state.zoomValue,reachedMin:Math.round(this._state.zoomValue)===this._options.zoomValue,reachedMax:Math.round(this._state.zoomValue)===this._options.maxZoom,instance:this}}_setZoomValue(e){this._state.zoomValue=e}_setLoaded(e){this._state.loaded=e}_setZooming(e){this._state.zooming=e}_setSnapViewVisible(e){this._state.snapViewVisible=e}_setContainerDim(e){this._state.containerDim=e}_setImageDim(e){this._state.imageDim=e}_setSnapImageDim(e){this._state.snapImageDim=e}_setSnapHandleDim(e){this._state.snapHandleDim=e}_setZoomSliderLength(e){this._state.zoomSliderLength=e}_getElement(e){return this._elements[e]}_setElement(e,t){this._elements[e]=t}_getSlider(e){return this._sliders[e]}_setSlider(e,t){this._sliders[e]=t}_destroySlider(e){const t=this._sliders[e];t&&(t.destroy(),this._sliders[e]=void 0)}_validateImageUrl(e,t="main"){if(!e)return null;if(!c(e)){throw new Error(`Invalid or unsafe ${"hiRes"===t?"high-res ":""}image URL: ${e}`)}return e}_setImageSources(e){var t,i;const s=this._validateImageUrl(null!=(t=e.imageSrc)?t:null,"main"),o=this._validateImageUrl(null!=(i=e.hiResImageSrc)?i:null,"hiRes");this._images={imageSrc:null!=s?s:void 0,hiResImageSrc:null!=o?o:void 0}}_getScrollPosition(){return{x:window.pageXOffset||window.scrollX||0,y:window.pageYOffset||window.scrollY||0}}_getZoomStep(){return void 0!==this._options.zoomStep&&null!==this._options.zoomStep?this._options.zoomStep:50}_calculateMomentumDelta(e){return b.calculateDelta(e)}_shouldApplyMomentum(t,i){return b.shouldApplyMomentum(t,i,e.MOMENTUM_THRESHOLD_PX)}_applyMomentumAnimation(t,i,s,o,n,a){let r=1,l=0,h=0;const m={thresholdPx:e.MOMENTUM_THRESHOLD_PX,velocityFactor:e.MOMENTUM_VELOCITY_FACTOR,animationFrames:e.MOMENTUM_ANIMATION_FRAMES},c=()=>{const e=b.calculateMomentumFrame(r,{dx:l,dy:h},{xDiff:t,yDiff:i},m);e.shouldContinue&&(this._frames.sliderMomentumFrame=requestAnimationFrame(c)),l=e.positionX,h=e.positionY;const d=s.dx+l,u=s.dy+h,g=b.convertToSnapCoordinates({x:d,y:u},o,n);a.updatePosition({dx:g.dx,dy:g.dy,mx:0,my:0}),r++};c()}_init(){this._initSnapSlider(),this._initImageSlider(),this._initZoomSlider(),this.interactionManager.setupInteractions(),this._initEvents(),this._listeners.onInit&&this._listeners.onInit(this._callbackData)}_initImageSlider(){const{_elements:t}=this,{imageWrap:i}=t;if(!i)throw new Error("imageWrap element not found");let s,o;const n=new z(this._getSlider("snapSlider"),{getImageDim:()=>this._getImageCurrentDim(),getSnapImageDim:()=>this._state.snapImageDim}),a=new P(i,{isSliderEnabled:()=>{const{loaded:e,zooming:t,zoomValue:i}=this._state;return e&&!t&&i>100},onStart:(t,i)=>{this._clearFrames(),n.notifyPanStart(t),s=[i,i],o=void 0;let a=performance.now();const r=e.MOMENTUM_SAMPLE_INTERVAL_MS,l=e=>{e-a>=r&&(o&&(s.shift(),s.push({x:o.mx,y:o.my})),a=e),this._frames.slideMomentumCheck=requestAnimationFrame(l)};this._frames.slideMomentumCheck=requestAnimationFrame(l)},onMove:(e,t)=>{o=t,n.syncSnapSliderPosition(t)},onEnd:()=>{const{snapImageDim:e}=this._state,t=this._getImageCurrentDim();this._clearFrames();const{xDiff:i,yDiff:a}=this._calculateMomentumDelta(s);if(this._shouldApplyMomentum(i,a)){const s=n.getSnapSlider();this._applyMomentumAnimation(i,a,o,t,e,s)}}});a.init(),this._setSlider("imageSlider",a)}_calculateSnapHandlePosition(e,t,i,s,o){const n=o.w-s.w,a=o.h-s.h;return{left:E(e+i.dx,0,n),top:E(t+i.dy,0,a)}}_convertSnapToImagePosition(e,t,i){return{left:0!==i.w?-e.left*t.w/i.w:0,top:0!==i.h?-e.top*t.h/i.h:0}}_initSnapSlider(){const{snapHandle:e}=this._elements;let t,i;const s=new P(e,{isSliderEnabled:()=>this._state.loaded,onStart:()=>{const{slideMomentumCheck:s,sliderMomentumFrame:o}=this._frames;t=f(e,"top"),i=f(e,"left"),s&&clearInterval(s),"number"==typeof o&&cancelAnimationFrame(o)},onMove:(s,o)=>{const{snapHandleDim:n,snapImageDim:a}=this._state,{image:r}=this._elements,l=this._getImageCurrentDim();if(!n)return;const h=this._calculateSnapHandlePosition(i,t,o,n,a),m=this._convertSnapToImagePosition(h,l,a);w(e,{left:`${h.left}px`,top:`${h.top}px`}),w(r,{left:`${m.left}px`,top:`${m.top}px`})},onEnd:()=>{}});s.init(),this._setSlider("snapSlider",s)}_initZoomSlider(){const{snapView:e,zoomHandle:t}=this._elements,i=e.querySelector(".iv-zoom-slider");if(!i)throw new Error("Zoom slider element not found");let s,o;const n=new P(i,{isSliderEnabled:()=>this._state.loaded,onStart:(e,n)=>{const{zoomSlider:a}=this._sliders,r=this._getScrollPosition();s=i.getBoundingClientRect().left+r.x,o=parseInt(v(t,"width"),10),a.onMove(e,{dx:0,dy:0,mx:n.x,my:n.y})},onMove:e=>{const{maxZoom:t}=this._options,{zoomSliderLength:i}=this._state;let n;if(e instanceof MouseEvent)n=e.pageX;else{if(!(e instanceof TouchEvent))return;n=e.touches[0].pageX}if(!i)return;const a=100+(t-100)*E(n-s-o/2,0,i)/i;this.zoom(a)},onEnd:()=>{}});n.init(),this._setSlider("zoomSlider",n)}_initEvents(){this._snapViewEvents(),this._options.refreshOnResize&&this.eventManager.on("windowResize",window,"resize",()=>this.refresh())}_snapViewEvents(){const{imageWrap:e,snapView:t}=this._elements;if(this.eventManager.on("snapViewOnMouseMove",e,["touchmove","mousemove"],()=>{this.showSnapView()}),this.eventManager.on("mouseEnterSnapView",t,["mouseenter","touchstart"],()=>{this._setSnapViewVisible(!1),this.showSnapView(!0)}),this.eventManager.on("mouseLeaveSnapView",t,["mouseleave","touchend"],()=>{this._setSnapViewVisible(!1),this.showSnapView()}),!this._options.hasZoomButtons)return;const{zoomOut:i,zoomIn:s}=this._elements;this.eventManager.on("zoomInClick",s,["click"],()=>{const e=this._getZoomStep();this.zoom(this._state.zoomValue+e)}),this.eventManager.on("zoomOutClick",i,["click"],()=>{const e=this._getZoomStep();this.zoom(this._state.zoomValue-e)})}_getImageCurrentDim(){const{zoomValue:e,imageDim:t}=this._state;return{w:t.w*(e/100),h:t.h*(e/100)}}_handleImageLoadSuccess(e){const{hiResImageSrc:t}=this._images;t&&this.imageLoader.loadHighRes(t),this._setLoaded(!0),this._calculateDimensions(),this._listeners.onImageLoaded&&this._listeners.onImageLoaded(this._callbackData),this.resetZoom()}_handleImageLoadError(e,t){this._listeners.onImageError&&this._listeners.onImageError(t)}_handleHighResLoaded(){this._calculateDimensions(),this.resetZoom(!1)}_loadImages(){const{imageSrc:e,hiResImageSrc:t}=this._images;if(!e)throw new Error("No image source provided");this._setLoaded(!1),this.hideSnapView(),this.imageLoader.load(e,t)}_calculateDimensions(){const{image:e,container:t,snapView:i,snapImage:s,zoomHandle:o}=this._elements,n=parseInt(v(e,"width"),10),a=parseInt(v(e,"height"),10),r=parseInt(v(t,"width"),10),l=parseInt(v(t,"height"),10);this._setContainerDim({w:r,h:l});const h=e.naturalWidth||n,m=e.naturalHeight||a,c=L.calculateFittedImageDimensions({w:r,h:l},h,m);this._setImageDim(c),w(e,{width:`${c.w}px`,height:`${c.h}px`,left:(r-c.w)/2+"px",top:(l-c.h)/2+"px",maxWidth:"none",maxHeight:"none"});const d={w:i.clientWidth,h:i.clientHeight},u=L.calculateSnapImageDimensions(c,d);this._setSnapImageDim(u),w(s,{width:`${u.w}px`,height:`${u.h}px`});const g=i.querySelector(".iv-zoom-slider");if(!g)throw new Error("Zoom slider element not found");const p=g.clientWidth;this._setZoomSliderLength(p-o.offsetWidth)}resetZoom(e=!0){const{zoomValue:t}=this._options;e||this._setZoomValue(t),this.zoom(t)}zoom(t,i){const{_options:s,_elements:o,_state:n}=this,{zoomValue:a,imageDim:r,containerDim:l,zoomSliderLength:h}=n,{image:m,zoomHandle:c}=o,{maxZoom:d}=s;t=Math.round(Math.max(100,t)),t=Math.min(d,t);const u=null!=i?i:{x:l.w/2,y:l.h/2},g=f(m,"left"),p=f(m,"top");this._clearFrames();const _={baseLeft:(l.w-r.w)/2,baseTop:(l.h-r.h)/2,baseRight:l.w-(l.w-r.w)/2,baseBottom:l.h-(l.h-r.h)/2},v=new I({currentZoom:a,targetZoom:t,currentLeft:g,currentTop:p,zoomPoint:u,imageDim:r,bounds:_,totalFrames:e.ZOOM_ANIMATION_FRAMES});let S=0;const E=()=>{S++,S<e.ZOOM_ANIMATION_FRAMES&&(this._frames.zoomFrame=requestAnimationFrame(E));const t=v.getFrame(S);w(m,{width:`${t.width}px`,height:`${t.height}px`,left:`${t.left}px`,top:`${t.top}px`}),this._setZoomValue(t.zoom),this._resizeSnapHandle(t.width,t.height,t.left,t.top),w(c,{left:(t.zoom-100)*(h||0)/(d-100)+"px"}),this._listeners.onZoomChange&&this._listeners.onZoomChange(this._callbackData)};E()}_clearFrames(){const{slideMomentumCheck:e,sliderMomentumFrame:t,zoomFrame:i,snapViewTimeout:s}=this._frames;"number"==typeof e&&cancelAnimationFrame(e),"number"==typeof t&&cancelAnimationFrame(t),"number"==typeof i&&cancelAnimationFrame(i),"number"==typeof s&&clearTimeout(s)}_resizeSnapHandle(e,t,i,s){const{_elements:o,_state:n}=this,{snapHandle:a,image:r}=o,{imageDim:l,containerDim:h,zoomValue:m,snapImageDim:c}=n,d=e||l.w*m/100,u=t||l.h*m/100,g=i||f(r,"left"),p=s||f(r,"top"),_=0!==d?-g*c.w/d:0,v=0!==u?-p*c.h/u:0,S=0!==d?h.w*c.w/d:0,E=0!==u?h.h*c.h/u:0;w(a,{top:`${v}px`,left:`${_}px`,width:`${S}px`,height:`${E}px`}),this._setSnapHandleDim({w:S,h:E})}showSnapView(t){const{snapViewVisible:i,zoomValue:s,loaded:o}=this._state,{snapView:n}=this._elements;this._options.snapView&&(i||s<=100||!o||(clearTimeout(this._frames.snapViewTimeout),this._setSnapViewVisible(!0),w(n,{opacity:"1","pointer-events":"inherit"}),t||(this._frames.snapViewTimeout=setTimeout(()=>this.hideSnapView(),e.SNAP_VIEW_TIMEOUT_MS))))}hideSnapView(){const{snapView:e}=this._elements;w(e,{opacity:"0","pointer-events":"none"}),this._setSnapViewVisible(!1)}refresh(){this._calculateDimensions(),this.resetZoom()}load(e,t){try{this._setImageSources({imageSrc:e,hiResImageSrc:t}),this._loadImages()}catch(i){if(console.error("ImageViewer: Failed to load image",i),this._listeners.onImageError){const e=new ErrorEvent("error",{error:i instanceof Error?i:new Error(String(i)),message:i instanceof Error?i.message:String(i)});this._listeners.onImageError(e)}throw i}}destroy(){try{const{container:e,domElement:t}=this._elements;this._destroySlider("imageSlider"),this._destroySlider("snapSlider"),this._destroySlider("zoomSlider"),this.imageLoader.destroy(),this.interactionManager.destroy(),this.eventManager.destroy(),this._clearFrames(),this.dom.destroy(t,e),t._imageViewer=null,this._listeners.onDestroy&&this._listeners.onDestroy()}catch(e){console.error("ImageViewer: Error during destroy",e)}}};h(Z,"defaults"),h(Z,"FullScreenViewer"),h(Z,"MOMENTUM_SAMPLE_INTERVAL_MS",50),h(Z,"MOMENTUM_ANIMATION_FRAMES",60),h(Z,"MOMENTUM_THRESHOLD_PX",30),h(Z,"MOMENTUM_VELOCITY_FACTOR",1/3),h(Z,"ZOOM_ANIMATION_FRAMES",16),h(Z,"SNAP_VIEW_TIMEOUT_MS",1500);let H=Z;H.defaults={zoomValue:100,snapView:!0,maxZoom:500,refreshOnResize:!0,zoomOnMouseWheel:!0,hasZoomButtons:!1,zoomStep:50,listeners:{onInit:void 0,onDestroy:void 0,onImageLoaded:void 0,onZoomChange:void 0,onImageError:void 0}};const N="iv-fullscreen",C="iv-fullscreen-container",F="iv-fullscreen-close",k=`\n  <div class="${C}"></div>\n  <div class="${F}"></div>\n`;exports.FullScreenViewer=class extends H{constructor(e={}){const t=d({tagName:"div",className:N,html:k,trustedHTML:!0,parent:document.body}),i=t.querySelector(`.${C}`);if(!i)throw new Error("Fullscreen container element not found");super(i,l(r({},e),{refreshOnResize:!1})),h(this,"hide",()=>{const e=this._getElement("fullScreen");e&&w(e,{display:"none"});const t=document.querySelector("html");var i;t&&(i="overflow",t.style.removeProperty(i)),this.eventManager.off("onWindowResize")}),this._setElement("fullScreen",t),this._initFullScreenEvents()}_initFullScreenEvents(){const e=this._getElement("fullScreen");if(!e)throw new Error("Fullscreen element not initialized");const t=e.querySelector(`.${F}`);if(!t)throw new Error("Fullscreen close button not found");this.eventManager.on("onCloseBtnClick",t,"click",this.hide)}show(e,t){const i=this._getElement("fullScreen");i&&w(i,{display:"block"}),e&&this.load(e,t),this.eventManager.on("onWindowResize",window,"resize",()=>this.refresh());const s=document.querySelector("html");s&&w(s,{overflow:"hidden"})}destroy(){const e=this._getElement("fullScreen");super.destroy(),e&&S(e)}},exports.ImageViewer=H,exports.default=H;
//# sourceMappingURL=iv-viewer-ts.js.map
