"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=new Function;function t(e,t,s,i){return e/=i,-s*((e-=1)*e*e*e-1)+t}function s(e){const t=document.createElement(e.tagName);return e.id&&(t.id=e.id),e.html&&(t.innerHTML=e.html),e.className&&(t.className=e.className),e.src&&t instanceof HTMLImageElement&&t.setAttribute("src",e.src),e.style&&(t.style.cssText=e.style),e.child&&t.appendChild(e.child),e.insertBefore?e.parent.insertBefore(t,e.insertBefore):e.parent.appendChild(t),t}function i(e,t){const s=t.split(" ");s.length>1?s.forEach((t=>i(e,t))):e.classList?e.classList.add(t):e.className+=` ${t}`}function n(e,t){const s=t.split(" ");s.length>1?s.forEach((t=>n(e,t))):e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(`(^|\\b)${t.split(" ").join("|")}(\\b|$)`,"gi")," ")}function o(e){return e.complete&&(void 0===e.naturalWidth||0!==e.naturalWidth)}function a(e){return e instanceof HTMLElement?[e]:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e):[]}function r(e,t){const s=a(e);if("string"==typeof t)return window.getComputedStyle(s[0])[t];s.forEach((e=>{Object.keys(t).forEach((s=>{e.style[s]=t[s]}))}))}function l(e,t){e.style.removeProperty(t)}function h(e){a(e).forEach((e=>{e.parentNode&&e.parentNode.removeChild(e)}))}function m(e,t,s){return Math.min(Math.max(e,t),s)}function c(e,t,s){const i=Array.isArray(t)?t:[t];return i.forEach((t=>e.addEventListener(t,s))),()=>{i.forEach((t=>e.removeEventListener(t,s)))}}function d(e){const t=e[0],s=e[1];return Math.sqrt(Math.pow(s.pageX-t.pageX,2)+Math.pow(s.pageY-t.pageY,2))}class u{onStart;onMove;onEnd;isSliderEnabled;container;touchMoveEvent;touchEndEvent;sx;sy;constructor(t,{onStart:s,onMove:i,onEnd:n,isSliderEnabled:o}){this.container=t,this.isSliderEnabled=o,this.onStart=s||e,this.onMove=i||e,this.onEnd=n||e}startHandler=e=>{if(!this.isSliderEnabled())return;this.removeListeners(),e.preventDefault();const{moveHandler:t,endHandler:s,onStart:i}=this;let n,o;if("touchstart"===e.type||"touchend"===e.type){const t=e;this.touchMoveEvent="touchmove",this.touchEndEvent="touchend",n=t.touches[0].clientX,o=t.touches[0].clientY}else{const t=e;this.touchMoveEvent="mousemove",this.touchEndEvent="mouseup",n=t.clientX,o=t.clientY}this.sx=n,this.sy=o,i(e,{x:this.sx,y:this.sy}),document.addEventListener(this.touchMoveEvent,t),document.addEventListener(this.touchEndEvent,s),document.addEventListener("contextmenu",s)};moveHandler=e=>{if(!this.isSliderEnabled())return;e.preventDefault();const{sx:t,sy:s,onMove:i}=this;let n,o;if("touchmove"===this.touchMoveEvent){const t=e;n=t.touches[0].clientX,o=t.touches[0].clientY}else{const t=e;n=t.clientX,o=t.clientY}i(e,{dx:n-t,dy:o-s,mx:n,my:o})};endHandler=()=>{this.isSliderEnabled()&&(this.removeListeners(),this.onEnd())};removeListeners(){this.touchMoveEvent&&document.removeEventListener(this.touchMoveEvent,this.moveHandler),this.touchEndEvent&&document.removeEventListener(this.touchEndEvent,this.endHandler),document.removeEventListener("contextmenu",this.endHandler)}init(){["touchstart","mousedown"].forEach((e=>{this.container.addEventListener(e,this.startHandler)}))}destroy(){["touchstart","mousedown"].forEach((e=>{this.container.removeEventListener(e,this.startHandler)})),this.removeListeners()}}class p{_elements;_options;_listeners;_events;_state;_sliders;_frames;_images;static defaults;static FullScreenViewer;_ev;get zoomInButton(){return this._options.hasZoomButtons?'<div class="iv-button-zoom--in" role="button"></div>':""}get zoomOutButton(){return this._options.hasZoomButtons?'<div class="iv-button-zoom--out" role="button"></div>':""}get imageViewHtml(){return`\n    <div class="iv-loader"></div>\n    <div class="iv-snap-view">\n      <div class="iv-snap-image-wrap">\n        <div class="iv-snap-handle"></div>\n      </div>\n      <div class="iv-zoom-actions ${this._options.hasZoomButtons?"iv-zoom-actions--has-buttons":""}">\n        ${this.zoomInButton}\n        <div class="iv-zoom-slider">\n          <div class="iv-zoom-handle"></div>\n        </div>\n        ${this.zoomOutButton}\n      </div>\n    </div>\n    <div class="iv-image-view" >\n      <div class="iv-image-wrap" ></div>\n    </div>\n  `}constructor(e,t={}){const{container:s,domElement:i,imageSrc:n,hiResImageSrc:o}=this._findContainerAndImageSrc(e);this._elements={container:s,domElement:i},this._options={...p.defaults,...t},this._events={},this._listeners=this._options.listeners||{},this._frames={},this._sliders={},this._state={zoomValue:this._options.zoomValue},this._images={imageSrc:n,hiResImageSrc:o},this._init(),n&&this._loadImages(),i._imageViewer=this}_findContainerAndImageSrc(e){let t,s,i=e;if("string"==typeof e&&(i=document.querySelector(e)),i._imageViewer)throw new Error("An image viewer is already being initiated on the element.");let n=e;return"IMG"===i.tagName?(t=i.src,s=i.getAttribute("high-res-src")||i.getAttribute("data-high-res-src"),n=function(e,{tag:t="div",className:s,id:i,style:n}){const o=document.createElement(t);s&&(o.className=s),i&&(o.id=i),n&&(n.display&&(o.style.display=n.display),n.overflow&&(o.style.overflow=n.overflow));const a=e.parentNode;if(!a)throw new Error("element does not have a parent node");return a.insertBefore(o,e),a.removeChild(e),o.appendChild(e),o}(i,{className:"iv-container iv-image-mode",style:{display:"inline-block",overflow:"hidden"}}),r(i,{opacity:0,position:"relative",zIndex:-1})):(t=i.getAttribute("src")||i.getAttribute("data-src"),s=i.getAttribute("high-res-src")||i.getAttribute("data-high-res-src")),{container:n,domElement:i,imageSrc:t,hiResImageSrc:s}}_init(){this._initDom(),this._initImageSlider(),this._initSnapSlider(),this._initZoomSlider(),this._pinchAndZoom(),this._scrollZoom(),this._doubleTapToZoom(),this._initEvents()}_initDom(){const{container:e}=this._elements;s({tagName:"div",className:"iv-wrap",html:this.imageViewHtml,parent:e}),i(e,"iv-container"),"static"===r(e,"position")&&r(e,{position:"relative"}),this._elements={...this._elements,snapView:e.querySelector(".iv-snap-view"),snapImageWrap:e.querySelector(".iv-snap-image-wrap"),imageWrap:e.querySelector(".iv-image-wrap"),snapHandle:e.querySelector(".iv-snap-handle"),zoomHandle:e.querySelector(".iv-zoom-handle"),zoomIn:e.querySelector(".iv-button-zoom--in"),zoomOut:e.querySelector(".iv-button-zoom--out")},this._listeners.onInit&&this._listeners.onInit(this._callbackData)}_initImageSlider(){const{_elements:e}=this,{imageWrap:s}=e;let i,n;const o=new u(s,{isSliderEnabled:()=>{const{loaded:e,zooming:t,zoomValue:s}=this._state;return e&&!t&&s>100},onStart:(e,t)=>{const{snapSlider:s}=this._sliders;this._clearFrames(),s.onStart(),i=[t,t],n=void 0,this._frames.slideMomentumCheck=setInterval((()=>{n&&(i.shift(),i.push({x:n.mx,y:n.my}))}),50)},onMove:(e,t)=>{const{snapImageDim:s}=this._state,{snapSlider:i}=this._sliders,o=this._getImageCurrentDim();n=t,i.onMove(e,{dx:-t.dx*s.w/o.w,dy:-t.dy*s.h/o.h})},onEnd:()=>{const{snapImageDim:e}=this._state,{snapSlider:s}=this._sliders,o=this._getImageCurrentDim();let a,r,l;this._clearFrames();const h=i[1].x-i[0].x,m=i[1].y-i[0].y,c=()=>{a<=60&&(this._frames.sliderMomentumFrame=requestAnimationFrame(c)),r+=t(a,h/3,-h/3,60),l+=t(a,m/3,-m/3,60),s.onMove(null,{dx:-r*e.w/o.w,dy:-l*e.h/o.h}),a++};(Math.abs(h)>30||Math.abs(m)>30)&&(a=1,r=n.dx,l=n.dy,c())}});o.init(),this._sliders.imageSlider=o}_initSnapSlider(){const{snapHandle:e}=this._elements;let t,s;const i=new u(e,{isSliderEnabled:()=>this._state.loaded,onStart:()=>{const{slideMomentumCheck:i,sliderMomentumFrame:n}=this._frames;t=parseFloat(r(e,"top")),s=parseFloat(r(e,"left")),clearInterval(i),"number"==typeof n&&cancelAnimationFrame(n)},onMove:(i,n)=>{const{snapHandleDim:o,snapImageDim:a}=this._state,{image:l}=this._elements,h=this._getImageCurrentDim();if(!o)return;const c=Math.max(a.w-o.w,s),d=Math.max(a.h-o.h,t),u=Math.min(0,s),p=Math.min(0,t),v=m(s+n.dx,u,c),_=m(t+n.dy,p,d),g=-v*h.w/a.w,w=-_*h.h/a.h;r(e,{left:`${v}px`,top:`${_}px`}),r(l,{left:`${g}px`,top:`${w}px`})}});i.init(),this._sliders.snapSlider=i}_initZoomSlider(){const{snapView:e,zoomHandle:t}=this._elements,s=e.querySelector(".iv-zoom-slider");let i,n;const o=new u(s,{isSliderEnabled:()=>this._state.loaded,onStart:e=>{const{zoomSlider:o}=this._sliders;i=s.getBoundingClientRect().left+document.body.scrollLeft,n=parseInt(r(t,"width"),10),o.onMove(e)},onMove:e=>{const{maxZoom:t}=this._options,{zoomSliderLength:s}=this._state,o=void 0!==e.pageX?e.pageX:e.touches[0].pageX;if(!s)return;const a=100+(t-100)*m(o-i-n/2,0,s)/s;this.zoom(a)}});o.init(),this._sliders.zoomSlider=o}_initEvents(){this._snapViewEvents(),this._options.refreshOnResize&&(this._events.onWindowResize=c(window,"resize",this.refresh))}_snapViewEvents(){const{imageWrap:e,snapView:t}=this._elements;if(this._events.snapViewOnMouseMove=c(e,["touchmove","mousemove"],(()=>{this.showSnapView()})),this._events.mouseEnterSnapView=c(t,["mouseenter","touchstart"],(()=>{this._state.snapViewVisible=!1,this.showSnapView(!0)})),this._events.mouseLeaveSnapView=c(t,["mouseleave","touchend"],(()=>{this._state.snapViewVisible=!1,this.showSnapView()})),!this._options.hasZoomButtons)return;const{zoomOut:s,zoomIn:i}=this._elements;this._events.zoomInClick=c(i,["click"],(()=>{this.zoom(this._state.zoomValue+(this._options.zoomStep||50))})),this._events.zoomOutClick=c(s,["click"],(()=>{this.zoom(this._state.zoomValue-(this._options.zoomStep||50))}))}_pinchAndZoom(){const{imageWrap:e,container:t}=this._elements;this._events.pinchStart=c(e,"touchstart",(e=>{const{loaded:s,zoomValue:i}=this._state,{_events:n}=this;if(!s)return;const o=e.touches[0],a=e.touches[1];if(!o||!a)return;this._state.zooming=!0;const r=t.getBoundingClientRect(),l=d(e.touches),h={x:(a.pageX+o.pageX)/2-(r.left+document.body.scrollLeft),y:(a.pageY+o.pageY)/2-(r.top+document.body.scrollTop)};n.pinchMove&&n.pinchMove(),n.pinchEnd&&n.pinchEnd(),n.pinchMove=c(document,"touchmove",(e=>{const t=d(e.touches),s=i+(t-l)/2;this.zoom(s,h)})),n.pinchEnd=c(document,"touchend",(e=>{n.pinchMove&&n.pinchMove(),n.pinchEnd&&n.pinchEnd(),this._state.zooming=!1,1===e.touches.length&&this._sliders.imageSlider.startHandler(e)}))}))}_scrollZoom(){const{_options:e}=this,{container:t,imageWrap:s}=this._elements;let i=0;this._ev=c(s,"wheel",(s=>{const{loaded:n,zoomValue:o}=this._state;if(!e.zoomOnMouseWheel||!n)return;this._clearFrames();const a=Math.max(-1,Math.min(1,s.wheelDelta||-s.detail||-s.deltaY)),r=o*(100+15*a)/100;if(r>=100&&r<=e.maxZoom?i=0:i+=Math.abs(a),s.preventDefault(),i>5)return;const l=t.getBoundingClientRect(),h=(s.pageX||s.pageX)-(l.left+document.body.scrollLeft),m=(s.pageY||s.pageY)-(l.top+document.body.scrollTop);this.zoom(r,{x:h,y:m}),this.showSnapView()}))}_doubleTapToZoom(){const{imageWrap:e}=this._elements;let t,s=0;c(e,"click",(e=>{0===s?(s=Date.now(),t={x:e.pageX,y:e.pageY}):Date.now()-s<500&&Math.abs(e.pageX-t.x)<50&&Math.abs(e.pageY-t.y)<50?(this._state.zoomValue===this._options.zoomValue?this.zoom(200):this.resetZoom(),s=0):s=0}))}_getImageCurrentDim(){const{zoomValue:e,imageDim:t}=this._state;return{w:t.w*(e/100),h:t.h*(e/100)}}_loadImages(){const{_images:e,_elements:t}=this,{imageSrc:i,hiResImageSrc:n}=e,{container:a,snapImageWrap:l,imageWrap:m}=t,d=a.querySelector(".iv-loader");h(a.querySelectorAll(".iv-snap-image, .iv-image"));const u=s({tagName:"img",className:"iv-snap-image",src:i,insertBefore:l.firstChild,parent:l}),p=s({tagName:"img",className:"iv-image iv-small-image",src:i,parent:m});this._state.loaded=!1,this._elements.image=p,this._elements.snapImage=u,r(d,{display:"block"}),r(p,{visibility:"hidden"}),this.hideSnapView();const v=()=>{r(d,{display:"none"}),r(p,{visibility:"visible"}),n&&this._loadHighResImage(n),this._state.loaded=!0,this._calculateDimensions(),this._listeners.onImageLoad&&this._listeners.onImageLoaded(this._callbackData),this.resetZoom()};o(p)?v():this._events.imageLoad=c(p,"load",v)}_loadHighResImage(e){const{imageWrap:t,container:i}=this._elements,n=this._elements.image,a=s({tagName:"img",className:"iv-image iv-large-image",src:e,parent:t,style:n.style.cssText});a.style.cssText=n.style.cssText,this._elements.image=i.querySelectorAll(".iv-image");const r=()=>{h(n),this._elements.image=a};o(a)?r():this._events.hiResImageLoad=c(a,"load",r)}_calculateDimensions(){const{image:e,container:t,snapView:s,snapImage:i,zoomHandle:n}=this._elements,o=parseInt(r(e,"width"),10),a=parseInt(r(e,"height"),10),l=parseInt(r(t,"width"),10),h=parseInt(r(t,"height"),10),m=s.clientWidth,c=s.clientHeight;this._state.containerDim={w:l,h:h};const d=o/a,u=o>a&&h>=l||d*h>l?l:d*h,p=u/d;this._state.imageDim={w:u,h:p},r(e,{width:`${u}px`,height:`${p}px`,left:(l-u)/2+"px",top:(h-p)/2+"px",maxWidth:"none",maxHeight:"none"});const v=u>p?m:u*c/p,_=p>u?c:p*m/u;this._state.snapImageDim={w:v,h:_},r(i,{width:`${v}px`,height:`${_}px`});const g=s.querySelector(".iv-zoom-slider").clientWidth;this._state.zoomSliderLength=g-n.offsetWidth}resetZoom(e=!0){const{zoomValue:t}=this._options;e||(this._state.zoomValue=t),this.zoom(t)}zoom=(e,s)=>{const{_options:i,_elements:n,_state:o}=this,{zoomValue:a,imageDim:l,containerDim:h,zoomSliderLength:m}=o,{image:c,zoomHandle:d}=n,{maxZoom:u}=i;e=Math.round(Math.max(100,e)),e=Math.min(u,e),s=s||{x:h.w/2,y:h.h/2};const p=parseFloat(r(c,"left")),v=parseFloat(r(c,"top"));this._clearFrames();let _=0;const g=(h.w-l.w)/2,w=(h.h-l.h)/2,f=h.w-g,y=h.h-w,S=()=>{_++,_<16&&(this._frames.zoomFrame=requestAnimationFrame(S));const i=t(_,a,e-a,16),n=i/a,o=l.w*i/100,h=l.h*i/100;let z=-((s.x-p)*n-s.x),E=-((s.y-v)*n-s.y);z=Math.min(z,g),E=Math.min(E,w),z+o<f&&(z=f-o),E+h<y&&(E=y-h),r(c,{height:`${h}px`,width:`${o}px`,left:`${z}px`,top:`${E}px`}),this._state.zoomValue=i,this._resizeSnapHandle(o,h,z,E),r(d,{left:(i-100)*(m||0)/(u-100)+"px"}),this._listeners.onZoomChange&&this._listeners.onZoomChange(this._callbackData)};S()};_clearFrames=()=>{const{slideMomentumCheck:e,sliderMomentumFrame:t,zoomFrame:s}=this._frames;clearInterval(e),"number"==typeof t&&cancelAnimationFrame(t),"number"==typeof s&&cancelAnimationFrame(s)};_resizeSnapHandle=(e,t,s,i)=>{const{_elements:n,_state:o}=this,{snapHandle:a,image:l}=n,{imageDim:h,containerDim:m,zoomValue:c,snapImageDim:d}=o,u=e||h.w*c/100,p=t||h.h*c/100,v=s||parseFloat(r(l,"left")),_=i||parseFloat(r(l,"top")),g=-v*d.w/u,w=-_*d.h/p,f=m.w*d.w/u,y=m.h*d.h/p;r(a,{top:`${w}px`,left:`${g}px`,width:`${f}px`,height:`${y}px`}),this._state.snapHandleDim={w:f,h:y}};showSnapView=e=>{const{snapViewVisible:t,zoomValue:s,loaded:i}=this._state,{snapView:n}=this._elements;this._options.snapView&&(t||s<=100||!i||(clearTimeout(this._frames.snapViewTimeout),this._state.snapViewVisible=!0,r(n,{opacity:1,pointerEvents:"inherit"}),e||(this._frames.snapViewTimeout=setTimeout(this.hideSnapView,1500))))};hideSnapView=()=>{const{snapView:e}=this._elements;r(e,{opacity:0,pointerEvents:"none"}),this._state.snapViewVisible=!1};refresh=()=>{this._calculateDimensions(),this.resetZoom()};load(e,t){this._images={imageSrc:e,hiResImageSrc:t},this._loadImages()}destroy(){const{container:e,domElement:t}=this._elements;Object.entries(this._sliders).forEach((([,e])=>{e.destroy()})),Object.entries(this._events).forEach((([,e])=>{e()})),this._clearFrames(),h(e.querySelector(".iv-wrap")),n(e,"iv-container"),l(document.querySelector("html"),"relative"),t!==e&&function(e){const t=e.parentNode;t&&t!==document.body&&(t.parentNode?.insertBefore(e,t),t.parentNode?.removeChild(t))}(t),t._imageViewer=null,this._listeners.onDestroy&&this._listeners.onDestroy()}get _callbackData(){return{container:this._elements.container,snapView:this._elements.snapView,zoomValue:this._state.zoomValue,reachedMin:Math.round(this._state.zoomValue)===this._options.zoomValue,reachedMax:Math.round(this._state.zoomValue)===this._options.maxZoom,instance:this}}}p.defaults={zoomValue:100,snapView:!0,maxZoom:500,refreshOnResize:!0,zoomOnMouseWheel:!0,hasZoomButtons:!1,zoomStep:50,listeners:{onInit:null,onDestroy:null,onImageLoaded:null,onZoomChange:null}};exports.FullScreenViewer=class extends p{constructor(e={}){const t=s({tagName:"div",className:"iv-fullscreen",html:'\n  <div class="iv-fullscreen-container"></div>\n  <div class="iv-fullscreen-close"></div>\n',parent:document.body});super(t.querySelector(".iv-fullscreen-container"),{...e,refreshOnResize:!1}),this._elements.fullScreen=t,this._initFullScreenEvents()}_initFullScreenEvents(){const{fullScreen:e}=this._elements,t=e.querySelector(".iv-fullscreen-close");this._events.onCloseBtnClick=c(t,"click",this.hide)}show(e,t){r(this._elements.fullScreen,{display:"block"}),e&&this.load(e,t),this._events.onWindowResize=c(window,"resize",this.refresh),r(document.querySelector("html"),{overflow:"hidden"})}hide=()=>{r(this._elements.fullScreen,{display:"none"}),l(document.querySelector("html"),"overflow"),this._events.onWindowResize&&this._events.onWindowResize()};destroy(){const{fullScreen:e}=this._elements;super.destroy(),h(e)}},exports.ImageViewer=p,exports.default=p;
//# sourceMappingURL=iv-viewer-ts.js.map
